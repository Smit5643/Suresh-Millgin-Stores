<!DOCTYPE html><!-- v20260228_070906 NOCACHE -->
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<meta name="theme-color" content="#0f0f0f"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="SMS Stores"/>
<meta name="description" content="Suresh Millgin Stores ‚Äî Product Catalog &amp; Admin Panel"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<link rel="manifest" href="/manifest.json"/>
<script>
// ‚ïê‚ïê EMBEDDED SERVICE WORKER ‚Äî full offline cache ‚ïê‚ïê
(function(){
  if(!('serviceWorker' in navigator))return;
  const _host=location.hostname;
  if(_host.includes('claudeusercontent')||_host===''||_host==='localhost')return;

  // SW code as safe array joined ‚Äî no backtick nesting issues
  const CV='sms-v20260228_055520';
  const sw=[
    "const CACHE='"+CV+"',CACHE_API='"+CV+"-api',CACHE_IMG='"+CV+"-img';",
    "self.addEventListener('install',e=>{",
    "  e.waitUntil(caches.open(CACHE).then(c=>Promise.allSettled([c.add('/'),c.add('/SureshMillginStores.html')])).then(()=>self.skipWaiting()));",
    "});",
    "self.addEventListener('activate',e=>{",
    "  e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE&&k!==CACHE_API&&k!==CACHE_IMG).map(k=>caches.delete(k)))).then(()=>self.clients.claim()));",
    "});",
    "self.addEventListener('fetch',e=>{",
    "  const req=e.request,url=new URL(req.url);",
    "  if(url.hostname.includes('supabase')){",
    "    e.respondWith(fetch(req).then(res=>{",
    "      if(res.ok&&req.method==='GET'){const cl=res.clone();caches.open(CACHE_API).then(c=>c.put(req,cl)).catch(()=>{});}",
    "      return res;",
    "    }).catch(()=>caches.match(req).then(r=>r||new Response('[]',{headers:{'Content-Type':'application/json'}}))));",
    "    return;",
    "  }",
    "  if(req.destination==='image'){",
    "    e.respondWith(caches.match(req).then(cached=>{",
    "      if(cached)return cached;",
    "      return fetch(req).then(res=>{if(res.ok){const cl=res.clone();caches.open(CACHE_IMG).then(c=>c.put(req,cl)).catch(()=>{});}return res;}).catch(()=>new Response('',{status:404}));",
    "    }));",
    "    return;",
    "  }",
    "  e.respondWith(caches.match(req).then(cached=>{",
    "    if(cached){fetch(req).then(res=>{if(res.ok)caches.open(CACHE).then(c=>c.put(req,res)).catch(()=>{});}).catch(()=>{});return cached;}",
    "    return fetch(req).then(res=>{if(res.ok&&req.method==='GET'){const cl=res.clone();caches.open(CACHE).then(c=>c.put(req,cl)).catch(()=>{});}return res;});",
    "  }));",
    "});",
    "self.addEventListener('message',e=>{if(e.data&&e.data.type==='SKIP_WAITING')self.skipWaiting();});",
  ].join('\n');

  const blob=new Blob([sw],{type:'application/javascript'});
  const swUrl=URL.createObjectURL(blob);
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register(swUrl,{scope:'/'}).then(reg=>{
      if(reg.waiting)reg.waiting.postMessage({type:'SKIP_WAITING'});
      reg.addEventListener('updatefound',()=>{
        const nw=reg.installing;
        if(nw)nw.addEventListener('statechange',()=>{
          if(nw.state==='installed'&&navigator.serviceWorker.controller){
            nw.postMessage({type:'SKIP_WAITING'});
            navigator.serviceWorker.addEventListener('controllerchange',()=>location.reload());
          }
        });
      });
    }).catch(()=>navigator.serviceWorker.register('/sw.js').catch(()=>{}));
  });
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<link rel="apple-touch-icon" href="/icon-192.png"/>
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png"/>
<link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png"/>
<title>Suresh Millgin Stores</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;touch-action:manipulation;-webkit-touch-callout:none}
/* ‚ïê‚ïê‚ïê 90 FPS GPU COMPOSITING ‚ïê‚ïê‚ïê */
/* Force hardware layers on all scrollable areas */
.page{contain:layout style;transform:translateZ(0)}
.chat-wrap,.adm-body{contain:layout style;will-change:transform;transform:translateZ(0)}
.msg-list,.chat-msgs,.adm-msgs{
  -webkit-overflow-scrolling:touch;
  transform:translateZ(0);
  backface-visibility:hidden;
  scroll-behavior:auto;
}
/* Message bubbles on their own GPU layer */
.cb,.vn,.cm,.msg-row{
  transform:translateZ(0);
  backface-visibility:hidden;
  contain:layout style;
}
/* Waveform bars ‚Äî own layer for rAF animation */
.rw-bar,.vn-bar{will-change:height;transform:translateZ(0)}
/* Bottom nav and inputs */
.btn,.inp,.at,.bn,.bnav,.chat-bar,.adm-reply-wrap{transform:translateZ(0);backface-visibility:hidden}
/* Rec bar */
.rec-bar,.rec-ok,.rec-cancel{transform:translateZ(0)}
/* Animations: translateZ keeps on GPU */
.fade-in{animation:fadeIn .08s ease both}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.slide-up{animation:slideUp .07s ease both}
@keyframes slideUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
/* Remove paint cost from cards */
.form-card,.irow,.user-card{contain:layout}
:root{
  --c:#0f0f0f;--c2:#161616;--c3:#1e1e1e;--c4:#272727;
  --g:#D4AF37;--gl:rgba(212,175,55,.13);--gb:rgba(212,175,55,.3);
  --s:#b0b0b0;--sb:rgba(176,176,176,.18);
  --t1:#ede8d8;--t2:#888070;
  --glass:rgba(255,255,255,.03);--glb:rgba(255,255,255,.07);
  --danger:#b03030;--ok:#1e7a46;
  --rad:10px;--rsm:6px;
  --sfb:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;height:100dvh;width:100%;background:#0f0f0f;color:#ede8d8;font-family:Georgia,serif;overflow:hidden;touch-action:manipulation}
body{-webkit-text-size-adjust:100%;text-size-adjust:100%}
#root{height:100%;width:100%;max-width:480px;margin:0 auto;position:relative;overflow:hidden;display:flex;flex-direction:column;will-change:contents}
::-webkit-scrollbar{display:none}
.page{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;contain:layout style;transform:translateZ(0)}
/* TYPOGRAPHY */
.bebas{font-family:'Georgia',serif;font-weight:900;letter-spacing:3px;text-transform:uppercase}
.cormo{font-family:Georgia,serif;font-style:italic}
/* ANIMATIONS */
/* fadeIn: defined above with translate3d GPU version */
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes pulseFade{0%,100%{opacity:.35}50%{opacity:.85}}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
@keyframes shimmer{from{left:-100%}to{left:100%}}
@keyframes pulseDot{0%,100%{box-shadow:0 0 0 0 rgba(176,48,48,.5)}50%{box-shadow:0 0 0 8px rgba(176,48,48,0)}}
/* .fade-in defined above as .1s ease both */
.slide-in{animation:slideIn .25s ease}
/* LOADER */
/* Prevent blink on DOM rebuild */
#root > *:not(.toast-wrap){animation:none !important}
.loader-wrap{position:fixed;inset:0;z-index:9999;background:var(--c);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px}
.loader-brand{font-size:28px;font-weight:900;color:var(--g);letter-spacing:6px;text-transform:uppercase}
.loader-bar{width:140px;height:2px;background:var(--c4);overflow:hidden;border-radius:1px;position:relative}
.loader-bar::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:var(--g);animation:shimmer 1s linear infinite}
.loader-sub{font-size:9px;color:var(--t2);letter-spacing:3px;text-transform:uppercase;animation:pulse 1.3s ease-in-out infinite}
/* TOAST */
.toast-wrap{position:fixed;top:64px;left:50%;transform:translateX(-50%);z-index:9998;background:var(--c2);border:1px solid var(--gb);padding:10px 18px;font-size:12px;color:var(--g);border-radius:var(--rsm);white-space:nowrap;box-shadow:0 8px 22px rgba(0,0,0,.6);animation:fadeIn .2s ease;max-width:88vw;font-weight:600;letter-spacing:1px}
/* BUTTONS */
.btn{width:100%;padding:14px;border:none;cursor:pointer;font-weight:700;font-size:12px;letter-spacing:3px;text-transform:uppercase;border-radius:var(--rsm);transition:transform .06s;font-family:Georgia,serif;touch-action:manipulation;will-change:transform;-webkit-tap-highlight-color:transparent;user-select:none}
.btn-g{background:#D4AF37;color:#0f0f0f;font-weight:900;opacity:1!important;box-shadow:0 2px 10px rgba(212,175,55,.35);border:none}
.btn-g:hover{background:#c9a430;box-shadow:0 4px 14px rgba(212,175,55,.5)}
.btn-g:active{transform:scale(.97);background:#b8960c}.btn-g:disabled{opacity:.4!important;cursor:not-allowed;transform:none;box-shadow:none}
.btn-ol{background:transparent;color:var(--s);border:1.5px solid var(--sb);margin-top:10px}
.btn-ol:active{border-color:var(--gb);color:var(--g)}
.btn-danger{background:var(--danger);color:#fff;border:none;margin-top:0}
.btn-sm{width:auto;padding:7px 14px;font-size:10px;letter-spacing:1.5px}
/* INPUTS */
.ig{margin-bottom:13px}
.il{display:block;font-size:9px;letter-spacing:3px;color:var(--g);text-transform:uppercase;margin-bottom:5px;font-weight:700}
.inp{width:100%;background:rgba(0,0,0,.5);border:1px solid var(--glb);color:var(--t1);font-family:Georgia,serif;font-size:14px;padding:12px 14px;outline:none;border-radius:var(--rsm);transition:border-color .08s;-webkit-appearance:none;display:block}
.inp:focus{border-color:var(--gb);outline:none}.inp::placeholder{color:var(--t2)}
.inp{-webkit-user-select:text;user-select:text}
.inp-wrap{position:relative}.inp-wrap .inp{padding-right:44px}
.inp-eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--t2);cursor:pointer;font-size:16px;padding:4px}
.ta{width:100%;background:rgba(0,0,0,.4);border:1px solid var(--glb);color:var(--t1);font-family:Georgia,serif;font-size:14px;padding:12px 14px;outline:none;resize:none;min-height:80px;border-radius:var(--rsm)}
.ta:focus{border-color:var(--gb)}
.sel{width:100%;background:rgba(0,0,0,.5);border:1px solid var(--glb);color:var(--t1);font-family:Georgia,serif;font-size:14px;padding:12px 14px;outline:none;border-radius:var(--rsm);-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='%23888070'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
/* ERRORS */
.err{color:#ff6b6b;font-size:13px;font-weight:600;padding:12px 14px;background:rgba(224,85,85,.14);border:1px solid rgba(224,85,85,.5);border-radius:var(--rsm);margin-bottom:14px;text-align:center;line-height:1.6;animation:fadeIn .2s ease}
.ok-msg{color:#3ecf7a;font-size:11px;padding:10px 13px;background:rgba(62,207,122,.08);border:1px solid rgba(62,207,122,.22);border-radius:var(--rsm);margin-bottom:12px;text-align:center}
/* HEADER */
.hdr{background:rgba(15,15,15,.96);border-bottom:1px solid var(--glb);padding:0 16px;height:54px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:100}
.hdr-title{font-size:16px;font-weight:900;color:var(--g);letter-spacing:4px;text-transform:uppercase}
.hdr-back{background:none;border:none;color:var(--g);font-size:22px;cursor:pointer;padding:4px 8px 4px 0;line-height:1}
/* BOTTOM NAV */
.bnav{background:rgba(15,15,15,.97);border-top:1px solid var(--glb);display:flex;padding-bottom:var(--sfb);flex-shrink:0;position:sticky;bottom:0;z-index:100}
.bn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:9px 2px;cursor:pointer;gap:2px;position:relative;transition:all .15s}
.bn-i{font-size:19px;transition:transform .2s}.bn-l{font-size:8px;letter-spacing:1px;text-transform:uppercase;color:var(--t2);font-weight:700}
.bn.on .bn-l{color:var(--g)}.bn.on .bn-i{transform:scale(1.1)}
.bn-badge{position:absolute;top:5px;right:calc(50% - 18px);background:var(--danger);color:#fff;font-size:7px;font-weight:700;width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center}
/* CARD */
.gc{background:rgba(255,255,255,.03);border:1px solid var(--glb);border-radius:var(--rad);position:relative}
/* SPLASH */
.splash-wrap{width:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:22px 18px;overflow-y:auto;background:var(--c)}
.brand-big{font-size:clamp(26px,8vw,38px);font-weight:900;color:var(--g);letter-spacing:4px;text-transform:uppercase;text-align:center;line-height:1.15;word-break:keep-all;width:100%}
.brand-sub{font-size:10px;color:var(--s);letter-spacing:2px;text-align:center;margin-top:6px;font-style:italic;white-space:normal;overflow:visible;width:100%;word-break:break-word}
.gold-line{width:55px;height:1px;background:linear-gradient(90deg,transparent,var(--g),transparent);margin:14px auto}
.policy-box{font-size:11px;line-height:1.9;color:var(--t2);height:230px;overflow-y:auto;padding:14px;border:1px solid var(--glb);border-radius:var(--rsm);margin:14px 0;background:rgba(0,0,0,.3)}
.policy-box h4{color:var(--s);font-size:9px;letter-spacing:2px;margin:12px 0 4px;text-transform:uppercase}
/* STAY CHECKBOX */
.stay-row{display:flex;align-items:center;gap:10px;cursor:pointer;padding:6px 0;margin-bottom:14px;user-select:none;-webkit-user-select:none}
.stay-box{width:20px;height:20px;border-radius:5px;flex-shrink:0;border:2px solid var(--glb);display:flex;align-items:center;justify-content:center;font-size:12px;color:#0f0f0f;transition:all .18s}
.stay-box.on{background:var(--g);border-color:var(--g)}
.stay-label{font-size:12px;color:var(--t2);font-weight:500}
.stay-label.on{color:var(--t1);font-weight:600}
/* CATEGORY CARDS */
.cat-row{display:flex;gap:10px;overflow-x:auto;padding:4px 16px 14px;scrollbar-width:none}
.cat-card{flex-shrink:0;width:90px;cursor:pointer;border-radius:var(--rsm);overflow:hidden;border:1.5px solid var(--glb);transition:all .2s;background:var(--c3)}
.cat-card.on{border-color:var(--g)}.cat-card:active{transform:scale(.96)}
.cat-ph{width:100%;height:72px;display:flex;align-items:center;justify-content:center;font-size:26px;background:var(--c3)}
.cat-ph img{width:100%;height:100%;object-fit:cover;display:block}
.cat-lbl{padding:5px 6px 7px;background:var(--c2);text-align:center}
.cat-lbl-name{font-size:10px;font-weight:700;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cat-lbl-ct{font-size:8px;color:var(--t2);margin-top:1px}
/* SUB CHIPS */
.sub-row{display:flex;gap:7px;overflow-x:auto;padding:3px 16px 10px;scrollbar-width:none}
.sub-chip{flex-shrink:0;padding:5px 12px;background:var(--glass);border:1px solid var(--glb);border-radius:15px;font-size:10px;font-weight:700;color:var(--t2);cursor:pointer;transition:all .2s;white-space:nowrap}
.sub-chip.on{background:var(--gl);border-color:var(--gb);color:var(--g)}
/* PRODUCT LIST */
.prod-list{display:flex;flex-direction:column}
.prod-row{background:var(--c);display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--glb)}
.prod-row:active{background:var(--c3)}
.pthumb{width:60px;height:60px;border-radius:var(--rsm);overflow:hidden;flex-shrink:0;background:var(--c3);border:1px solid var(--glb);display:flex;align-items:center;justify-content:center;font-size:24px}
.pthumb img{width:100%;height:100%;object-fit:cover;display:block}
.pbody{flex:1;min-width:0}
.pcat{font-size:8px;color:var(--g);letter-spacing:2px;text-transform:uppercase;margin-bottom:2px}
.pname{font-size:15px;color:var(--t1);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pprice{font-size:12px;font-weight:700;color:var(--g);margin-top:3px}
/* PRODUCT DETAIL */
.pd-wrap{position:absolute;inset:0;z-index:200;background:var(--c);display:flex;flex-direction:column;animation:slideIn .25s ease}
.pd-scr{flex:1;overflow-y:auto}
.crl{position:relative;background:var(--c3)}
.crl-main{width:100%;height:250px;overflow:hidden;background:var(--c3)}
.crl-main img{width:100%;height:100%;object-fit:contain}
.crl-dots{display:flex;justify-content:center;gap:5px;padding:8px;position:absolute;bottom:0;left:0;right:0}
.cdot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.3);transition:all .2s}
.cdot.on{background:var(--g);width:16px;border-radius:3px}
.crl-thumbs{display:flex;gap:6px;overflow-x:auto;padding:8px 14px;background:var(--c2);border-bottom:1px solid var(--glb)}
.crl-tb{flex-shrink:0;width:46px;height:46px;border-radius:5px;overflow:hidden;border:2px solid var(--glb);cursor:pointer;transition:border-color .2s;background:var(--c3)}
.crl-tb.on{border-color:var(--g)}.crl-tb img{width:100%;height:100%;object-fit:cover}
.pd-info{padding:16px}
.pd-cat{font-size:9px;color:var(--g);letter-spacing:3px;text-transform:uppercase;margin-bottom:5px}
.pd-name{font-size:24px;font-weight:700;color:var(--t1);margin-bottom:8px;line-height:1.2}
.pd-price{font-size:26px;font-weight:900;color:var(--g);letter-spacing:3px;margin-bottom:14px}
.pd-hr{height:1px;background:var(--glb);margin-bottom:14px}
.pd-desc{font-size:13px;line-height:1.8;color:var(--t2)}
.pd-acts{position:sticky;bottom:0;background:rgba(15,15,15,.97);border-top:1px solid var(--glb);padding:12px 16px;padding-bottom:calc(12px + var(--sfb));display:flex;gap:10px}
/* SEARCH */
.srch-wrap{padding:10px 16px}
.srch-in{position:relative}
.srch-in::before{content:'üîç';position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:13px;pointer-events:none}
.srch-inp{width:100%;background:var(--c3);border:1px solid var(--glb);color:var(--t1);font-family:Georgia,serif;font-size:14px;padding:11px 14px 11px 36px;outline:none;border-radius:18px;transition:border-color .2s}
.srch-inp:focus{border-color:var(--gb)}.srch-inp::placeholder{color:var(--t2)}
/* CHAT */
.chat-msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:11px}
.cm{display:flex;flex-direction:column}
.cm.u{align-items:flex-end}.cm.a{align-items:flex-start}
.cb{max-width:82%;padding:10px 13px;font-size:13px;line-height:1.6;border-radius:11px}
.cb.u{background:var(--gl);border:1px solid var(--gb);border-radius:11px 11px 3px 11px}
.cb.a{background:var(--c3);border:1px solid var(--glb);border-radius:11px 11px 11px 3px}
.cts{font-size:9px;color:var(--t2);margin-top:3px}
/* VOICE NOTE BUBBLE */
.vn{display:flex;align-items:center;gap:10px;padding:10px 13px;border-radius:11px;min-width:180px;max-width:260px}
.vn.u{background:var(--gl);border:1px solid var(--gb);border-radius:11px 11px 3px 11px}
.vn.a{background:var(--c3);border:1px solid var(--glb);border-radius:11px 11px 11px 3px}
.vn-btn{width:34px;height:34px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.vn.u .vn-btn{background:rgba(212,175,55,.3);color:var(--g)}
.vn.a .vn-btn{background:rgba(255,255,255,.1);color:var(--t1)}
.vn-waves{flex:1;display:flex;align-items:center;gap:2px;height:28px}
.vn-bar{width:3px;border-radius:2px;flex-shrink:0;transition:background .1s}
.vn.u .vn-bar{background:rgba(212,175,55,.3)}.vn.u .vn-bar.p{background:var(--g)}
.vn.a .vn-bar{background:rgba(255,255,255,.15)}.vn.a .vn-bar.p{background:var(--s)}
.vn-dur{font-size:10px;font-weight:700;flex-shrink:0;min-width:32px;text-align:right}
.vn.u .vn-dur{color:var(--g)}.vn.a .vn-dur{color:var(--t2)}
/* CHAT BAR */
.chat-bar{background:rgba(15,15,15,.97);border-top:1px solid var(--glb);padding:8px 10px;padding-bottom:calc(8px + var(--sfb));display:flex;gap:7px;align-items:flex-end;flex-shrink:0;position:sticky;bottom:0}
.chat-inp{flex:1;background:var(--c3);border:1px solid var(--glb);color:var(--t1);font-family:Georgia,serif;font-size:14px;padding:10px 13px;outline:none;border-radius:18px;resize:none;max-height:90px;transition:border-color .2s}
.chat-inp:focus{border-color:var(--gb)}
.chat-btn{width:38px;height:38px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;transition:all .18s}
.chat-send{background:var(--g)}.chat-mic{background:var(--c4);border:1.5px solid var(--glb)}
.chat-mic.rec{background:var(--danger);border-color:var(--danger);animation:pulseDot .8s ease-in-out infinite}
/* REC BAR */
.rec-bar{background:rgba(15,15,15,.97);border-top:1px solid var(--danger);padding:10px 16px;padding-bottom:calc(10px + var(--sfb));display:flex;align-items:center;gap:12px;flex-shrink:0}
.rec-dot{width:10px;height:10px;border-radius:50%;background:var(--danger);animation:pulseDot .8s ease-in-out infinite;flex-shrink:0}
.rec-time{font-size:20px;font-weight:900;color:var(--danger);letter-spacing:2px;width:52px;font-family:Georgia,serif}
.rec-waves{flex:1;display:flex;align-items:center;gap:2px;height:28px;overflow:hidden}
.rw-bar{flex:1;background:var(--danger);border-radius:1px;min-height:3px;opacity:.7}
.rec-cancel{background:rgba(255,255,255,.06);border:1px solid var(--glb);color:var(--t2);width:38px;height:38px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:700}
.rec-ok{width:44px;height:44px;background:var(--g);border:none;border-radius:50%;cursor:pointer;font-size:20px;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#0f0f0f;font-weight:900;line-height:1}
/* CHAT LOCKED */
.chat-locked{margin:14px;padding:14px;border:1px solid var(--gb);background:var(--gl);border-radius:var(--rad);text-align:center}
/* SECTION HEADERS */
.sec-hd{padding:14px 16px 8px;display:flex;align-items:center;justify-content:space-between}
.sec-title{font-size:10px;color:var(--g);letter-spacing:3px;text-transform:uppercase;font-weight:700}
/* NOTIF */
.notif-item{padding:14px 16px;border-bottom:1px solid var(--glb);display:flex;gap:10px;cursor:pointer}
.n-dot{width:7px;height:7px;border-radius:50%;background:var(--g);flex-shrink:0;margin-top:5px}
.n-dot.r{background:var(--t2)}
.n-title{font-size:13px;font-weight:700;color:var(--t1);margin-bottom:3px}
.n-msg{font-size:12px;color:var(--t2);line-height:1.6}
.n-time{font-size:9px;color:var(--t2);margin-top:3px}
/* PROFILE */
.prof-av{width:54px;height:54px;background:var(--gl);border:2px solid var(--gb);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;margin-bottom:10px}
.prof-row{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--glb);cursor:pointer}
.prof-row:active{background:var(--c3)}
/* ADMIN TABS */
.adm-tabs{display:flex;overflow-x:auto;border-bottom:1px solid var(--glb);background:var(--c2);scrollbar-width:none;flex-shrink:0}
.at{flex-shrink:0;padding:12px 11px;font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t2);border-bottom:2.5px solid transparent;cursor:pointer;font-weight:700;white-space:nowrap;transition:all .15s}
.at.on{color:var(--g);border-bottom-color:var(--g)}
/* STATS */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px}
.stat-box{background:var(--c3);border:1px solid var(--glb);border-radius:var(--rsm);padding:14px;position:relative;overflow:hidden}
.stat-box::after{content:'';position:absolute;right:0;top:0;width:3px;height:100%;background:var(--g)}
.stat-n{font-size:30px;font-weight:900;color:var(--g);letter-spacing:2px;line-height:1}
.stat-l{font-size:9px;color:var(--t2);letter-spacing:2px;text-transform:uppercase;margin-top:4px}
/* FORM CARD */
.form-card{background:var(--c3);border:1px solid var(--glb);border-radius:var(--rad);padding:16px;margin-bottom:13px}
.form-title{font-size:9px;color:var(--g);letter-spacing:3px;text-transform:uppercase;margin-bottom:14px;font-weight:700}
/* IMG GRID */
.img-grid{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.img-item{width:72px;height:72px;border-radius:var(--rsm);overflow:hidden;border:1.5px solid var(--glb);position:relative;background:var(--c3);cursor:pointer}
.img-item img{width:100%;height:100%;object-fit:cover;display:block}
.img-rm{position:absolute;top:2px;right:2px;background:rgba(0,0,0,.85);border:none;color:#fff;width:18px;height:18px;border-radius:50%;cursor:pointer;font-size:9px;display:flex;align-items:center;justify-content:center}
.img-mb{position:absolute;bottom:2px;left:2px;background:var(--g);color:#0f0f0f;font-size:6px;font-weight:700;padding:1px 3px;border-radius:2px}
.img-add{width:72px;height:72px;border:2px dashed var(--glb);border-radius:var(--rsm);display:flex;align-items:center;justify-content:center;font-size:22px;color:var(--t2);cursor:pointer;transition:all .2s}
.img-add:active{border-color:var(--gb);color:var(--g)}
.img-zone{border:2px dashed var(--glb);border-radius:var(--rsm);padding:18px;text-align:center;cursor:pointer;transition:all .2s}
.img-zone:active{border-color:var(--gb)}
/* VID ZONE */
.vid-zone{border:2px dashed rgba(212,175,55,.3);border-radius:var(--rsm);padding:18px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(212,175,55,.03)}
.vid-zone:active{border-color:var(--gb)}
.vid-prev{width:100%;border-radius:var(--rsm);overflow:hidden;margin-bottom:10px;border:1px solid var(--glb);background:#000;position:relative}
.vid-prev video{width:100%;max-height:180px;display:block;object-fit:contain}
.vid-rm{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.85);border:none;color:#fff;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:13px;z-index:2}
/* ITEM ROW */
.irow{display:flex;align-items:center;gap:10px;padding:11px 14px;border-bottom:1px solid var(--glb)}
.ithumb{width:40px;height:40px;border-radius:6px;overflow:hidden;border:1px solid var(--glb);background:var(--c2);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.ithumb img{width:100%;height:100%;object-fit:cover}
.iinfo{flex:1;min-width:0}
.iname{font-size:12px;color:var(--t1);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.isub{font-size:9px;color:var(--t2);margin-top:2px}
.iacts{display:flex;gap:6px;align-items:center;flex-shrink:0}
/* PILLS */
.pill{font-size:8px;padding:2px 8px;letter-spacing:1px;text-transform:uppercase;border-radius:10px}
.pill-g{background:rgba(30,122,70,.2);color:#3ecf7a;border:1px solid rgba(62,207,122,.25)}
.pill-y{background:rgba(212,175,55,.1);color:var(--g);border:1px solid var(--gb)}
.pill-r{background:rgba(176,48,48,.2);color:#e05555;border:1px solid rgba(224,85,85,.25)}
/* TOGGLE */
.tog{display:flex;align-items:center;gap:10px;cursor:pointer;padding:4px 0}
.tog-t{width:40px;height:22px;background:var(--c4);border-radius:11px;position:relative;transition:background .2s;border:1px solid var(--glb);flex-shrink:0}
.tog-t.on{background:var(--g)}.tog-th{position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:left .2s}
.tog-t.on .tog-th{left:20px}.tog-l{font-size:11px;color:var(--t2)}
/* SUPABASE */
.sb-on{background:rgba(30,122,70,.15);border:1px solid rgba(30,122,70,.3);color:#3ecf7a;font-size:8px;letter-spacing:2px;padding:3px 9px;border-radius:3px;text-transform:uppercase;font-weight:700}
.sb-off{background:rgba(176,48,48,.12);border:1px solid rgba(176,48,48,.25);color:#e05555;font-size:8px;letter-spacing:2px;padding:3px 9px;border-radius:3px;text-transform:uppercase;font-weight:700}
.schema-box{background:rgba(0,0,0,.6);border:1px solid var(--glb);border-radius:var(--rsm);padding:12px;font-family:monospace;font-size:9px;color:var(--t2);line-height:1.6;max-height:200px;overflow-y:auto;white-space:pre;margin-bottom:13px}
/* CLEANUP */
.cl-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--glb);cursor:pointer}
.cl-item:last-child{border-bottom:none}
.cl-chk{width:19px;height:19px;border:2px solid var(--glb);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;transition:all .2s}
.cl-chk.on{background:var(--g);border-color:var(--g);color:#0f0f0f}
/* PROGRESS */
.prog-bar{width:100%;height:6px;background:var(--c4);border-radius:3px;overflow:hidden;margin-top:9px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--g),#b8960c);border-radius:3px;transition:width .3s}
/* RECOMMENDATION */
.rec-row{display:flex;gap:10px;overflow-x:auto;padding:4px 16px 14px;scrollbar-width:none}
.rec-card{flex-shrink:0;width:128px;background:var(--glass);border:1px solid var(--glb);border-radius:var(--rsm);overflow:hidden;cursor:pointer;transition:all .2s}
.rec-card:active{transform:scale(.96)}
.rec-img{height:96px;background:var(--c3);display:flex;align-items:center;justify-content:center;font-size:28px;overflow:hidden}
.rec-img img{width:100%;height:100%;object-fit:cover}
.rec-body{padding:8px 9px 10px}
.rec-name{font-size:11px;color:var(--t1);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.rec-price{font-size:11px;color:var(--g);font-weight:700}
/* EMPTY */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 22px;text-align:center;gap:8px}
.ei{font-size:36px;opacity:.3}.et{font-size:17px;color:var(--t2);font-style:italic}.es{font-size:11px;color:var(--t2);line-height:1.7;max-width:220px}
/* ADM BODY */
.adm-body{padding:14px;overflow-y:auto;flex:1;padding-bottom:calc(24px + var(--sfb))}
/* CHAT LIST */
.clist-row{display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid var(--glb);cursor:pointer;transition:background .15s}
.clist-row:active{background:var(--c3)}
.cav{width:40px;height:40px;border-radius:50%;background:var(--c3);border:1px solid var(--glb);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
/* OTP BOX */
.otp-box{width:44px;height:52px;background:rgba(0,0,0,.5);border:1px solid var(--glb);color:var(--t1);font-size:24px;font-weight:900;text-align:center;outline:none;border-radius:var(--rsm);transition:border-color .2s}
.otp-box:focus{border-color:var(--g)}
/* VID PLAYER */
.vid-player{width:100%;border-radius:var(--rsm);overflow:hidden;border:1px solid var(--glb);background:#000;margin-bottom:14px}
.vid-player video{width:100%;max-height:260px;display:block;object-fit:contain}

/* Admin msg box smooth scroll */
.adm-msgs{-webkit-overflow-scrolling:touch;scroll-behavior:auto}
/* Message rows ‚Äî isolated GPU layers */
.cm,.msg-row{contain:layout;transform:translateZ(0)}
/* Waveform bars ‚Äî GPU layer */
.rw-bar,.vn-bar{will-change:height;transform:translateZ(0)}
/* Chat input area */
.chat-bar,.adm-reply-wrap{transform:translateZ(0);will-change:transform}

/* Chat message long-press delete */
.msg-popup{position:fixed;z-index:9000;background:var(--c2);border:1px solid var(--glb);border-radius:var(--rsm);padding:4px 0;min-width:180px;box-shadow:0 8px 28px rgba(0,0,0,.7);animation:fadeIn .1s ease}
.msg-popup-item{padding:11px 16px;font-size:13px;cursor:pointer;color:var(--t1);display:flex;align-items:center;gap:10px;touch-action:manipulation}
.msg-popup-item:active{background:var(--gl)}
.msg-popup-item.danger{color:#e05555}
.msg-popup-overlay{position:fixed;inset:0;z-index:8999}

</style>
</head>
<body>
<div id="root"></div>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADMIN_EMAIL = 'smitbhatiya47@gmail.com';

// ‚îÄ‚îÄ EMAILJS CONFIG ‚Äî keys loaded from LS at runtime (after LS is defined) ‚îÄ‚îÄ
// Configure in Admin ‚Üí DB tab ‚Üí Email Verification section
const ADMIN_PASS  = 'Smit_5643_@';
const KEY_SB      = 'sms_sb_cfg';
const KEY_SB_SVC  = 'sms_sb_svc'; // Service role key for admin writes only
const KEY_SESSION = 'sms_session';
const KEY_VH      = 'sms_view_hist';
const KEY_NR      = 'sms_notif_reads';
const KEY_ADM_READ= 'sms_adm_read';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const APP = {
  screen: 'loading',   // loading | splash | auth | user | admin
  user: null,
  role: 'user',        // 'user' | 'admin' ‚Äî set on login
  ip: '‚Äî',
  tab: 'home',         // user tabs
  atab: 'dash',        // admin tabs
  cats: [], prods: [], chats: [], audit: [], views: [], notifs: [], logs: [],
  adminCreds: {email: ADMIN_EMAIL, password: ADMIN_PASS}, // loaded from Supabase on boot
  sbOn: false,
  toast: null,
  _toastTimer: null,
  _newAdminMsg: 0,
  // detail state
  detailProd: null,
  detailCatIdx: 0,
  // chat state
  chatUser: null,       // admin: which user's chat is open
  chatFilter: 'all',    // 'all' | 'unread' | 'read'
  activityUser: null,   // admin: which user's activity drill-down
  recState: null,       // recording state
  recTimer: null,
  recSecs: 0,
  recWaves: [],
  recMediaRecorder: null,
  recChunks: [],
  recAudioCtx: null,
  recAnalyser: null,
  recWaveTimer: null,
  // admin dm
  dmEmail: '',
  // home state
  selCat: null,
  selSub: null,
  searchQ: '',
  // forms
  forms: {},
  sbCfg: {url:'', key:''},
  // cleanup
  clFrom: '', clTo: (()=>{const d=new Date();d.setDate(d.getDate()-30);return d.toISOString().split('T')[0];})(), clSel: [], clConfirm: false, clRunning: false, clProg: 0, clDone: null,
};

let _sb = null;      // anon key ‚Äî reads + user inserts
let _sbAdmin = null; // service role key ‚Äî admin writes only

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCAL STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LS = {
  set(k,v){ try{ localStorage.setItem(k,JSON.stringify(v)); }catch(e){} },
  get(k,fb=null){ try{ const r=localStorage.getItem(k); return r!=null?JSON.parse(r):fb; }catch{ return fb; } },
  del(k){ try{ localStorage.removeItem(k); }catch{} },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INDEXED DB CACHE ‚Äî instant loads, works offline
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const IDB = (() => {
  let db = null;
  const DBNAME = 'sms_cache', VER = 7; // bumped ‚Äî session store
  const STORES = ['cats','prods','chats','notifs','users','audit','views',
    'images',       // pre-cached product images as base64
    'sessions',     // session data for instant restore
    'settings',     // all user/admin settings
    'offline_q',    // queued actions when offline (messages, views, etc.)
    'prefetch',     // prefetched data ready to use instantly
    'logs',         // login/activity logs
    'search_idx',   // search index for fast local search
  ];
  function open(){
    return new Promise((res)=>{
      if(db){res(db);return;}
      const req=indexedDB.open(DBNAME,VER);
      req.onupgradeneeded=e=>{
        const d=e.target.result;
        STORES.forEach(s=>{
          try{if(!d.objectStoreNames.contains(s))d.createObjectStore(s,{keyPath:'id'});}
          catch{}// store might already exist ‚Äî safe to ignore
        });
      };
      req.onsuccess=e=>{db=e.target.result;res(db);};
      req.onerror=e=>{
        // Version conflict: another tab has the DB open ‚Äî try deleting and recreating
        console.warn('IDB open error:',e.target.error?.message);
        try{indexedDB.deleteDatabase(DBNAME);}catch{}
        res(null); // fall back to Supabase/LS
      };
      req.onblocked=()=>{
        // Another tab is blocking the version upgrade
        console.warn('IDB blocked ‚Äî another tab has old version open');
        res(null);
      };
    });
  }
  async function getAll(store){
    try{
      const d=await open();if(!d)return[];
      return new Promise(res=>{
        const tx=d.transaction(store,'readonly');
        const req=tx.objectStore(store).getAll();
        req.onsuccess=()=>res(req.result||[]);
        req.onerror=()=>res([]);
      });
    }catch{return[];}
  }
  async function putAll(store,items){
    try{
      const d=await open();if(!d||!items?.length)return;
      const tx=d.transaction(store,'readwrite');
      const os=tx.objectStore(store);
      items.forEach(item=>{if(item?.id)os.put(item);});
    }catch{}
  }
  async function putOne(store,item){
    try{
      const d=await open();if(!d||!item?.id)return;
      const tx=d.transaction(store,'readwrite');
      tx.objectStore(store).put(item);
    }catch{}
  }
  async function clear(store){
    try{
      const d=await open();if(!d)return;
      const tx=d.transaction(store,'readwrite');
      tx.objectStore(store).clear();
    }catch{}
  }
  // Fast single item lookup by field (e.g. find user by email)
  async function findBy(store, field, value){
    try{
      const all = await getAll(store);
      return all.find(x => x[field] === value) || null;
    }catch{return null;}
  }
  // Count items in a store
  async function count(store){
    try{
      const d=await open();if(!d)return 0;
      return new Promise(res=>{
        const tx=d.transaction(store,'readonly');
        const req=tx.objectStore(store).count();
        req.onsuccess=()=>res(req.result||0);
        req.onerror=()=>res(0);
      });
    }catch{return 0;}
  }
  // Delete single item by id
  async function del(store, id){
    try{
      const d=await open();if(!d)return;
      const tx=d.transaction(store,'readwrite');
      tx.objectStore(store).delete(id);
    }catch{}
  }
  // Get total size estimate in bytes
  async function sizeOf(store){
    try{
      const items=await getAll(store);
      return JSON.stringify(items).length;
    }catch{return 0;}
  }
  // Offline queue: add action to process when back online
  async function enqueueOffline(action){
    await putOne('offline_q',{id:uid(),action,ts:Date.now()});
  }
  // Flush offline queue when online
  async function flushOfflineQueue(handler){
    const q=await getAll('offline_q');
    for(const item of q){
      try{await handler(item.action);await del('offline_q',item.id);}
      catch{}
    }
  }
  return{getAll,putAll,putOne,clear,findBy,count,del,sizeOf,enqueueOffline,flushOfflineQueue};
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REALTIME ENGINE ‚Äî Supabase WebSocket subscriptions
// Delivers new messages instantly to all clients
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RT = (() => {
  let ws = null, reconnectTimer = null, pingTimer = null;
  let _subs = {}; // table -> [callbacks]
  let _url = '', _key = '';
  let _connected = false;
  let _reconnectDelay = 1000;

  function init(url, key){
    _url = url; _key = key;
    connect();
  }

  function connect(){
    if(!_url||!_key)return;
    try{
      const wsUrl = _url.replace('https://','wss://').replace('http://','ws://') +
        '/realtime/v1/websocket?vsn=1.0.0&apikey=' + _key;
      ws = new WebSocket(wsUrl);
      ws.onopen = () => {
        _connected = true;
        _reconnectDelay = 1000;
        // Re-subscribe all channels
        Object.keys(_subs).forEach(tbl => _subscribe(tbl));
        // Heartbeat every 25s
        if(pingTimer)clearInterval(pingTimer);
        pingTimer = setInterval(()=>{ if(ws&&ws.readyState===1)ws.send(JSON.stringify({topic:'phoenix',event:'heartbeat',payload:{},ref:'hb'})); }, 25000);
      };
      ws.onmessage = e => {
        try{
          const msg = JSON.parse(e.data);
          // Supabase Realtime v2: postgres_changes event wraps data
          if(msg.event==='postgres_changes'){
            const d=msg.payload?.data;
            if(d){
              const tbl=d.table||msg.topic?.split(':').pop();
              if(tbl&&_subs[tbl]) _subs[tbl].forEach(cb=>{try{cb(d.type,d.record,d.old_record);}catch{}});
            }
          }
          // Legacy v1 format fallback
          if(msg.event==='INSERT'||msg.event==='UPDATE'||msg.event==='DELETE'){
            const tbl=msg.topic?.split(':').pop();
            if(tbl&&_subs[tbl]) _subs[tbl].forEach(cb=>{try{cb(msg.event,msg.payload?.record,msg.payload?.old_record);}catch{}});
          }
        }catch{}
      };
      ws.onclose = () => {
        _connected = false;
        if(pingTimer){clearInterval(pingTimer);pingTimer=null;}
        // Exponential backoff reconnect
        if(reconnectTimer)clearTimeout(reconnectTimer);
        reconnectTimer = setTimeout(()=>connect(), _reconnectDelay);
        _reconnectDelay = Math.min(_reconnectDelay * 1.5, 30000);
      };
      ws.onerror = () => { try{ws.close();}catch{} };
    }catch{}
  }

  function _subscribe(tbl){
    if(!ws||ws.readyState!==1)return;
    ws.send(JSON.stringify({
      topic: 'realtime:' + tbl,
      event: 'phx_join',
      payload: {
        config:{
          broadcast:{self:false},
          postgres_changes:[{event:'*',schema:'public',table:tbl}]
        }
      },
      ref: tbl
    }));
  }

  function on(tbl, cb){
    if(!_subs[tbl]) _subs[tbl] = [];
    if(!_subs[tbl].includes(cb)) _subs[tbl].push(cb); // dedup by reference
    if(_connected) _subscribe(tbl);
  }

  function reset(){
    _subs={};_connected=false;_reconnectDelay=1000;
    if(pingTimer){clearInterval(pingTimer);pingTimer=null;}
    if(reconnectTimer){clearTimeout(reconnectTimer);reconnectTimer=null;}
    try{if(ws){ws.onclose=null;ws.onerror=null;ws.close();ws=null;}}catch{}
  }
  function isConnected(){ return _connected; }
  return { init, on, reset, isConnected };
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REQUEST DEDUP ‚Äî prevent parallel identical fetches
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _inFlight = {};
function dedupFetch(key, fn){
  if(_inFlight[key]) return _inFlight[key];
  _inFlight[key] = fn().finally(()=>{ delete _inFlight[key]; });
  return _inFlight[key];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class SB {
  constructor(url,key){
    this.base=url.replace(/\/$/,'');
    this.h={'apikey':key,'Authorization':'Bearer '+key,'Content-Type':'application/json','Prefer':'return=representation'};
  }
  async req(path,method,body,extraH){
    const isWrite=(method==='POST'||method==='PATCH'||method==='DELETE');
    try{
      let fetchOpts={method:method||'GET',headers:{...this.h,...(extraH||{})},body:body?JSON.stringify(body):undefined};
      if(!isWrite){
        // Reads: abort after 20s to avoid hanging UI
        const ctrl=new AbortController();
        const timer=setTimeout(()=>ctrl.abort(),20000);
        fetchOpts.signal=ctrl.signal;
        try{
          const r=await fetch(this.base+'/rest/v1/'+path,fetchOpts);
          clearTimeout(timer);
          if(!r.ok){const txt=await r.text();let msg=txt;try{const j=JSON.parse(txt);msg=j.message||j.error||txt;}catch{}throw new Error(msg);}
          const t=await r.text();return t?JSON.parse(t):null;
        }catch(e){clearTimeout(timer);if(e.name==='AbortError')throw new Error('Connection too slow. Please try again.');throw e;}
      } else {
        // Writes: NO timeout ‚Äî never interrupt a save operation
        // Browser will eventually handle the connection itself
        const r=await fetch(this.base+'/rest/v1/'+path,fetchOpts);
        if(!r.ok){
          const txt=await r.text();
          let msg=txt;
          try{
            const j=JSON.parse(txt);
            // Translate common Supabase errors to plain English
            if(j.code==='42501'||msg.includes('row-level security'))msg='Permission denied. Make sure your Service Role Key is configured in the DB settings tab.';
            else if(j.code==='23505')msg='This item already exists (duplicate ID).';
            else if(j.code==='23502')msg='A required field is missing.';
            else msg=j.message||j.error||txt;
          }catch{}
          throw new Error(msg);
        }
        const t=await r.text();return t?JSON.parse(t):null;
      }
    }catch(e){
      if(e.name==='AbortError'||e.message?.includes('aborted without'))throw new Error('Connection too slow. Please try again.');
      throw e;
    }
  }
  sel(tbl,filter,order){let q=tbl+'?select=*&order='+(order||'created_at.desc');if(filter)q+='&'+filter;return this.req(q);}
  ins(tbl,data){return this.req(tbl,'POST',Array.isArray(data)?data:[data]);}
  upd(tbl,id,data){return this.req(tbl+'?id=eq.'+id,'PATCH',data);}
  del(tbl,id){return this.req(tbl+'?id=eq.'+id,'DELETE');}
  delF(tbl,filter){return this.req(tbl+'?'+filter,'DELETE');}
  ups(tbl,data){return this.req(tbl,'POST',Array.isArray(data)?data:[data],{'Prefer':'resolution=merge-duplicates,return=representation'});}
  async uploadImg(bucket,name,blob){
    const r=await fetch(this.base+'/storage/v1/object/'+bucket+'/'+name,{method:'POST',headers:{'apikey':this.h.apikey,'Authorization':this.h.Authorization,'Content-Type':blob.type||'image/jpeg'},body:blob});
    if(!r.ok)throw new Error(await r.text());
    return this.base+'/storage/v1/object/public/'+bucket+'/'+name;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DB LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB = {
  getCats:()=>{ if(_sb)return dedupFetch('getCats',()=>_sb.sel('sms_categories','','sort_order.asc').catch(()=>[])); return Promise.resolve(LS.get('sms_cats',[])); },
  saveCat:(c)=>{ const sb=_sbAdmin||_sb; if(sb)return sb.ups('sms_categories',c).then(r=>r?.[0]); const a=LS.get('sms_cats',[]); const i=a.findIndex(x=>x.id===c.id); if(i>=0)a[i]=c;else a.push(c); LS.set('sms_cats',a); return Promise.resolve(c); },
  delCat:(id)=>{ const sb=_sbAdmin||_sb; if(sb)return Promise.all([sb.del('sms_categories',id),sb.delF('sms_categories','parent_id=eq.'+id)]); LS.set('sms_cats',LS.get('sms_cats',[]).filter(c=>c.id!==id&&c.parent_id!==id)); return Promise.resolve(); },
  getProds:()=>{ if(_sb)return dedupFetch('getProds',()=>_sb.sel('sms_products').catch(()=>[])); return Promise.resolve(LS.get('sms_prods',[])); },
  saveProd:(p)=>{ const sb=_sbAdmin||_sb; if(sb)return sb.ups('sms_products',p).then(r=>r?.[0]); const a=LS.get('sms_prods',[]); const i=a.findIndex(x=>x.id===p.id); if(i>=0)a[i]=p;else a.push(p); LS.set('sms_prods',a); return Promise.resolve(p); },
  delProd:(id)=>{ const sb=_sbAdmin||_sb; if(sb)return sb.del('sms_products',id); LS.set('sms_prods',LS.get('sms_prods',[]).filter(p=>p.id!==id)); return Promise.resolve(); },
  getChats:()=>{ 
    const sb=_sbAdmin||_sb; 
    if(sb)return dedupFetch('getChats',()=>
      // Fetch last 5000 messages ‚Äî covers 1000 users √ó 5 avg messages
      sb.req('sms_chats?select=*&order=sent_at.asc&limit=5000').catch(()=>[])
    ); 
    return Promise.resolve(LS.get('sms_chats',[])); 
  },
  addChat:async(m)=>{ 
    IDB.putOne('chats',m); 
    if(_sb){
      let attempts=0;
      while(attempts<3){
        try{await _sb.ins('sms_chats',m);break;}
        catch(e){
          attempts++;
          if(attempts===3)throw e;
          await new Promise(r=>setTimeout(r,800)); // flat 800ms between retries
        }
      }
      return;
    }
    const a=LS.get('sms_chats',[]); LS.set('sms_chats',[...a,m]); return Promise.resolve(); 
  },
  delChatMsg:(id)=>{ const sb=_sbAdmin||_sb; if(sb)return sb.del('sms_chats',id).catch(()=>{}); LS.set('sms_chats',LS.get('sms_chats',[]).filter(m=>m.id!==id)); return Promise.resolve(); },
  redactChatMsg:(id)=>{ const sb=_sbAdmin||_sb; if(sb)return sb.upd('sms_chats',id,{message:'_deleted_',msg_type:'text',voice_data:null}).catch(()=>{}); const a=LS.get('sms_chats',[]); const i=a.findIndex(m=>m.id===id); if(i>=0){a[i]={...a[i],message:'_deleted_',msg_type:'text',voice_data:null};LS.set('sms_chats',a);} return Promise.resolve(); },
  unlockChat:(email)=>{ const sb=_sbAdmin||_sb; if(sb){ return sb.sel('sms_chats','user_email=eq.'+encodeURIComponent(email)).then(async rows=>{if(rows&&rows.length)await Promise.all(rows.map(r=>sb.upd('sms_chats',r.id,{locked:false,admin_unlocked:true}).catch(()=>{})));}).catch(()=>{}); } const a=LS.get('sms_chats',[]); LS.set('sms_chats',a.map(m=>m.user_email===email?{...m,locked:false,admin_unlocked:true}:m)); return Promise.resolve(); },
  lockChat:(email)=>{ const sb=_sbAdmin||_sb; if(sb){ return sb.sel('sms_chats','user_email=eq.'+encodeURIComponent(email)).then(async rows=>{if(rows&&rows.length)await Promise.all(rows.map(r=>sb.upd('sms_chats',r.id,{locked:true,admin_unlocked:false}).catch(()=>{})));}).catch(()=>{}); } const a=LS.get('sms_chats',[]); LS.set('sms_chats',a.map(m=>m.user_email===email?{...m,locked:true,admin_unlocked:false}:m)); return Promise.resolve(); },
  addAudit:(e)=>{ const sb=_sbAdmin||_sb; if(sb)return sb.ins('sms_audit',e).catch(()=>{}); const a=LS.get('sms_audit',[]); LS.set('sms_audit',[e,...a].slice(0,10000)); return Promise.resolve(); },
  getAudit:()=>{ const sb=_sbAdmin||_sb; if(sb)return sb.sel('sms_audit','','logged_at.desc').catch(()=>[]); return Promise.resolve(LS.get('sms_audit',[])); },
  getNotifs:()=>{ if(_sb)return _sb.sel('sms_notifs').catch(()=>[]); return Promise.resolve(LS.get('sms_notifs',[])); },
  addNotif:(n)=>{ const sb=_sbAdmin||_sb; if(sb)return sb.ins('sms_notifs',n).catch(()=>{}); const a=LS.get('sms_notifs',[]); LS.set('sms_notifs',[n,...a]); return Promise.resolve(); },
  delNotif:(id)=>{ const sb=_sbAdmin||_sb; if(sb)return sb.del('sms_notifs',id).catch(()=>{}); LS.set('sms_notifs',LS.get('sms_notifs',[]).filter(n=>n.id!==id)); return Promise.resolve(); },
  markRead:(nid,email)=>{ if(_sb)return _sb.ups('sms_notif_reads',{id:nid+'_'+email,notif_id:nid,user_email:email}).catch(()=>{}); const a=LS.get(KEY_NR,[]); if(!a.find(r=>r.nid===nid&&r.email===email))LS.set(KEY_NR,[...a,{nid,email}]); return Promise.resolve(); },
  getReads:(email)=>{ if(_sb)return _sb.sel('sms_notif_reads','user_email=eq.'+encodeURIComponent(email)).catch(()=>[]).then(r=>(r||[]).map(x=>x.notif_id)); return Promise.resolve(LS.get(KEY_NR,[]).filter(r=>r.email===email).map(r=>r.nid)); },
  uploadImg:async(file,folder)=>{ const sb=_sbAdmin||_sb; if(sb){ const name=(folder||'products')+'/'+Date.now()+'_'+Math.random().toString(36).slice(2)+'.jpg'; const blob=await toBlob(file); return sb.uploadImg('sms-images',name,blob); } return toBase64(file); },
  uploadVideo:async(file)=>{ const sb=_sbAdmin||_sb; if(sb){ const ext=(file.name||'v.mp4').split('.').pop()||'mp4'; const name='videos/'+Date.now()+'_'+Math.random().toString(36).slice(2)+'.'+ext; const r=await fetch(sb.base+'/storage/v1/object/sms-images/'+name,{method:'POST',headers:{'apikey':sb.h.apikey,'Authorization':sb.h.Authorization,'Content-Type':file.type||'video/mp4'},body:file}); if(!r.ok)throw new Error(await r.text()); return sb.base+'/storage/v1/object/public/sms-images/'+name; } return new Promise((res,rej)=>{const rd=new FileReader();rd.onload=e=>res(e.target.result);rd.onerror=rej;rd.readAsDataURL(file);}); },
  getAllViews:()=>{ const sb=_sbAdmin||_sb; if(sb)return sb.sel('sms_view_hist','','viewed_at.desc').catch(()=>[]); return Promise.resolve(LS.get(KEY_VH,[])); },
  addView:(e)=>{ if(_sb)return _sb.ins('sms_view_hist',e).catch(()=>{}); const a=LS.get(KEY_VH,[]); LS.set(KEY_VH,[e,...a].slice(0,20000)); return Promise.resolve(); },
  getUserViews:(email)=>{ if(_sb)return _sb.sel('sms_view_hist','user_email=eq.'+encodeURIComponent(email),'viewed_at.desc').catch(()=>[]); return Promise.resolve(LS.get(KEY_VH,[]).filter(v=>v.user_email===email)); },
  bulkDeleteChats:(before)=>{ if(_sb)return _sb.delF('sms_chats','sent_at=lt.'+before).catch(()=>{}); LS.set('sms_chats',LS.get('sms_chats',[]).filter(m=>(m.sent_at||'')>=before)); return Promise.resolve(); },
  bulkDeleteAudit:(before)=>{ if(_sb)return _sb.delF('sms_audit','logged_at=lt.'+before).catch(()=>{}); LS.set('sms_audit',LS.get('sms_audit',[]).filter(m=>(m.logged_at||'')>=before)); return Promise.resolve(); },
  bulkDeleteViews:(before)=>{ if(_sb)return _sb.delF('sms_view_hist','viewed_at=lt.'+before).catch(()=>{}); LS.set(KEY_VH,LS.get(KEY_VH,[]).filter(v=>(v.viewed_at||'')>=before)); return Promise.resolve(); },
  bulkDeleteNotifs:(before)=>{ if(_sb)return _sb.delF('sms_notifs','created_at=lt.'+before).catch(()=>{}); LS.set('sms_notifs',LS.get('sms_notifs',[]).filter(n=>(n.created_at||'')>=before)); return Promise.resolve(); },
  // ‚îÄ‚îÄ USER LOGS (login records with full user info) ‚îÄ‚îÄ
  addLog:(entry)=>{ const sb=_sbAdmin||_sb; if(sb)return sb.ins('sms_logs',entry).catch(()=>{}); const a=LS.get('sms_logs',[]); LS.set('sms_logs',[entry,...a].slice(0,20000)); return Promise.resolve(); },
  getLogs:()=>{ const sb=_sbAdmin||_sb; if(sb)return sb.sel('sms_logs','','logged_at.desc').catch(()=>[]); return Promise.resolve(LS.get('sms_logs',[])); },
  // ‚îÄ‚îÄ USER MANAGEMENT ‚îÄ‚îÄ
  saveUser:(u)=>{ const sb=_sbAdmin||_sb; if(sb)return sb.ups('sms_users',u).catch(()=>{}); const a=LS.get('sms_users',[]); const i=a.findIndex(x=>x.email===u.email); if(i>=0)a[i]=u;else a.push(u); LS.set('sms_users',a); return Promise.resolve(); },
  getUsers:()=>{ const sb=_sbAdmin||_sb; if(sb)return dedupFetch('getUsers',()=>sb.sel('sms_users','','registered_at.desc').catch(()=>[])); return Promise.resolve(LS.get('sms_users',[])); },
  delUser:(id)=>{ const sb=_sbAdmin||_sb; if(sb)return sb.del('sms_users',id).catch(()=>{}); LS.set('sms_users',LS.get('sms_users',[]).filter(u=>u.id!==id)); return Promise.resolve(); },
  saveNickname:(email,nick)=>{
    const sb=_sbAdmin||_sb;
    if(sb)return sb.req('sms_users?email=eq.'+encodeURIComponent(email),'PATCH',{nickname:nick}).catch(()=>{});
    const a=LS.get('sms_users',[]);const i=a.findIndex(u=>u.email===email);if(i>=0){a[i].nickname=nick;LS.set('sms_users',a);}
    return Promise.resolve();
  },
  bulkDeleteLogs:(before)=>{ if(_sb)return _sb.delF('sms_logs','logged_at=lt.'+before).catch(()=>{}); LS.set('sms_logs',LS.get('sms_logs',[]).filter(l=>(l.logged_at||'')>=before)); return Promise.resolve(); },
  // ‚îÄ‚îÄ ADMIN CREDENTIALS (from Supabase admin_settings table) ‚îÄ‚îÄ
  getAdminCreds:async()=>{
    if(_sb){
      try{
        const rows=await _sb.sel('admin_settings','id=eq.main','updated_at.desc');
        if(rows&&rows[0])return{email:rows[0].email,password:rows[0].password};
      }catch(e){ console.warn('admin_settings read failed:',e.message); }
    }
    // Fallback: check localStorage override, then hardcoded defaults
    const local=LS.get('sms_admin_creds');
    if(local)return local;
    return{email:ADMIN_EMAIL,password:ADMIN_PASS};
  },
  saveAdminCreds:async(email,password)=>{
    const row={id:'main',email,password,updated_at:new Date().toISOString()};
    const sb=_sbAdmin||_sb;
    if(sb){
      await sb.ups('admin_settings',row);
    }
    // Always mirror to localStorage so login works offline too
    LS.set('sms_admin_creds',{email,password});
    return row;
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2);
const nowIST=()=>new Date().toLocaleString('en-IN',{timeZone:'Asia/Kolkata',hour12:false});
const genOTP=()=>Math.floor(100000+Math.random()*900000).toString();
function toBlob(file,maxW=900){return new Promise((res,rej)=>{const rd=new FileReader();rd.onload=e=>{const img=new Image();img.onload=()=>{const c=document.createElement('canvas');const ratio=Math.min(1,maxW/img.width);c.width=Math.round(img.width*ratio);c.height=Math.round(img.height*ratio);c.getContext('2d').drawImage(img,0,0,c.width,c.height);c.toBlob(res,'image/jpeg',.82);};img.onerror=rej;img.src=e.target.result;};rd.onerror=rej;rd.readAsDataURL(file);});}
function toBase64(file,maxW=900){return new Promise((res,rej)=>{const rd=new FileReader();rd.onload=e=>{const img=new Image();img.onload=()=>{const c=document.createElement('canvas');const ratio=Math.min(1,maxW/img.width);c.width=Math.round(img.width*ratio);c.height=Math.round(img.height*ratio);c.getContext('2d').drawImage(img,0,0,c.width,c.height);res(c.toDataURL('image/jpeg',.82));};img.onerror=rej;img.src=e.target.result;};rd.onerror=rej;rd.readAsDataURL(file);});}
function notify(msg){
  if(APP._toastTimer)clearTimeout(APP._toastTimer);
  const existing=document.querySelector('.toast-wrap');
  if(existing)existing.remove();
  const t=document.createElement('div');t.className='toast-wrap';t.textContent=msg;
  document.getElementById('root').appendChild(t);
  APP._toastTimer=setTimeout(()=>t.remove(),3000);
}
function el(tag,attrs,children){
  const e=document.createElement(tag);
  if(attrs)Object.entries(attrs).forEach(([k,v])=>{
    if(k==='class')e.className=v;
    else if(k.startsWith('on'))e.addEventListener(k.slice(2).toLowerCase(),v);
    else if(k==='style'&&typeof v==='object')Object.assign(e.style,v);
    else if(k==='html')e.innerHTML=v;
    else e.setAttribute(k,v);
  });
  if(children){[].concat(children).forEach(c=>{if(c==null||c===false)return;e.appendChild(typeof c==='string'?document.createTextNode(c):c);});}
  return e;
}
function h(tag,attrs,...children){return el(tag,attrs,children.flat());}
function fmtSecs(s){const m=Math.floor(s/60);const sc=s%60;return m+':'+(sc<10?'0':'')+sc;}
function domSel(sel,ctx){return (ctx||document).querySelector(sel);}
function domAll(sel,ctx){return (ctx||document).querySelectorAll(sel);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _renderPending=false;
let _rafHandle=null;

function render(){
  if(_renderPending)return;
  _renderPending=true;
  if(_rafHandle)cancelAnimationFrame(_rafHandle);
  _rafHandle=requestAnimationFrame(()=>{
    _renderPending=false;
    _rafHandle=null;
    _doRender();
  });
}

function _doRender(){
  // Skip full rebuild if recording is active (prevents recording interruption + blink)
  const _uc=typeof _userChat!=='undefined'?_userChat:null;
  const _ac=typeof _admChatState!=='undefined'?_admChatState:null;
  if((_uc&&_uc.recording)||(_ac&&_ac.recording)){
    // Only update badge/counter elements without destroying DOM
    const badge=document.querySelector('.bn-badge');
    if(badge&&APP._newAdminMsg>0)badge.textContent=APP._newAdminMsg>9?'9+':APP._newAdminMsg;
    return;
  }
  const root=document.getElementById('root');
  // Remove old view (keep toast)
  Array.from(root.children).forEach(ch=>{if(!ch.classList.contains('toast-wrap'))ch.remove();});
  let view;
  switch(APP.screen){
    case 'loading': view=renderLoader(); break;
    case 'splash':  view=renderSplash(); break;
    case 'auth':    view=renderAuth(); break;
    case 'user':    view=renderUser(); break;
    case 'admin':   view=renderAdmin(); break;
    default:        view=renderLoader();
  }
  root.insertBefore(view, root.querySelector('.toast-wrap'));
}

// renderNow ‚Äî bypass rAF debounce for instant critical updates
function renderNow(){ _renderPending=false; if(_rafHandle){cancelAnimationFrame(_rafHandle);_rafHandle=null;} _doRender(); }

function go(screen, extra){
  if(extra)Object.assign(APP,extra);
  APP.screen=screen;
  renderNow(); // navigation must be instant
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOADER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLoader(){
  return h('div',{class:'loader-wrap'},
    h('div',{class:'loader-brand'},'SURESH MILLGIN'),
    h('div',{class:'loader-bar'}),
    h('div',{class:'loader-sub'},'LOADING‚Ä¶')
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPLASH / POLICY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSplash(){
  const wrap=h('div',{class:'splash-wrap fade-in'},
    h('div',{class:'brand-big'},'SURESH MILLGIN STORES'),
    h('div',{class:'brand-sub'},'Loom Machinery Spare Parts ¬∑ Est. 2004'),
    h('div',{class:'gold-line'}),
    h('div',{class:'policy-box',html:`
      <h4>Terms & Conditions ‚Äî Digital Product Catalog</h4>
      This application ("App") is operated by <strong>Suresh Millgin Stores</strong>, a proprietary firm registered and operating under Indian law. By tapping "Accept & Continue", you agree to these Terms unconditionally.
      <br><br>
      <strong>1. Nature of this Platform</strong><br>
      This App is a <em>digital product catalog</em> for informational purposes only. It does <em>not</em> constitute an e-commerce platform. No direct purchase, payment gateway, delivery, or financial transaction is facilitated through this App. All pricing shown is indicative and subject to change without notice.
      <br><br>
      <strong>2. Data Collection Disclosure</strong><br>
      By using this App, you explicitly consent to the collection of: (a) your full name, company/firm name, mobile number, email address, and password (stored in encrypted/masked form); (b) your IP address at each login; (c) your in-app activity including which catalog products you view and at what time. This data is collected for legitimate business purposes including identity verification, fraud prevention, and improving catalog recommendations, as permitted under the <em>Information Technology Act, 2000</em> and the <em>Digital Personal Data Protection Act, 2023 (DPDP Act)</em> of India.
      <br><br>
      <strong>3. Limitation of Liability ‚Äî Data Security</strong><br>
      Suresh Millgin Stores and its owners, employees, and agents shall <em>not</em> be held liable for any data breach, unauthorized access, hacking, cyber-attack, or third-party interception of user data. Users acknowledge that no digital system is fully immune to security threats. By using this App, you waive any legal claim against Suresh Millgin Stores arising from data loss or breach, to the maximum extent permitted under Indian law. This disclaimer is consistent with the IT Act, 2000 and the DPDP Act, 2023.
      <br><br>
      <strong>4. No E-Commerce / Delivery Liability</strong><br>
      This platform does not handle orders, deliveries, payments, or returns. Any transactions between the user and Suresh Millgin Stores are conducted separately (offline/telephonically) and are governed by mutually agreed terms at the time of transaction. The App owner bears no responsibility for disputes arising from offline transactions.
      <br><br>
      <strong>5. Intellectual Property</strong><br>
      All catalog content, product descriptions, images, and data within this App are the intellectual property of Suresh Millgin Stores. Reproduction, distribution, or commercial use of this content without written permission is prohibited.
      <br><br>
      <strong>6. Governing Law & Jurisdiction</strong><br>
      These Terms are governed by the laws of India. Any disputes shall be subject to the exclusive jurisdiction of courts located in Gujarat, India.
      <br><br>
      <h4>Privacy Policy</h4>
      <strong>What we collect:</strong> Name, company, mobile, email, IP address, app activity (views, login time).<br>
      <strong>Why we collect it:</strong> For business identification, security auditing, and personalised catalog recommendations.<br>
      <strong>Retention:</strong> Data is retained for as long as your account is active or as required for business purposes.<br>
      <strong>Third parties:</strong> We do not sell your data. We may share it with cloud infrastructure providers (e.g. Supabase) solely for storage.<br>
      <strong>Your rights:</strong> Under the DPDP Act, 2023, you may request data deletion by contacting the store directly.<br>
      <strong>Disclaimer:</strong> The App owner is not liable for data breaches caused by third parties, hackers, or infrastructure failures beyond our reasonable control.
    `}),
    h('div',{style:{fontSize:'10px',color:'var(--g)',textAlign:'center',marginBottom:'10px',fontStyle:'italic'}},'Scroll to read full policy'),
    h('button',{class:'btn btn-g',onClick:()=>go('auth')},'ACCEPT & CONTINUE ‚Üí'),
  );
  const wrap2=h('div',{class:'page',style:{background:'var(--c)',alignItems:'center',justifyContent:'center',overflowY:'auto'}},wrap);
  return wrap2;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _authState={mode:'login',email:'',pass:'',stayIn:true,regF:{name:'',ferm:'',mob:'',email:'',pass:''},otp:['','','','','',''],genOTP:'',showPass:false,err:'',okMsg:'',loading:false,otpExpiry:0,otpSent:false};

function renderAuth(){
  const s=_authState;
  const wrap=h('div',{class:'page fade-in',style:{background:'var(--c)',alignItems:'center',justifyContent:'center',padding:'22px 18px',overflowY:'auto'}});

  // Brand
  wrap.appendChild(h('div',{style:{textAlign:'center',marginBottom:'22px'}},
    h('div',{style:{fontSize:'26px',fontWeight:'900',color:'var(--g)',letterSpacing:'5px',textTransform:'uppercase'}},'SURESH MILLGIN'),
    h('div',{style:{fontSize:'9px',color:'var(--t2)',letterSpacing:'3px',marginTop:'3px',textTransform:'uppercase'}},'Loom Machinery Spare Parts')
  ));

  if(s.loading){
    wrap.appendChild(h('div',{style:{textAlign:'center',padding:'40px',color:'var(--g)',fontSize:'14px',fontStyle:'italic'}},'Signing in‚Ä¶'));
    return wrap;
  }

  if(s.mode==='login') return renderAuthLogin(wrap);
  if(s.mode==='register') return renderAuthRegister(wrap);
  if(s.mode==='otp') return renderAuthOTP(wrap);
  return wrap;
}

function stayCheckbox(stayIn, onChange){
  const box=h('div',{class:'stay-row',onClick:onChange},
    h('div',{class:'stay-box '+(stayIn?'on':'')}, stayIn?'‚úì':''),
    h('span',{class:'stay-label '+(stayIn?'on':'')},'Stay logged in')
  );
  return box;
}

function renderAuthLogin(wrap){
  const s=_authState;
  const card=h('div',{class:'gc',style:{width:'100%',padding:'24px 18px',borderRadius:'var(--rad)'}});
  card.appendChild(h('div',{style:{textAlign:'center',marginBottom:'10px',fontSize:'10px',color:'var(--g)',letterSpacing:'2px',fontWeight:'700',background:'rgba(212,175,55,0.08)',padding:'5px 8px',borderRadius:'4px',border:'1px solid rgba(212,175,55,0.25)'}},'‚úì v20260228_070906'));
  card.appendChild(h('div',{style:{fontSize:'22px',fontStyle:'italic',textAlign:'center',marginBottom:'3px',color:'var(--t1)'}},'Sign In'));
  card.appendChild(h('div',{style:{fontSize:'10px',color:'var(--t2)',letterSpacing:'2px',textAlign:'center',marginBottom:'20px',textTransform:'uppercase'}},'Authorised Personnel Only'));
  if(s.err)card.appendChild(h('div',{class:'err'},s.err));

  const emailIn=h('input',{class:'inp',type:'email',placeholder:'your@email.com',value:s.email});
  emailIn.addEventListener('input',e=>s.email=e.target.value);
  const passIn=h('input',{class:'inp',type:s.showPass?'text':'password',placeholder:'Your password',value:s.pass});
  passIn.addEventListener('input',e=>s.pass=e.target.value);
  passIn.addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
  const eyeBtn=h('button',{class:'inp-eye',onClick:()=>{s.showPass=!s.showPass;renderNow();}},s.showPass?'üôà':'üëÅ');

  card.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Email'),emailIn));
  card.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Password'),h('div',{class:'inp-wrap'},passIn,eyeBtn)));
  card.appendChild(stayCheckbox(s.stayIn,()=>{s.stayIn=!s.stayIn;renderNow();}));
  const signInBtn=h('button',{class:'btn btn-g',style:{opacity:s.loading?'0.5':'1',pointerEvents:s.loading?'none':'auto',transition:'opacity .15s'},onClick:doLogin},s.loading?'‚è≥ SIGNING IN‚Ä¶':'SIGN IN');
  card.appendChild(signInBtn);
  card.appendChild(h('div',{style:{textAlign:'center',fontSize:'12px',color:'var(--t2)',marginTop:'15px'}},
    'New here? ',
    h('span',{style:{color:'var(--g)',cursor:'pointer',fontWeight:'700'},onClick:()=>{s.mode='register';s.err='';renderNow();}},'Create Account')
  ));
  // Version inside card ‚Äî always visible

  wrap.appendChild(card);
  return wrap;
}

async function doLogin(){
  const s=_authState;
  s.err='';
  const email=(s.email||'').trim();
  const pass=(s.pass||'').trim();
  if(!email&&!pass){s.err='‚ö† Please enter your email and password.';renderNow();return;}
  if(!email){s.err='‚ö† Please enter your email address.';renderNow();return;}
  if(!pass){s.err='‚ö† Please enter your password.';renderNow();return;}

  // Show loading IMMEDIATELY ‚Äî no network call before spinner
  s.loading=true;renderNow();
  try{ await _doLoginInner(email,pass,s); }
  catch(e){ s.err='Login error. Please try again.';s.loading=false;renderNow(); }
}

async function _doLoginInner(email,pass,s){

  // ‚îÄ‚îÄ ADMIN CHECK: use in-memory cache first, only fetch if empty ‚îÄ‚îÄ
  let creds=APP.adminCreds;
  if(!creds||!creds.email){
    // First login or cache empty ‚Äî fetch once, then cache
    try{creds=await DB.getAdminCreds();}catch{creds=null;}
    APP.adminCreds=creds||{};
  }
  // Safe null check ‚Äî creds may be null if DB not configured
  if(creds&&email===creds.email && pass===creds.password){
    if(s.stayIn)LS.set(KEY_SESSION,{role:'admin',user:{email:creds.email},ts:Date.now()});
    APP.role='admin';

    // ‚îÄ‚îÄ Phase 1: IDB cache only ‚Äî instant ‚îÄ‚îÄ
    const [_ac,_ap,_ach,_an,_au,_aaud,_avw]=await Promise.all([
      IDB.getAll('cats'),IDB.getAll('prods'),IDB.getAll('chats'),IDB.getAll('notifs'),
      IDB.getAll('users'),IDB.getAll('audit'),IDB.getAll('views')
    ]);
    APP.cats=_ac;APP.prods=_ap;
    APP.chats=_ach.sort((a,b)=>(a.sent_at||'').localeCompare(b.sent_at||''));
    APP.notifs=_an;APP.users=_au;APP.audit=_aaud;APP.views=_avw;

    // ‚îÄ‚îÄ Navigate immediately ‚Äî admin sees dashboard NOW ‚îÄ‚îÄ
    DB.addAudit({id:uid(),event:'Admin Login',user_email:email,ip:APP.ip,logged_at:new Date().toISOString()});
    s.loading=false;
    go('admin');

    // ‚îÄ‚îÄ Phase 2: background network sync (non-blocking) ‚îÄ‚îÄ
    loadAllAdmin().catch(()=>{});
    return;
  }

  // ‚îÄ‚îÄ USER CHECK ‚îÄ‚îÄ
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){s.err='Enter a valid email.';s.loading=false;renderNow();return;}
  if(pass.length<6){s.err='Incorrect credentials.';s.loading=false;renderNow();return;}
  s.loading=true;renderNow();
  let u={name:email.split('@')[0],ferm:'',mob:'',email};
  APP.user=u;APP.role='user';

  // ‚îÄ‚îÄ Phase 1: IDB cache only ‚Äî instant, <50ms ‚îÄ‚îÄ
  const [_ic,_ip,_in]=await Promise.all([IDB.getAll('cats'),IDB.getAll('prods'),IDB.getAll('notifs')]);
  if(_ic.length){APP.cats=_ic;APP.prods=_ip;APP.notifs=_in;}
  const _cachedChats=await IDB.getAll('chats');
  const _myChats=_cachedChats.filter(m=>m.user_email===email);
  if(_myChats.length)APP.chats=_myChats.sort((a,b)=>(a.sent_at||'').localeCompare(b.sent_at||''));

  // ‚îÄ‚îÄ Navigate immediately ‚Äî user sees the app NOW ‚îÄ‚îÄ
  if(s.stayIn)LS.set(KEY_SESSION,{role:'user',user:u,ts:Date.now()});
  s.loading=false;
  go('user');

  // ‚îÄ‚îÄ Phase 2: background network sync (non-blocking) ‚îÄ‚îÄ
  loadAllUser().then(()=>{
    const _dbU=(APP.users||[]).find(x=>x.email===email);
    if(_dbU){
      u={...u,name:_dbU.name||u.name,ferm:_dbU.firm||'',mob:_dbU.mobile||''};
      APP.user=u;
      if(s.stayIn)LS.set(KEY_SESSION,{role:'user',user:u,ts:Date.now()});
    }
  }).catch(()=>{});
  DB.addLog({id:uid(),user_name:u.name,firm:u.ferm||'',mobile:u.mob||'',email:u.email,pass_masked:'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',ip:APP.ip,logged_at:new Date().toISOString()});
  DB.addAudit({id:uid(),event:'User Login',user_email:u.email,ip:APP.ip,logged_at:new Date().toISOString()});
}

function renderAuthRegister(wrap){
  const s=_authState;
  const rf=s.regF;
  const card=h('div',{class:'gc',style:{width:'100%',padding:'24px 18px',borderRadius:'var(--rad)'}});
  card.appendChild(h('div',{style:{fontSize:'22px',fontStyle:'italic',textAlign:'center',marginBottom:'3px',color:'var(--t1)'}},'Create Account'));
  card.appendChild(h('div',{style:{fontSize:'10px',color:'var(--t2)',letterSpacing:'2px',textAlign:'center',marginBottom:'20px',textTransform:'uppercase'}},'Verify your email'));
  if(s.err)card.appendChild(h('div',{class:'err'},s.err));

  const fields=[
    {lbl:'Full Name ‚ú¶',key:'name',type:'text',ph:'Your full name'},
    {lbl:'Firm / Company ‚ú¶',key:'ferm',type:'text',ph:'Your company name'},
    {lbl:'Mobile Number ‚ú¶',key:'mob',type:'tel',ph:'10-digit mobile'},
    {lbl:'Email ‚ú¶',key:'email',type:'email',ph:'your@email.com'},
    {lbl:'Password ‚ú¶',key:'pass',type:'password',ph:'Min 6 characters'},
  ];
  fields.forEach(f=>{
    const inp=h('input',{class:'inp','data-key':f.key,type:f.type,placeholder:f.ph,value:rf[f.key]||''});
    inp.addEventListener('input',e=>{rf[f.key]=e.target.value;});
    card.appendChild(h('div',{class:'ig'},h('label',{class:'il'},f.lbl),inp));
  });
  card.appendChild(stayCheckbox(s.stayIn,()=>{s.stayIn=!s.stayIn;renderNow();}));
  card.appendChild(h('button',{class:'btn btn-g',style:{marginTop:'6px'},onClick:doRegister},'GET VERIFICATION CODE'));
  card.appendChild(h('button',{class:'btn btn-ol',onClick:()=>{s.mode='login';s.err='';renderNow();}},'‚Üê Back to Sign In'));
  wrap.appendChild(card);
  return wrap;
}

async function doRegister(){
  const s=_authState; const rf=s.regF;
  // Read all input fields freshly to avoid stale values
  const inputs=document.querySelectorAll('.inp:not([type=password])');
  const allInps=document.querySelectorAll('.inp');
  // Try named inputs first (more reliable), fallback to positional
  rf.name=(document.querySelector('.inp[data-key=name]')?.value||allInps[0]?.value||rf.name||'').trim();
  rf.ferm=(document.querySelector('.inp[data-key=ferm]')?.value||allInps[1]?.value||rf.ferm||'').trim();
  rf.mob=(document.querySelector('.inp[data-key=mob]')?.value||allInps[2]?.value||rf.mob||'').trim();
  rf.email=(document.querySelector('.inp[data-key=email]')?.value||allInps[3]?.value||rf.email||'').trim();
  rf.pass=(document.querySelector('.inp[data-key=pass]')?.value||allInps[4]?.value||rf.pass||'').trim();
  if(!rf.name||!rf.ferm||!rf.mob||!rf.email||!rf.pass){s.err='All fields required.';renderNow();return;}
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(rf.email)){s.err='Valid email required.';renderNow();return;}
  if(rf.pass.length<6){s.err='Password must be 6+ characters.';renderNow();return;}

  const svcId=LS.get('ejs_svc')||'';
  const tplId=LS.get('ejs_tpl')||'';
  const pubKey=LS.get('ejs_key')||'';

  s.genOTP=genOTP();
  s.otp=['','','','','',''];
  s.otpSent=false;
  s.err='';

  // If EmailJS not configured ‚Äî show OTP on screen (dev/fallback mode)
  if(!svcId||!tplId||!pubKey){
    s.otpSent=false;
    s.mode='otp';
    renderNow();
    return;
  }

  // Send OTP via EmailJS ‚Äî wait up to 5s for library to load
  s.loading=true; s.err=''; renderNow();
  try{
    // Wait for emailjs library (up to 5 seconds)
    let waited=0;
    while(!window.emailjs && waited<5000){ await new Promise(r=>setTimeout(r,200)); waited+=200; }
    if(!window.emailjs) throw new Error('EmailJS library failed to load. Check internet connection.');
    // Init with public key (safe to call multiple times)
    window.emailjs.init({publicKey:pubKey});
    await window.emailjs.send(svcId, tplId, {
      to_email: rf.email,
      to_name:  rf.name,
      otp_code: s.genOTP,
      app_name: 'Suresh Millgin Stores'
    });
    s.otpSent=true;
    s.okMsg='‚úì Code sent to '+rf.email;
  }catch(e){
    // Show real error so admin can debug ‚Äî don't silently fall back
    s.otpSent=false;
    s.err='Email failed: '+(e?.message||e?.text||'Check EmailJS dashboard for errors.');
    s.loading=false; renderNow(); return;
  }
  s.otpExpiry=Date.now()+(10*60*1000); // 10 min expiry
  s.loading=false;
  s.mode='otp';
  renderNow();
}

function renderAuthOTP(wrap){
  const s=_authState;
  const card=h('div',{class:'gc',style:{width:'100%',padding:'24px 18px',borderRadius:'var(--rad)'}});
  card.appendChild(h('div',{style:{fontSize:'22px',fontStyle:'italic',textAlign:'center',marginBottom:'5px',color:'var(--t1)'}},'Verify Email'));
  card.appendChild(h('div',{style:{fontSize:'11px',color:'var(--t2)',textAlign:'center',marginBottom:'14px',lineHeight:'1.7'}},'Verification code for ',h('strong',{style:{color:'var(--g)'}},s.regF.email)));
  if(s.err)card.appendChild(h('div',{class:'err'},s.err));
  if(s.okMsg)card.appendChild(h('div',{class:'ok-msg'},s.okMsg));
  // Code display ‚Äî hide if sent via real email, show if fallback mode
  if(s.otpSent){
    card.appendChild(h('div',{style:{background:'rgba(30,122,70,.08)',border:'1px solid rgba(30,122,70,.25)',borderRadius:'var(--rsm)',padding:'14px 12px',textAlign:'center',marginBottom:'16px'}},
      h('div',{style:{fontSize:'13px',color:'#3ecf7a',fontWeight:'700',marginBottom:'4px'}},'üìß Code Sent to Your Email'),
      h('div',{style:{fontSize:'11px',color:'var(--t2)',lineHeight:'1.6'}},'Check your inbox for a 6-digit code from Suresh Millgin Stores. Check spam if not found.'),
      ...(s.otpExpiry?[h('div',{style:{fontSize:'10px',color:'var(--t2)',marginTop:'5px'}},'Code expires in 10 minutes')]:[])
    ));
  } else {
    // Fallback ‚Äî EmailJS not set up, show code on screen
    card.appendChild(h('div',{style:{background:'rgba(212,175,55,.07)',border:'1px solid var(--gb)',borderRadius:'var(--rsm)',padding:'14px 12px',textAlign:'center',marginBottom:'16px'}},
      h('div',{style:{fontSize:'9px',color:'var(--t2)',letterSpacing:'2px',marginBottom:'5px',textTransform:'uppercase'}},'Your Code (Email not configured)'),
      h('div',{style:{fontSize:'36px',fontWeight:'900',color:'var(--g)',letterSpacing:'10px',lineHeight:'1'}},s.genOTP),
      h('div',{style:{fontSize:'9px',color:'var(--t2)',marginTop:'5px'}},'Set up EmailJS in Admin ‚Üí DB tab to send real emails')
    ));
  }
  // OTP inputs
  const otpRow=h('div',{style:{display:'flex',gap:'7px',justifyContent:'center',marginBottom:'16px'}});
  const refs=[];
  for(let i=0;i<6;i++){
    const inp=h('input',{class:'otp-box',inputmode:'numeric',maxlength:'1',value:s.otp[i]||''});
    inp.addEventListener('input',e=>{
      const v=e.target.value.replace(/\D/,'');
      e.target.value=v; s.otp[i]=v;
      if(v&&i<5)refs[i+1]?.focus();
    });
    inp.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!s.otp[i]&&i>0)refs[i-1]?.focus();});
    refs.push(inp); otpRow.appendChild(inp);
  }
  card.appendChild(otpRow);
  card.appendChild(h('button',{class:'btn btn-g',onClick:doVerifyOTP},'VERIFY & ENTER'));
  card.appendChild(h('button',{class:'btn btn-ol',onClick:async()=>{
    s.genOTP=genOTP();s.otp=['','','','','',''];
    const svcId=LS.get('ejs_svc')||'';const tplId=LS.get('ejs_tpl')||'';const pubKey=LS.get('ejs_key')||'';
    if(svcId&&tplId&&pubKey){
      try{
        let w=0;while(!window.emailjs&&w<5000){await new Promise(r=>setTimeout(r,200));w+=200;}
        if(!window.emailjs)throw new Error('EmailJS not loaded');
        window.emailjs.init({publicKey:pubKey});
        await window.emailjs.send(svcId,tplId,{to_email:s.regF.email,to_name:s.regF.name,otp_code:s.genOTP,app_name:'Suresh Millgin Stores'});
        s.otpSent=true;s.okMsg='‚úì New code sent to '+s.regF.email;
      }catch(e){s.otpSent=false;s.err='Email failed: '+(e?.message||'Check EmailJS dashboard');}
    } else {s.otpSent=false;s.okMsg='New code generated!';}
    s.otpExpiry=Date.now()+(10*60*1000);
    setTimeout(()=>{s.okMsg='';renderNow();},3000);renderNow();
  }},'üîÑ Resend Code'));
  card.appendChild(h('button',{class:'btn btn-ol',style:{marginTop:'6px'},onClick:()=>{s.mode='register';s.err='';renderNow();}},'‚Üê Change Details'));
  wrap.appendChild(card);
  return wrap;
}

async function doVerifyOTP(){
  const s=_authState;
  const entered=Array.from(document.querySelectorAll('.otp-box')).map(i=>i.value).join('');
  if(entered.length!==6){s.err='Enter all 6 digits.';renderNow();return;}
  // Check expiry if OTP was sent via email
  if(s.otpExpiry&&Date.now()>s.otpExpiry){s.err='Code expired. Please request a new one.';s.otp=['','','','','',''];renderNow();return;}
  if(entered!==s.genOTP){s.err='Wrong code. Try again.';s.otp=['','','','','',''];renderNow();return;}
  const u={name:s.regF.name,ferm:s.regF.ferm,mob:s.regF.mob,email:s.regF.email};
  if(s.stayIn)LS.set(KEY_SESSION,{role:'user',user:u,ts:Date.now()});
  APP.user=u;APP.role='user';
  const passMasked='‚Ä¢'.repeat(Math.min(s.regF.pass.length,8));
  // Save to users table for admin user management
  // Use deterministic id from email so upsert deduplicates across multiple registrations
  const _regId='u_'+btoa(u.email).replace(/[^a-z0-9]/gi,'').slice(0,20);
  DB.saveUser({id:_regId,name:u.name,firm:u.ferm,mobile:u.mob,email:u.email,registered_at:new Date().toISOString(),ip:APP.ip}).catch(()=>{});
  DB.addLog({id:uid(),user_name:u.name,firm:u.ferm,mobile:u.mob,email:u.email,pass_masked:passMasked,ip:APP.ip,logged_at:new Date().toISOString()});
  DB.addAudit({id:uid(),event:'New Registration',user_email:u.email,ip:APP.ip,logged_at:new Date().toISOString()});
  // Phase 1: IDB cache ‚Äî navigate instantly
  const [_rc,_rp,_rn]=await Promise.all([IDB.getAll('cats'),IDB.getAll('prods'),IDB.getAll('notifs')]);
  if(_rc.length){APP.cats=_rc;APP.prods=_rp;APP.notifs=_rn;}
  go('user');
  // Phase 2: background network sync
  loadAllUser().catch(()=>{});
}

async function loadAllUser(){
  // IDB already loaded in login ‚Äî go straight to network refresh
  // Phase 2: refresh from network in background
  const [c,p,n]=await Promise.all([DB.getCats(),DB.getProds(),DB.getNotifs()]);
  APP.cats=c||[];APP.prods=p||[];APP.notifs=n||[];
  IDB.putAll('cats',APP.cats);IDB.putAll('prods',APP.prods);IDB.putAll('notifs',APP.notifs);
  renderNow();
  // Phase 3: RT subscriptions via _startRealtimeSubs() (stable handlers, below)
  // Load user's own chat history from IDB
  const cachedChats=await IDB.getAll('chats');
  const myChats=cachedChats.filter(m=>m.user_email===APP.user?.email);
  if(myChats.length){
    APP.chats=myChats.sort((a,b)=>(a.sent_at||'').localeCompare(b.sent_at||''));
    renderNow();
  }
  // Background sync ‚Äî fetch ONLY this user's chats (not all 1000 users!)
  if(_sb&&APP.user?.email){
    try{
      const myFresh=await _sb.sel('sms_chats','user_email=eq.'+encodeURIComponent(APP.user.email),'sent_at.asc');
      if(myFresh?.length){
        APP.chats=myFresh.sort((a,b)=>(a.sent_at||'').localeCompare(b.sent_at||''));
        IDB.putAll('chats',myFresh.slice(-10000));
        renderNow();
      }
    }catch{}
  }
  // ‚îÄ‚îÄ Pre-cache product images into IDB for instant offline display ‚îÄ‚îÄ
  _precacheImages();

  // Start Realtime + poll (stable handlers, dedup-safe)
  if(_sb)RT.init(_sb.base,_sb.h.apikey);
  _startRealtimeSubs();
  _startSmartPoll();
}

async function loadAllAdmin(){
  // Phase 1: IDB cache for instant display
  const [ic,ip,ich,in_,ius,iaud,ivw]=await Promise.all([
    IDB.getAll('cats'),IDB.getAll('prods'),IDB.getAll('chats'),IDB.getAll('notifs'),
    IDB.getAll('users'),IDB.getAll('audit'),IDB.getAll('views')
  ]);
  if(ich.length||ic.length){
    APP.cats=ic;APP.prods=ip;
    APP.chats=ich.sort((a,b)=>(a.sent_at||'').localeCompare(b.sent_at||''));
    APP.notifs=in_;APP.users=ius;
    if(iaud.length)APP.audit=iaud;
    if(ivw.length)APP.views=ivw;
    renderNow();
  }
  // Phase 2: network fetch in parallel
  const [c,p,ch,a,v,n,lg,us]=await Promise.all([
    DB.getCats(),DB.getProds(),DB.getChats(),DB.getAudit(),
    DB.getAllViews(),DB.getNotifs(),DB.getLogs(),DB.getUsers()
  ]);
  APP.cats=c||[];APP.prods=p||[];
  // Merge chats: keep optimistic local msgs not yet in DB
  const dbIds=new Set((ch||[]).map(m=>m.id));
  const localOnly=(APP.chats||[]).filter(m=>!dbIds.has(m.id)&&(Date.now()-new Date(m.sent_at).getTime())<30000);
  APP.chats=[...(ch||[]),...localOnly].sort((a,b)=>(a.sent_at||'').localeCompare(b.sent_at||''));
  APP.audit=a||[];APP.views=v||[];APP.notifs=n||[];APP.logs=lg||[];APP.users=us||[];
  // Update IDB cache
  IDB.putAll('cats',APP.cats);IDB.putAll('prods',APP.prods);
  IDB.putAll('chats',APP.chats.slice(-50000));// keep last 2000 msgs
  IDB.putAll('notifs',APP.notifs);IDB.putAll('users',APP.users);
  IDB.putAll('views',APP.views.slice(-100000));IDB.putAll('audit',APP.audit.slice(-25000));
  renderNow();
  // Phase 3: live subscriptions + fallback poll
  if(_sb)RT.init(_sb.base,_sb.h.apikey); // ensure WS is up
  _startRealtimeSubs();
  _startSmartPoll();
}

// Smart poll fallback: if RT not connected after 5s, poll lightly
let _smartPollTimer=null;
function _startSmartPoll(){
  if(_smartPollTimer)return;
  _smartPollTimer=setInterval(async()=>{
    if(RT.isConnected())return; // RT working ‚Äî skip poll
    if(APP.screen==='user'&&APP.tab==='enquire'&&APP.user?.email){
      // Only fetch this user's chat ‚Äî very cheap
      try{
        const fresh=await _sb?.sel('sms_chats','user_email=eq.'+encodeURIComponent(APP.user.email),'sent_at.asc').catch(()=>[]);
        if(fresh?.length){
          const before=APP.chats.length;
          const ids=new Set((APP.chats||[]).map(m=>m.id));
          const newMsgs=fresh.filter(m=>!ids.has(m.id));
          if(newMsgs.length){APP.chats=[...(APP.chats||[]),...newMsgs];renderNow();}
        }
      }catch{}
    } else if(APP.screen==='admin'&&APP.atab==='activity'){
      try{
        const [v,a]=await Promise.all([DB.getAllViews(),DB.getAudit()]);
        if(v?.length){APP.views=v;IDB.putAll('views',v.slice(-20000));}
        if(a?.length){APP.audit=a;IDB.putAll('audit',a.slice(-5000));}
        renderNow();
      }catch{}
    } else if(APP.screen==='admin'&&APP.atab==='chats'){
      // Admin: fetch only last 50 msgs
      try{
        const fresh=await _sb?.req('sms_chats?select=*&order=sent_at.desc&limit=50').catch(()=>[]);
        if(fresh?.length){
          const ids=new Set((APP.chats||[]).map(m=>m.id));
          const newMsgs=fresh.filter(m=>!ids.has(m.id));
          if(newMsgs.length){APP.chats=[...(APP.chats||[]),...newMsgs].sort((a,b)=>(a.sent_at||'').localeCompare(b.sent_at||''));renderNow();}
        }
      }catch{}
    }
  }, 10000); // 10 second fallback ‚Äî gentle on DB, RT handles realtime
}

let _rtSubsStarted=false;

// ‚îÄ‚îÄ STABLE RT HANDLERS (named functions = same ref = no duplicate registration) ‚îÄ‚îÄ
function _rtOnChat(evt,rec){
  if(!rec)return;
  // User-side: only handle own messages
  if(APP.screen==='user'){
    if(!APP.user?.email||rec.user_email!==APP.user.email)return;
  }
  if(evt==='INSERT'){
    if((APP.chats||[]).some(m=>m.id===rec.id))return; // dedup optimistic
    if(typeof _pendingMsgIds!=='undefined'&&_pendingMsgIds.has(rec.id))return; // dedup pending
    APP.chats=[...(APP.chats||[]),rec].sort((a,b)=>(a.sent_at||'').localeCompare(b.sent_at||''));
    IDB.putOne('chats',rec);
    if(APP.screen==='user'&&APP.tab!=='enquire'&&rec.sender==='admin'){
      APP._newAdminMsg=(APP._newAdminMsg||0)+1; // badge
    }
    render(); // use debounced render ‚Äî prevents rapid-fire blink from burst of RT events
    requestAnimationFrame(()=>{
      document.querySelectorAll('.adm-msgs,.chat-msgs,.msg-list').forEach(el=>{el.scrollTop=el.scrollHeight;});
    });
  } else if(evt==='UPDATE'){
    APP.chats=(APP.chats||[]).map(m=>m.id===rec.id?{...m,...rec}:m);
    IDB.putOne('chats',rec);
    render(); // debounce RT updates
  } else if(evt==='DELETE'){
    APP.chats=(APP.chats||[]).filter(m=>m.id!==rec.id);
    renderNow();
  }
}
function _rtOnUser(evt,rec){
  if(evt==='INSERT'&&rec&&!(APP.users||[]).some(u=>u.id===rec.id)){
    APP.users=[rec,...(APP.users||[])];
    IDB.putOne('users',rec);
    if(APP.screen==='admin'&&APP.atab==='users')renderNow();
  }
}
function _rtOnNotif(evt,rec){
  if(evt==='INSERT'&&rec){APP.notifs=[rec,...(APP.notifs||[])];IDB.putOne('notifs',rec);renderNow();}
  else if(evt==='DELETE'&&rec){APP.notifs=(APP.notifs||[]).filter(n=>n.id!==rec.id);renderNow();}
}

// ‚îÄ‚îÄ REQUEST 100MB PERSISTENT STORAGE QUOTA ‚îÄ‚îÄ
async function requestStorageQuota(){
  try{
    if(navigator.storage&&navigator.storage.persist)await navigator.storage.persist();
    if(navigator.webkitTemporaryStorage&&navigator.webkitTemporaryStorage.requestQuota){
      navigator.webkitTemporaryStorage.requestQuota(1024*1024*1024,()=>{},()=>{});
    }
  }catch{}
}

// ‚îÄ‚îÄ IMAGE PRE-CACHER ‚Äî fetches product images and caches as base64 ‚îÄ‚îÄ
async function _precacheImages(){
  try{
    const prods=APP.prods||[];
    const cached=await IDB.getAll('images');
    const cachedIds=new Set(cached.map(x=>x.id));
    // Only fetch images we don't have yet
    const toFetch=prods.filter(p=>p.images?.length&&!cachedIds.has('img_'+p.id));
    if(!toFetch.length)return;
    // Fetch in small batches of 3 to not hammer network
    for(let i=0;i<Math.min(toFetch.length,30);i+=3){
      const batch=toFetch.slice(i,i+3);
      await Promise.allSettled(batch.map(async p=>{
        try{
          const url=p.images[0];
          if(!url||url.startsWith('data:'))return; // already base64
          const res=await fetch(url,{mode:'no-cors'});
          if(!res.ok)return;
          const blob=await res.blob();
          const b64=await new Promise(r=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(blob);});
          await IDB.putOne('images',{id:'img_'+p.id,prodId:p.id,url,b64,ts:Date.now()});
        }catch{}
      }));
      // Small delay between batches to not block UI
      await new Promise(r=>setTimeout(r,200));
    }
  }catch{}
}

// ‚îÄ‚îÄ PREFETCH SYSTEM ‚Äî load next likely data before user needs it ‚îÄ‚îÄ
let _prefetchTimer=null;
// ‚îÄ‚îÄ OFFLINE QUEUE PROCESSOR ‚îÄ‚îÄ
let _onlineHandler=null;
function startOfflineQueueProcessor(){
  if(_onlineHandler)return;
  _onlineHandler=async()=>{
    if(!navigator.onLine)return;
    await IDB.flushOfflineQueue(async(action)=>{
      try{
        if(action.type==='chat')await DB.addChat(action.data);
        else if(action.type==='view')await DB.addView(action.data);
        else if(action.type==='log')await DB.addLog(action.data);
        else if(action.type==='audit')await DB.addAudit(action.data);
      }catch{}
    });
  };
  window.addEventListener('online',_onlineHandler);
  if(navigator.onLine)setTimeout(_onlineHandler,1000);
}

function schedulePrefetch(delay=30000){
  clearTimeout(_prefetchTimer);
  _prefetchTimer=setTimeout(async()=>{
    if(!APP.sbOn||!navigator.onLine)return;
    try{
      // Silently refresh all data in background every 30s
      const fresh=await Promise.allSettled([
        DB.getCats(),DB.getProds(),DB.getNotifs()
      ]);
      if(fresh[0].value?.length){APP.cats=fresh[0].value;IDB.putAll('cats',APP.cats);}
      if(fresh[1].value?.length){APP.prods=fresh[1].value;IDB.putAll('prods',APP.prods);}
      if(fresh[2].value?.length){APP.notifs=fresh[2].value;IDB.putAll('notifs',APP.notifs);}
      renderNow();
    }catch{}
    schedulePrefetch(30000); // schedule next refresh
  },delay);
}

function _startRealtimeSubs(){
  if(_rtSubsStarted)return;
  _rtSubsStarted=true;
  // Stable named handlers ‚Äî safe across multiple logins, RT.on() deduplicates by reference
  RT.on('sms_chats', _rtOnChat);
  RT.on('sms_users', _rtOnUser);
  RT.on('sms_notifs', _rtOnNotif);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USER APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const USER_TABS=[{id:'home',icon:'üè†',label:'HOME'},{id:'enquire',icon:'üí¨',label:'ENQUIRE'},{id:'notif',icon:'üîî',label:'ALERTS'},{id:'profile',icon:'üë§',label:'PROFILE'}];

function renderUser(){
  const wrap=h('div',{class:'page fade-in',style:{flexDirection:'column',overflow:'hidden'}});
  const content=h('div',{style:{flex:'1',overflow:'hidden',position:'relative',display:'flex',flexDirection:'column'}});
  switch(APP.tab){
    case 'home': content.appendChild(renderUserHome()); break;
    case 'enquire': content.appendChild(renderUserChat()); break;
    case 'notif': content.appendChild(renderUserNotifs()); break;
    case 'profile': content.appendChild(renderUserProfile()); break;
    default: content.appendChild(renderUserHome());
  }
  // Product detail overlay
  if(APP.detailProd){
    content.appendChild(renderProductDetail());
  }
  wrap.appendChild(content);
  // Bottom nav
  const unread=APP.notifs.filter(n=>!LS.get(KEY_NR,[]).find(r=>r.nid===n.id&&r.email===APP.user?.email)).length;
  const nav=h('div',{class:'bnav'});
  USER_TABS.forEach(t=>{
    const bn=h('div',{class:'bn '+(APP.tab===t.id?'on':''),onClick:()=>{APP.tab=t.id;renderNow();}},
      h('div',{class:'bn-i'},t.icon),
      h('div',{class:'bn-l'},t.label)
    );
    if(t.id==='notif'&&unread>0)bn.appendChild(h('div',{class:'bn-badge'},unread>9?'9+':unread));
    nav.appendChild(bn);
  });
  wrap.appendChild(nav);
  return wrap;
}

function renderUserHome(){
  const cats=APP.cats.filter(c=>!c.parent_id);
  const allSubs=APP.cats.filter(c=>c.parent_id===APP.selCat);
  const wrap=h('div',{class:'page',style:{overflowY:'auto',flex:'1'}});
  // Header
  wrap.appendChild(h('div',{class:'hdr'},
    h('div',{class:'hdr-title'},'Suresh Millgin'),
    APP.sbOn?h('span',{style:{fontSize:'8px',color:'#3ecf7a',border:'1px solid rgba(62,207,122,.3)',padding:'2px 7px',borderRadius:'3px',fontWeight:'700'}},'‚òÅ CLOUD'):
             h('span',{style:{fontSize:'8px',color:'var(--t2)',border:'1px solid var(--glb)',padding:'2px 7px',borderRadius:'3px',fontWeight:'700'}},'üì± LOCAL')
  ));
  // Hero
  wrap.appendChild(h('div',{style:{padding:'16px 16px 12px',borderBottom:'1px solid var(--glb)'}},
    h('div',{style:{fontSize:'22px',fontWeight:'900',color:'var(--g)',letterSpacing:'3px',textTransform:'uppercase',lineHeight:'1'}},'Suresh Millgin Stores'),
    h('div',{style:{fontStyle:'italic',color:'var(--s)',fontSize:'12px',marginTop:'3px'}},'Premium Loom Machinery Spare Parts'),
    h('div',{style:{fontSize:'9px',color:'var(--t2)',letterSpacing:'3px',marginTop:'2px',textTransform:'uppercase'}},'Est. 2004')
  ));
  // ‚îÄ‚îÄ SMART RECOMMENDATIONS ‚îÄ‚îÄ
  if(APP.user){
    const _allV=APP.views.length?APP.views:LS.get(KEY_VH,[]);
    const userViews=_allV.filter(v=>v.user_email===APP.user.email);
    if(userViews.length>0){
      // Count category frequency from view history
      const catFreq={};
      userViews.forEach(v=>{ const cat=v.prod_cat||''; if(cat)catFreq[cat]=(catFreq[cat]||0)+1; });
      const topCats=Object.entries(catFreq).sort((a,b)=>b[1]-a[1]).slice(0,3).map(e=>e[0]);
      const viewedIds=new Set(userViews.map(v=>v.prod_id));
      // Find products in those top categories that user hasn't viewed yet
      let recs=APP.prods.filter(p=>{
        const cats=p.category_ids||[];
        return topCats.some(cat=>cats.includes(cat)||p.category_id===cat) && !viewedIds.has(p.id);
      }).slice(0,6);
      // If fewer than 3, fill with recently viewed products (deduped)
      if(recs.length<3){
        const recentViewed=[...new Map(userViews.map(v=>[v.prod_id,v])).values()].slice(0,6);
        const recentProds=recentViewed.map(v=>APP.prods.find(p=>p.id===v.prod_id)).filter(Boolean);
        const existing=new Set(recs.map(p=>p.id));
        recentProds.forEach(p=>{if(!existing.has(p.id))recs.push(p);});
        recs=recs.slice(0,6);
      }
      if(recs.length>0){
        wrap.appendChild(h('div',{class:'sec-hd'},h('div',{class:'sec-title'},'‚ú¶ Recommended For You')));
        const recRow=h('div',{class:'rec-row'});
        recs.forEach(prod=>{
          const firstImg=(prod.images||[])[0];
          const card=h('div',{class:'rec-card',onClick:()=>openProduct(prod)},
            h('div',{class:'rec-img'},firstImg?'':prod.icon||'üì¶'),
            h('div',{class:'rec-body'},
              h('div',{class:'rec-name'},prod.name),
              prod.price_on_request
                ?h('div',{class:'rec-price na'},'Price on Request')
                :h('div',{class:'rec-price'},prod.price?'‚Çπ'+prod.price:'‚Äî')
            )
          );
          if(firstImg){const ri=card.querySelector('.rec-img');const img=document.createElement('img');img.src=firstImg;img.style.cssText='width:100%;height:100%;object-fit:cover;display:block';ri.appendChild(img);}
          recRow.appendChild(card);
        });
        wrap.appendChild(recRow);
      }
    }
  }
  // Search
  const si=h('input',{class:'srch-inp',type:'text',placeholder:'Search products‚Ä¶',value:APP.searchQ||''});
  si.addEventListener('input',e=>{APP.searchQ=e.target.value;updateProdList();});
  wrap.appendChild(h('div',{class:'srch-wrap'},h('div',{class:'srch-in'},si)));
  // Categories
  if(cats.length>0){
    wrap.appendChild(h('div',{class:'sec-hd'},h('div',{class:'sec-title'},'Categories')));
    const cRow=h('div',{class:'cat-row'});
    const allCard=h('div',{class:'cat-card '+(APP.selCat===null?'on':''),onClick:()=>{APP.selCat=null;APP.selSub=null;updateProdList();}},
      h('div',{class:'cat-ph',style:{height:'72px',fontSize:'22px'}},'‚öôÔ∏è'),
      h('div',{class:'cat-lbl'},h('div',{class:'cat-lbl-name'},'All'),h('div',{class:'cat-lbl-ct'},APP.prods.length+' items'))
    );
    cRow.appendChild(allCard);
    cats.forEach(cat=>{
      const cnt=APP.prods.filter(p=>(p.category_ids||[]).includes(cat.id)|| p.category_id===cat.id).length;
      const card=h('div',{class:'cat-card '+(APP.selCat===cat.id?'on':''),onClick:()=>{APP.selCat=cat.id;APP.selSub=null;updateProdList();}},
        h('div',{class:'cat-ph',style:{height:'72px',fontSize:'22px'}},cat.image_url||cat.image?'':cat.icon||'üì¶'),
        h('div',{class:'cat-lbl'},h('div',{class:'cat-lbl-name'},cat.name),h('div',{class:'cat-lbl-ct'},cnt+' items'))
      );
      if(cat.image_url||cat.image){
        const catPh=card.querySelector('.cat-ph');
        catPh.innerHTML='';
        const img=document.createElement('img');img.src=cat.image_url||cat.image;img.style.cssText='width:100%;height:100%;object-fit:cover';
        catPh.appendChild(img);
      }
      cRow.appendChild(card);
    });
    wrap.appendChild(cRow);
    // Subcats
    if(APP.selCat&&allSubs.length>0){
      const sRow=h('div',{class:'sub-row'});
      sRow.appendChild(h('div',{class:'sub-chip '+(APP.selSub===null?'on':''),onClick:()=>{APP.selSub=null;updateProdList();}}, 'All'));
      allSubs.forEach(s=>sRow.appendChild(h('div',{class:'sub-chip '+(APP.selSub===s.id?'on':''),onClick:()=>{APP.selSub=s.id;updateProdList();}},s.name)));
      wrap.appendChild(sRow);
    }
  }
  // Products section title
  wrap.appendChild(h('div',{class:'sec-hd'},
    h('div',{class:'sec-title'},'Products'),
    h('div',{style:{fontSize:'10px',color:'var(--t2)'}},getFilteredProds().length+' items')
  ));
  // Product list
  const pl=h('div',{class:'prod-list',id:'prod-list'});
  renderProdList(pl);
  wrap.appendChild(pl);
  return wrap;
}

function getFilteredProds(){
  let p=APP.prods;
  if(APP.searchQ){const q=APP.searchQ.toLowerCase();p=p.filter(pr=>(pr.name||'').toLowerCase().includes(q)||(pr.description||'').toLowerCase().includes(q));}
  if(APP.selCat){
    p=p.filter(pr=>(pr.category_ids||[]).includes(APP.selCat)||(pr.sub_category_ids||[]).includes(APP.selCat)||pr.category_id===APP.selCat);
    if(APP.selSub)p=p.filter(pr=>(pr.sub_category_ids||[]).includes(APP.selSub)||(pr.category_ids||[]).includes(APP.selSub));
  }
  return p;
}

function renderProdList(pl){
  pl.innerHTML='';
  const fp=getFilteredProds();
  if(fp.length===0){
    pl.appendChild(h('div',{class:'empty'},h('div',{class:'ei'},'üì¶'),h('div',{class:'et'},'No products found'),h('div',{class:'es'},'Try a different category or search term')));
    return;
  }
  fp.forEach(prod=>{
    const row=h('div',{class:'prod-row',onClick:()=>openProduct(prod)},
      h('div',{class:'pthumb'},prod.images?.[0]?'':''),
      h('div',{class:'pbody'},
        h('div',{class:'pcat'},getCatName(prod.category_ids?.[0]||prod.category_id)||'Product'),
        h('div',{class:'pname'},prod.name||'Unnamed'),
        h('div',{class:'pprice'},prod.price_on_request?'Price on request':prod.price?'‚Çπ'+prod.price:'‚Äî')
      )
    );
    if(prod.images?.[0]){
      const th=row.querySelector('.pthumb');
      const img=document.createElement('img');img.src=prod.images[0];img.style.cssText='width:100%;height:100%;object-fit:cover';
      th.appendChild(img);
    } else {
      row.querySelector('.pthumb').textContent=prod.icon||'üì¶';
    }
    pl.appendChild(row);
  });
}

function updateProdList(){
  renderNow();
}

function getCatName(id){
  return APP.cats.find(c=>c.id===id)?.name||'';
}

function openProduct(prod){
  APP.detailProd=prod;
  APP.detailCatIdx=0;
  renderNow();
  // Track view
  if(APP.user){
    DB.addView({id:uid(),prod_id:prod.id,prod_name:prod.name,prod_cat:prod.category_ids?.[0]||prod.category_id||'',user_email:APP.user.email,viewed_at:new Date().toISOString()}).catch(()=>{});
  }
}

function renderProductDetail(){
  const prod=APP.detailProd;
  const imgs=prod.images||[];
  let curImg=0;

  const wrap=h('div',{class:'pd-wrap'},
    h('div',{class:'hdr'},
      h('button',{class:'hdr-back',onClick:()=>{APP.detailProd=null;renderNow();}},'‚Üê'),
      h('div',{class:'hdr-title',style:{flex:'1',textAlign:'center',fontSize:'13px'}},prod.name||'Product'),
      h('div',{style:{width:'40px'}})
    )
  );
  const scr=h('div',{class:'pd-scr'});
  // Carousel
  const crl=h('div',{class:'crl'});
  const mainImg=h('div',{class:'crl-main'});
  if(imgs.length>0){
    const img=document.createElement('img');img.src=imgs[0];img.style.cssText='width:100%;height:100%;object-fit:contain';
    mainImg.appendChild(img);
  } else {
    mainImg.style.cssText='display:flex;align-items:center;justify-content:center;font-size:60px;height:250px;background:var(--c3)';
    mainImg.textContent=prod.icon||'üì¶';
  }
  crl.appendChild(mainImg);
  if(imgs.length>1){
    const dots=h('div',{class:'crl-dots'});
    imgs.forEach((_,i)=>dots.appendChild(h('div',{class:'cdot '+(i===0?'on':'')})));
    crl.appendChild(dots);
    const thumbs=h('div',{class:'crl-thumbs'});
    imgs.forEach((img,i)=>{
      const tb=h('div',{class:'crl-tb '+(i===0?'on':'')});
      const tImg=document.createElement('img');tImg.src=img;tImg.style.cssText='width:100%;height:100%;object-fit:cover';
      tb.appendChild(tImg);
      tb.addEventListener('click',()=>{
        curImg=i;APP.detailCatIdx=i;
        const mImg=mainImg.querySelector('img');if(mImg)mImg.src=imgs[i];
        thumbs.querySelectorAll('.crl-tb').forEach((t,j)=>t.classList.toggle('on',j===i));
        dots.querySelectorAll('.cdot').forEach((d,j)=>d.classList.toggle('on',j===i));
      });
      thumbs.appendChild(tb);
    });
    scr.appendChild(thumbs);
  }
  scr.insertBefore(crl,scr.firstChild); // carousel at top

  // Video
  if(prod.video){
    const vp=h('div',{class:'vid-player'});
    const v=document.createElement('video');v.src=prod.video;v.controls=true;v.style.cssText='width:100%;max-height:260px;display:block;object-fit:contain';
    vp.appendChild(v);
    scr.appendChild(h('div',{style:{padding:'8px 16px 0'}},h('div',{style:{fontSize:'9px',color:'var(--g)',letterSpacing:'2px',fontWeight:'700'}},'üé¨ PRODUCT VIDEO')));
    scr.appendChild(vp);
  }

  // Info
  const catName=getCatName(prod.category_ids?.[0]||prod.category_id);
  scr.appendChild(h('div',{class:'pd-info'},
    catName?h('div',{class:'pd-cat'},catName):'',
    h('div',{class:'pd-name'},prod.name||'Product'),
    h('div',{class:'pd-price',style:prod.price_on_request?{fontStyle:'italic',color:'var(--s)',fontSize:'16px'}:{}},
      prod.price_on_request?'Price on Request':prod.price?'‚Çπ'+prod.price:'Price Unavailable'),
    h('div',{class:'pd-hr'}),
    prod.description?h('div',{class:'pd-desc'},prod.description):''
  ));
  wrap.appendChild(scr);

  // Actions
  wrap.appendChild(h('div',{class:'pd-acts'},
    h('button',{class:'btn btn-ol btn-sm',style:{flex:'1',marginTop:'0'},onClick:()=>{APP.detailProd=null;renderNow();}},'‚Üê Back'),
    h('button',{class:'btn btn-g btn-sm',style:{flex:'2'},onClick:()=>{APP.detailProd=null;APP.tab='enquire';renderNow();}},'üì© ENQUIRE NOW')
  ));
  return wrap;
}

// ‚îÄ‚îÄ USER CHAT ‚îÄ‚îÄ
let _userChat={text:'',recording:false,recSecs:0,recTimer:null,mediaRecorder:null,chunks:[],recBytes:0,audioCtx:null,analyser:null,waveRaf:null,waveTimer:null,waveVals:new Array(20).fill(4),recordedBlob:null,recordedDur:0,stream:null};

// ‚îÄ‚îÄ Shared msg renderer with long-press delete ‚îÄ‚îÄ
function _showMsgPopup(e, m, isAdmin){
  // Remove any existing popup
  document.querySelector('.msg-popup-overlay')?.remove();
  document.querySelector('.msg-popup')?.remove();
  const overlay=document.createElement('div');
  overlay.className='msg-popup-overlay';
  const popup=document.createElement('div');
  popup.className='msg-popup';
  // Position near touch
  const x=Math.min(e.clientX||e.touches?.[0]?.clientX||window.innerWidth/2, window.innerWidth-196);
  const y=Math.min(e.clientY||e.touches?.[0]?.clientY||200, window.innerHeight-120);
  popup.style.cssText='left:'+x+'px;top:'+y+'px';
  function close(){overlay.remove();popup.remove();}
  overlay.onclick=close;
  // Delete for me
  const delMe=document.createElement('div');delMe.className='msg-popup-item danger';
  delMe.innerHTML='üóë Delete for Me';
  delMe.onclick=async()=>{
    close();
    APP.chats=(APP.chats||[]).filter(msg=>msg.id!==m.id);
    IDB.putAll('chats',APP.chats.slice(-50000));
    renderNow();
    DB.delChatMsg(m.id).catch(()=>{});
  };
  // Delete for everyone (admin always can; user only their own msgs)
  const delAll=document.createElement('div');delAll.className='msg-popup-item danger';
  delAll.innerHTML='üö´ Delete for Everyone';
  delAll.onclick=async()=>{
    close();
    APP.chats=(APP.chats||[]).map(msg=>msg.id===m.id?{...msg,message:'_deleted_',msg_type:'text',voice_data:null}:msg);
    IDB.putAll('chats',APP.chats.slice(-50000));
    renderNow();
    DB.redactChatMsg(m.id).catch(()=>{});
  };
  const cancel=document.createElement('div');cancel.className='msg-popup-item';
  cancel.innerHTML='‚úï Cancel';cancel.onclick=close;
  popup.appendChild(delMe);
  if(isAdmin||m.sender==='user'&&APP.screen==='user')popup.appendChild(delAll);
  popup.appendChild(cancel);
  document.body.appendChild(overlay);
  document.body.appendChild(popup);
}

function _renderMsg(m, isAdmin){
  const isUser=m.sender==='user';
  const cm=h('div',{class:'msg-row '+(isUser?'u':'a')});
  cm.dataset.mid=m.id||'';
  // Long press detection
  let pressTimer=null;
  const startPress=e=>{pressTimer=setTimeout(()=>{pressTimer=null;_showMsgPopup(e,m,isAdmin);},500);};
  const endPress=()=>{if(pressTimer){clearTimeout(pressTimer);pressTimer=null;}};
  cm.addEventListener('touchstart',startPress,{passive:true});
  cm.addEventListener('touchend',endPress);
  cm.addEventListener('touchmove',endPress);
  cm.addEventListener('contextmenu',e=>{e.preventDefault();_showMsgPopup(e,m,isAdmin);});
  // Deleted message placeholder
  if(m.message==='_deleted_'&&m.msg_type==='text'&&!m.voice_data){
    cm.appendChild(h('div',{class:'cb '+(isUser?'u':'a'),style:{color:'var(--t2)',fontStyle:'italic',opacity:'.6'}},'üö´ Message deleted'));
    cm.appendChild(h('div',{class:'cts'},m.sent_at?new Date(m.sent_at).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true}):''));
    return cm;
  }
  if(m.msg_type==='voice'&&m.voice_data){
    try{cm.appendChild(renderVoiceNote(m,isUser?'u':'a'));}
    catch{cm.appendChild(h('div',{class:'cb '+(isUser?'u':'a')},'üéô Voice note'));}
  } else {
    cm.appendChild(h('div',{class:'cb '+(isUser?'u':'a')},m.message||''));
  }
  cm.appendChild(h('div',{class:'cts'},m.sent_at?new Date(m.sent_at).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true}):''));
  return cm;
}

function renderUserChat(){
  const wrap=h('div',{class:'page',style:{display:'flex',flexDirection:'column',overflow:'hidden'}});
  wrap.appendChild(h('div',{class:'hdr'},h('div',{class:'hdr-title'},'Enquire')));

  const msgs=APP.chats.filter(m=>m.user_email===APP.user?.email);
  const lastMsg=msgs[msgs.length-1];
  const locked=lastMsg&&lastMsg.sender==='user';
  // 5-message limit: count user messages sent
  const userMsgCount=msgs.filter(m=>m.sender==='user').length;
  const adminUnlocked=msgs.some(m=>m.admin_unlocked===true);
  const msgLimitReached=userMsgCount>=5&&!adminUnlocked;

  const msgArea=h('div',{class:'chat-msgs'});
  if(msgs.length===0){
    msgArea.appendChild(h('div',{class:'empty'},h('div',{class:'ei'},'üí¨'),h('div',{class:'et'},'Start a conversation'),h('div',{class:'es'},'Ask us anything about products, pricing, or availability. (5 free messages)')));
  } else {
    if(locked)msgArea.appendChild(h('div',{class:'chat-locked'},h('div',{style:{color:'var(--g)',fontSize:'13px',fontWeight:'700',marginBottom:'4px'}},'‚è≥ Awaiting Response'),h('div',{style:{fontSize:'12px',color:'var(--t2)',lineHeight:'1.6'}},'Your message is with our team. We\'ll reply soon.')));
    if(msgLimitReached)msgArea.appendChild(h('div',{class:'chat-locked',style:{background:'rgba(176,48,48,.1)',border:'1px solid rgba(176,48,48,.3)'}},h('div',{style:{color:'#e05555',fontSize:'13px',fontWeight:'700',marginBottom:'4px'}},'üîí Message Limit Reached'),h('div',{style:{fontSize:'12px',color:'var(--t2)',lineHeight:'1.6'}},'You have used your 5 free messages. Please wait for admin to unlock your chat.')));
    // Virtual scroll ‚Äî only render last 60, load more on scroll-up
    const VWIN=60;
    const vStart=Math.max(0,msgs.length-VWIN);
    if(vStart>0){
      const ldBtn=h('div',{style:{textAlign:'center',padding:'8px',fontSize:'11px',color:'var(--t2)',cursor:'pointer',borderBottom:'1px solid var(--glb)'}},
        '‚Üë '+vStart+' older messages ‚Äî tap to load');
      ldBtn.onclick=()=>{
        msgs.slice(0,vStart).reverse().forEach(m=>{
          const cm=_renderMsg(m);
          msgArea.insertBefore(cm,msgArea.children[1]||null);
        });
        ldBtn.remove();
      };
      msgArea.appendChild(ldBtn);
    }
    msgs.slice(vStart).forEach(m=>msgArea.appendChild(_renderMsg(m)));
    requestAnimationFrame(()=>{msgArea.scrollTop=msgArea.scrollHeight;});
  }
  wrap.appendChild(msgArea);
  if(msgLimitReached){
    wrap.appendChild(h('div',{style:{padding:'12px 14px',textAlign:'center',fontSize:'11px',color:'rgba(224,85,85,.8)',background:'rgba(176,48,48,.08)',borderTop:'1px solid rgba(176,48,48,.2)'}},'üîí Chat locked ‚Äî awaiting admin approval'));
  } else {
    wrap.appendChild(renderChatBar(sendUserMessage));
  }
  return wrap;
}

function renderVoiceNote(msg,side){
  const dur=msg.voice_duration||0;
  const bars=40;
  const bubble=h('div',{class:'vn '+side});
  const btn=h('div',{class:'vn-btn',style:{cursor:'pointer'}},'‚ñ∂');
  const waves=h('div',{class:'vn-waves'});
  for(let i=0;i<bars;i++){
    const h2=3+Math.abs(Math.sin(i*0.4+parseInt(msg.id||'0',36)))*22;
    const bar=h('div',{class:'vn-bar',style:{height:h2+'px'}});
    waves.appendChild(bar);
  }
  const durEl=h('div',{class:'vn-dur'},fmtSecs(dur));
  // Preload audio immediately so first tap plays instantly
  const audio=new Audio();
  audio.preload='auto';
  audio.src=msg.voice_data;
  let playing=false; let prog=0; let animFrame=null;
  audio.onended=()=>{
    playing=false;prog=0;btn.textContent='‚ñ∂';
    waves.querySelectorAll('.vn-bar').forEach(b=>b.classList.remove('p'));
    durEl.textContent=fmtSecs(dur);
    if(animFrame){cancelAnimationFrame(animFrame);animFrame=null;}
  };
  audio.onerror=()=>{btn.textContent='‚ö†';btn.title='Audio load failed';};
  btn.addEventListener('click',()=>{
    if(playing){
      audio.pause();playing=false;btn.textContent='‚ñ∂';
      if(animFrame){cancelAnimationFrame(animFrame);animFrame=null;}
    } else {
      // Stop all other playing audio first
      document.querySelectorAll('.vn-btn').forEach(b=>{if(b!==btn&&b.textContent==='‚è∏')b.click();});
      audio.play().catch(()=>{btn.textContent='‚ö†';});
      playing=true;btn.textContent='‚è∏';
      const actualDur=audio.duration||dur||1;
      function upd(){
        if(!playing)return;
        const pb=Math.floor((audio.currentTime/actualDur)*bars);
        waves.querySelectorAll('.vn-bar').forEach((b,i)=>b.classList.toggle('p',i<pb));
        durEl.textContent=fmtSecs(Math.floor(audio.currentTime));
        animFrame=requestAnimationFrame(upd);
      }
      upd();
    }
  });
  bubble.appendChild(btn);bubble.appendChild(waves);bubble.appendChild(durEl);
  return bubble;
}

function renderChatBar(onSend){
  const uc=_userChat;
  if(uc.recording){
    const bar=h('div',{class:'rec-bar'});
    bar.appendChild(h('div',{class:'rec-dot'}));
    const _adminUnlNow=(APP.chats||[]).some(m=>m.user_email===APP.user?.email&&m.admin_unlocked===true);
    const _maxRecLabel=_adminUnlNow?'5:00':'0:10';
    const timeEl=h('div',{class:'rec-time',style:{display:'flex',flexDirection:'column',alignItems:'center',gap:'1px'}},
      h('span',{},fmtSecs(uc.recSecs)),
      h('span',{style:{fontSize:'8px',color:'var(--t2)',letterSpacing:'0.5px'}},'max '+_maxRecLabel)
    );
    bar.appendChild(timeEl);
    const wv=h('div',{class:'rec-waves'});
    uc.waveVals.forEach(v=>{
      const b=h('div',{class:'rw-bar',style:{height:v+'px'}});
      wv.appendChild(b);
    });
    bar.appendChild(wv);
    bar.appendChild(h('div',{class:'rec-cancel',onClick:cancelRec,style:{cursor:'pointer'}},'‚úï'));
    bar.appendChild(h('div',{class:'rec-ok',onClick:()=>sendVoiceMsg(onSend),style:{cursor:'pointer'}},'‚úì'));
    return bar;
  }
  const bar=h('div',{class:'chat-bar'});
  const ta=h('textarea',{class:'chat-inp',placeholder:'Type a message‚Ä¶',rows:'1'});
  ta.value=uc.text||'';
  ta.addEventListener('input',e=>{uc.text=e.target.value;});
  ta.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();onSend();}});
  bar.appendChild(ta);
  const sendBtn=h('div',{class:'chat-btn chat-send',style:{display:'none'},onClick:onSend},'‚û§');
  const micBtn=h('div',{class:'chat-btn chat-mic',onClick:startRec},'üéô');
  bar.appendChild(sendBtn);bar.appendChild(micBtn);
  ta.addEventListener('input',()=>{
    const hasText=ta.value.trim().length>0;
    sendBtn.style.display=hasText?'flex':'none';
    micBtn.style.display=hasText?'none':'flex';
  });
  return bar;
}

async function startRec(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}});
    const uc=_userChat;
    uc.chunks=[];uc.recSecs=0;uc.recBytes=0;uc.recording=true;uc.stream=stream;
    // Pick best format ‚Äî opus gives best quality/size ratio
    const mime=['audio/webm;codecs=opus','audio/ogg;codecs=opus','audio/webm','audio/mp4',''].find(m=>!m||MediaRecorder.isTypeSupported(m))||'';
    // 32kbps = excellent voice quality, tiny file (~240KB/min)
    const mrOpts=mime?{mimeType:mime,audioBitsPerSecond:24000}:{audioBitsPerSecond:24000}; // 24kbps = crystal clear voice, 4MB ~= 22min
    const mr=new MediaRecorder(stream,mrOpts);
    uc.mediaRecorder=mr;
    const MAX_BYTES=2*1024*1024; // 2MB = ~2.7MB base64, safe for Supabase row limit
    mr.ondataavailable=e=>{
      if(e.data&&e.data.size>0){
        uc.chunks.push(e.data);
        uc.recBytes=(uc.recBytes||0)+e.data.size;
        if(uc.recBytes>=MAX_BYTES){ notify('Max 2MB reached ‚Äî sending‚Ä¶'); sendVoiceMsg(null); }
      }
    };
    mr.onerror=()=>{cancelRec();notify('Recording error ‚Äî try again');};
    mr.start(100); // 100ms timeslice ‚Äî zero latency on stop
    // Waveform via rAF ‚Äî silky smooth, zero setInterval jank
    try{
      uc.audioCtx=new AudioContext();
      const src=uc.audioCtx.createMediaStreamSource(stream);
      uc.analyser=uc.audioCtx.createAnalyser();
      uc.analyser.fftSize=32; // smaller = faster
      src.connect(uc.analyser);
    }catch{}
    // Timer: 1s interval just for seconds counter
    // Limit: 10s if not admin-unlocked, 300s (5min) if admin-unlocked
    const _adminUnlockedNow=(APP.chats||[]).some(m=>m.user_email===APP.user?.email&&m.admin_unlocked===true);
    const MAX_REC_SECS=_adminUnlockedNow?300:10;
    uc.recTimer=setInterval(()=>{
      uc.recSecs++;
      const te=document.querySelector('.rec-time');
      if(te)te.textContent=fmtSecs(uc.recSecs)+(uc.recSecs>=MAX_REC_SECS-3&&uc.recSecs<MAX_REC_SECS?' ‚ö†':'');
      // Auto-stop at limit
      if(uc.recSecs>=MAX_REC_SECS){
        notify(MAX_REC_SECS===10?'Max 10 seconds reached ‚Äî sending‚Ä¶':'Max 5 minutes reached ‚Äî sending‚Ä¶');
        sendVoiceMsg(null);
      }
    },1000);
    // Waveform: rAF for smooth animation
    function waveLoop(){
      if(!uc.recording)return;
      if(uc.analyser){
        const data=new Uint8Array(uc.analyser.frequencyBinCount);
        uc.analyser.getByteFrequencyData(data);
        const avg=data.reduce((a,b)=>a+b,0)/data.length;
        uc.waveVals=[...uc.waveVals.slice(1),Math.max(3,Math.min(32,avg/2.5))];
        const bars=document.querySelectorAll('.rec-waves .rw-bar');
        uc.waveVals.forEach((v,i)=>{if(bars[i])bars[i].style.height=v+'px';});
      }
      uc.waveRaf=requestAnimationFrame(waveLoop);
    }
    waveLoop();
    renderNow();
  }catch(e){notify('Microphone denied: '+e.message);}
}

function cancelRec(){
  const uc=_userChat;
  uc.recording=false; // stop waveLoop first
  if(uc.waveRaf)cancelAnimationFrame(uc.waveRaf);uc.waveRaf=null;
  if(uc.recTimer)clearInterval(uc.recTimer);uc.recTimer=null;
  try{if(uc.mediaRecorder&&uc.mediaRecorder.state!=='inactive')uc.mediaRecorder.stop();}catch{}
  try{uc.stream?.getTracks().forEach(t=>t.stop());}catch{}
  try{if(uc.audioCtx){uc.audioCtx.close();uc.audioCtx=null;}}catch{}
  uc.recSecs=0;uc.chunks=[];uc.recBytes=0;uc.stream=null;uc.mediaRecorder=null;uc.waveVals=new Array(20).fill(4);renderNow();
}

async function sendVoiceMsg(onSend){
  const uc=_userChat;
  if(!uc.chunks||!uc.chunks.length){cancelRec();return;}
  // Stop waveform and timer first
  uc.recording=false;
  if(uc.waveRaf)cancelAnimationFrame(uc.waveRaf);uc.waveRaf=null;
  if(uc.recTimer)clearInterval(uc.recTimer);uc.recTimer=null;
  const dur=uc.recSecs;
  // Stop recorder ‚Äî get final chunk
  const mimeType=uc.mediaRecorder?.mimeType||'audio/webm';
  if(uc.mediaRecorder&&uc.mediaRecorder.state!=='inactive'){
    await new Promise(res=>{uc.mediaRecorder.onstop=res;uc.mediaRecorder.stop();});
  }
  try{uc.stream?.getTracks().forEach(t=>t.stop());}catch{}
  try{if(uc.audioCtx){uc.audioCtx.close();uc.audioCtx=null;}}catch{}
  const chunks=[...uc.chunks];
  uc.chunks=[];uc.recBytes=0;uc.mediaRecorder=null;uc.stream=null;uc.waveVals=new Array(20).fill(4);
  if(!chunks.length){renderNow();return;}
  const blob=new Blob(chunks,{type:mimeType});
  // Convert to base64 and send ‚Äî optimistic UI
  const reader=new FileReader();
  reader.onload=async e=>{
    const voiceData=e.target.result;
    const msg={id:uid(),user_email:APP.user?.email,sender:'user',message:'',msg_type:'voice',voice_data:voiceData,voice_duration:dur,sent_at:new Date().toISOString(),locked:true};
    APP.chats=[...(APP.chats||[]),msg];
    renderNow(); // show immediately
    try{await DB.addChat(msg);}catch{notify('Voice send failed');}
  };
  reader.readAsDataURL(blob);
}

const _pendingMsgIds=new Set(); // track optimistic msg IDs to suppress RT dup
let _userSending=false;
async function sendUserMessage(){
  // Block if 5-message limit reached and not admin-unlocked
  const _uMsgs=(APP.chats||[]).filter(m=>m.user_email===APP.user?.email&&m.sender==='user');
  const _adminUnlocked=(APP.chats||[]).some(m=>m.user_email===APP.user?.email&&m.admin_unlocked===true);
  if(_uMsgs.length>=5&&!_adminUnlocked){notify('Message limit reached. Awaiting admin unlock.');return;}
  if(_userSending)return;
  const uc=_userChat;
  const ta=document.querySelector('.chat-inp');
  const text=(ta?.value||uc.text||'').trim();
  if(!text)return;
  _userSending=true;
  // Clear input INSTANTLY so user knows it was received
  if(ta){ta.value='';ta.style.height='auto';}uc.text='';
  // Hide send btn, show mic
  const sBtn=document.querySelector('.chat-send');const mBtn=document.querySelector('.chat-mic');
  if(sBtn)sBtn.style.display='none';if(mBtn)mBtn.style.display='flex';
  const msgId=uid();
  const msg={id:msgId,user_email:APP.user?.email,sender:'user',message:text,sent_at:new Date().toISOString(),locked:true,msg_type:'text'};
  _pendingMsgIds.add(msgId);
  // Optimistic UI ‚Äî show instantly
  APP.chats=[...(APP.chats||[]),msg];
  IDB.putAll('chats',APP.chats.slice(-50000));
  renderNow();
  // Sync to DB in background ‚Äî no blocking
  DB.addChat(msg).catch(e=>{notify('Message failed: '+e.message);}).finally(()=>{
    setTimeout(()=>_pendingMsgIds.delete(msgId), 5000); // cleanup after 5s
    _userSending=false;
  });
  _userSending=false; // allow next message immediately
}

// sendVoiceMessage kept for compatibility ‚Äî now handled inside sendVoiceMsg
async function sendVoiceMessage(voiceData,dur){
  const msgId=uid();
  const msg={id:msgId,user_email:APP.user?.email,sender:'user',message:'',msg_type:'voice',voice_data:voiceData,voice_duration:dur,sent_at:new Date().toISOString(),locked:true};
  _pendingMsgIds.add(msgId);
  APP.chats=[...(APP.chats||[]),msg];
  IDB.putAll('chats',APP.chats.slice(-50000));
  renderNow();
  DB.addChat(msg).catch(()=>{notify('Voice send failed');}).finally(()=>{setTimeout(()=>_pendingMsgIds.delete(msgId),5000);});
}

// ‚îÄ‚îÄ USER NOTIFS ‚îÄ‚îÄ
function renderUserNotifs(){
  const wrap=h('div',{class:'page',style:{overflowY:'auto',flex:'1'}});
  wrap.appendChild(h('div',{class:'hdr'},h('div',{class:'hdr-title'},'Notifications')));
  const reads=LS.get(KEY_NR,[]).filter(r=>r.email===APP.user?.email).map(r=>r.nid);
  if(APP.notifs.length===0)wrap.appendChild(h('div',{class:'empty'},h('div',{class:'ei'},'üîî'),h('div',{class:'et'},'No notifications')));
  APP.notifs.forEach(n=>{
    const isRead=reads.includes(n.id);
    const row=h('div',{class:'notif-item',onClick:()=>{DB.markRead(n.id,APP.user?.email);const a=LS.get(KEY_NR,[]);if(!a.find(r=>r.nid===n.id&&r.email===APP.user?.email))LS.set(KEY_NR,[...a,{nid:n.id,email:APP.user?.email}]);renderNow();}},
      h('div',{class:'n-dot '+(isRead?'r':'')}),
      h('div',{},h('div',{class:'n-title'},n.title||'Notification'),h('div',{class:'n-msg'},n.message||''),h('div',{class:'n-time'},n.created_at?new Date(n.created_at).toLocaleDateString('en-IN'):''))
    );
    wrap.appendChild(row);
  });
  return wrap;
}

// ‚îÄ‚îÄ USER PROFILE ‚îÄ‚îÄ
function renderUserProfile(){
  const u=APP.user||{};
  const wrap=h('div',{class:'page',style:{overflowY:'auto',flex:'1'}});
  wrap.appendChild(h('div',{class:'hdr'},h('div',{class:'hdr-title'},'My Profile')));
  const card=h('div',{style:{margin:'16px',padding:'20px',background:'var(--glass)',border:'1px solid var(--glb)',borderRadius:'var(--rad)'}});
  card.appendChild(h('div',{class:'prof-av'},'üë§'));
  card.appendChild(h('div',{style:{fontSize:'20px',fontStyle:'italic',color:'var(--t1)',marginBottom:'3px'}},u.name||'User'));
  if(u.email)card.appendChild(h('div',{style:{fontSize:'11px',color:'var(--t2)'}},u.email));
  if(u.ferm)card.appendChild(h('div',{style:{fontSize:'11px',color:'var(--t2)',marginTop:'2px'}},u.ferm));
  if(u.mob)card.appendChild(h('div',{style:{fontSize:'11px',color:'var(--t2)',marginTop:'2px'}},'üìû '+u.mob));
  wrap.appendChild(card);
  wrap.appendChild(h('div',{class:'prof-row',onClick:()=>{APP.tab='notif';renderNow();}},h('span',{style:{fontSize:'16px'}}),'üîî',h('div',{style:{flex:'1',marginLeft:'12px',fontSize:'13px',color:'var(--t1)',fontWeight:'700'}},'Notifications')));
  wrap.appendChild(h('div',{class:'prof-row',onClick:()=>{APP.tab='enquire';renderNow();}},h('span',{style:{fontSize:'16px'}}),'üí¨',h('div',{style:{flex:'1',marginLeft:'12px',fontSize:'13px',color:'var(--t1)',fontWeight:'700'}},'My Enquiries')));
  wrap.appendChild(h('div',{class:'prof-row',style:{marginTop:'10px'},onClick:()=>{LS.del(KEY_SESSION);APP.role='user';
      RT.reset&&RT.reset();
      _rtSubsStarted=false;
      if(_smartPollTimer){clearInterval(_smartPollTimer);_smartPollTimer=null;}
      APP.chats=[];APP.logs=[];APP.views=[];APP.audit=[];APP.users=[];APP.notifs=[];
      APP.cats=[];APP.prods=[];APP.detailProd=null;APP.selCat=null;APP.selSub=null;
      APP.chatFilter='all';APP._actLastLoad=0;
      _authState={mode:'login',email:'',pass:'',stayIn:true,regF:{name:'',ferm:'',mob:'',email:'',pass:''},otp:['','','','','',''],genOTP:'',showPass:false,err:'',okMsg:'',loading:false,otpExpiry:0,otpSent:false};
      go('splash');}},
    h('span',{},'üö™'),h('div',{style:{flex:'1',marginLeft:'12px',fontSize:'13px',color:'#e05555',fontWeight:'700'}},'Sign Out')
  ));
  return wrap;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADM_TABS=[
  {id:'dash',    icon:'üìä', label:'DASH'},
  {id:'cats',    icon:'üóÇ',  label:'CATS'},
  {id:'prods',   icon:'üì¶', label:'PRODS'},
  {id:'users',   icon:'üë•', label:'USERS'},
  {id:'chats',   icon:'üí¨', label:'CHATS'},
  {id:'activity',icon:'üëÅ',  label:'ACTIVITY'},
  {id:'logs',    icon:'üìù', label:'LOGS'},
  {id:'notifs',  icon:'üîî', label:'NOTIFS'},
  {id:'cleanup', icon:'üßπ', label:'CLEAN'},
  {id:'security',icon:'üîê', label:'SECURITY'},
  {id:'db',      icon:'‚òÅ',  label:'DB'},
];
// ‚îÄ‚îÄ Nickname helper ‚îÄ‚îÄ
function displayName(emailOrUser){
  if(typeof emailOrUser==='object'&&emailOrUser!==null){
    return emailOrUser.nickname||emailOrUser.name||emailOrUser.email||'User';
  }
  const u=(APP.users||[]).find(u=>u.email===emailOrUser);
  return u?(u.nickname||u.name||emailOrUser):emailOrUser;
}

// Admin read tracking (localStorage only ‚Äî no DB needed)
// Admin read tracking (localStorage only ‚Äî no DB needed)
function admMarkRead(email){ const r=LS.get(KEY_ADM_READ,{}); r[email]=Date.now(); LS.set(KEY_ADM_READ,r); }
function admIsRead(email){
  const r=LS.get(KEY_ADM_READ,{});
  const readAt=r[email]||0;
  const chats=APP.chats.filter(m=>m.user_email===email&&m.sender==='user');
  if(!chats.length) return true;
  const lastUserMsg=chats[chats.length-1];
  const lastTs=new Date(lastUserMsg.sent_at||0).getTime();
  return readAt>=lastTs;
}

const SCHEMA=`-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- SURESH MILLGIN STORES ‚Äî Full Database Setup
-- Run this entire block in Supabase SQL Editor ‚Üí Run
-- Safe to re-run ‚Äî uses IF NOT EXISTS, ON CONFLICT
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- STEP 1: CREATE TABLES
CREATE TABLE IF NOT EXISTS sms_users (id text PRIMARY KEY, name text, firm text, mobile text, email text UNIQUE, nickname text, registered_at timestamptz DEFAULT now(), ip text);
CREATE TABLE IF NOT EXISTS sms_categories (id text PRIMARY KEY, name text, icon text, image text, image_url text, parent_id text, sort_order integer DEFAULT 0);
CREATE TABLE IF NOT EXISTS sms_products (id text PRIMARY KEY, name text, category_ids jsonb DEFAULT '[]', sub_category_ids jsonb DEFAULT '[]', icon text, price text, price_on_request boolean DEFAULT false, description text, images jsonb DEFAULT '[]', video text, created_at timestamptz DEFAULT now());
CREATE TABLE IF NOT EXISTS sms_chats (id text PRIMARY KEY, user_email text, sender text, message text, msg_type text DEFAULT 'text', voice_data text, voice_duration integer, sent_at timestamptz DEFAULT now(), locked boolean DEFAULT true);
CREATE TABLE IF NOT EXISTS sms_audit (id text PRIMARY KEY, event text, user_email text, ip text, logged_at timestamptz DEFAULT now());
CREATE TABLE IF NOT EXISTS sms_notifs (id text PRIMARY KEY, title text, message text, created_at timestamptz DEFAULT now());
CREATE TABLE IF NOT EXISTS sms_notif_reads (id text PRIMARY KEY, notif_id text, user_email text);
CREATE TABLE IF NOT EXISTS sms_view_hist (id text PRIMARY KEY, prod_id text, prod_name text, prod_cat text, user_email text, viewed_at timestamptz DEFAULT now());
CREATE TABLE IF NOT EXISTS sms_logs (id text PRIMARY KEY, user_name text, firm text, mobile text, email text, pass_masked text, ip text, logged_at timestamptz DEFAULT now());
CREATE TABLE IF NOT EXISTS admin_settings (id text PRIMARY KEY DEFAULT 'main', email text NOT NULL, password text NOT NULL, updated_at timestamptz DEFAULT now());

-- STEP 2: ENABLE RLS (security on)
ALTER TABLE sms_users ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_products ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_chats ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_audit ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_notifs ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_notif_reads ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_view_hist ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE admin_settings ENABLE ROW LEVEL SECURITY;

-- STEP 3: DROP OLD POLICIES (safe to run even if they don't exist)
DO $$ DECLARE r RECORD;
BEGIN FOR r IN SELECT schemaname,tablename,policyname FROM pg_policies WHERE tablename LIKE 'sms_%' LOOP
  EXECUTE 'DROP POLICY IF EXISTS "' || r.policyname || '" ON ' || r.tablename; END LOOP; END $$;

-- STEP 4: ANON CAN READ products, categories, notifs (users browse catalog)
CREATE POLICY "anon_read_cats"    ON sms_categories    FOR SELECT TO anon USING (true);
CREATE POLICY "anon_read_prods"   ON sms_products      FOR SELECT TO anon USING (true);
CREATE POLICY "anon_read_notifs"  ON sms_notifs        FOR SELECT TO anon USING (true);
CREATE POLICY "anon_read_notif_reads" ON sms_notif_reads FOR SELECT TO anon USING (true);
CREATE POLICY "anon_read_settings" ON admin_settings   FOR SELECT TO anon USING (true);

-- STEP 5: ANON CAN INSERT user-generated data (chats, logs, audit, views, notif_reads)
CREATE POLICY "anon_insert_chats" ON sms_chats         FOR INSERT TO anon WITH CHECK (true);
CREATE POLICY "anon_read_chats"   ON sms_chats         FOR SELECT TO anon USING (true);
CREATE POLICY "anon_insert_audit" ON sms_audit         FOR INSERT TO anon WITH CHECK (true);
CREATE POLICY "anon_insert_views" ON sms_view_hist     FOR INSERT TO anon WITH CHECK (true);
CREATE POLICY "anon_read_views"   ON sms_view_hist     FOR SELECT TO anon USING (true);
CREATE POLICY "anon_insert_users" ON sms_users         FOR INSERT TO anon WITH CHECK (true);
CREATE POLICY "anon_insert_logs"  ON sms_logs          FOR INSERT TO anon WITH CHECK (true);
CREATE POLICY "anon_insert_notif_reads" ON sms_notif_reads FOR INSERT TO anon WITH CHECK (true);

-- STEP 6: ONLY SERVICE ROLE CAN add/edit/delete products, categories, notifs
-- service_role bypasses RLS by default ‚Äî no extra policy needed for admin writes
-- If you only have anon key configured, add these policies:
-- CREATE POLICY "anon_write_cats"  ON sms_categories FOR ALL TO anon USING (true) WITH CHECK (true);
-- CREATE POLICY "anon_write_prods" ON sms_products   FOR ALL TO anon USING (true) WITH CHECK (true);
-- OR: configure Service Role Key in Admin Panel ‚Üí DB tab ‚Üí Service Role Key field
-- This means: only your admin panel with the Service Role Key can save/delete products

-- STEP 7: SEED ADMIN CREDENTIALS
INSERT INTO admin_settings (id, email, password)
VALUES ('main', 'smitbhatiya47@gmail.com', 'Smit_5643_@')
ON CONFLICT (id) DO NOTHING;

-- STEP 8: STORAGE BUCKET SETUP
-- 1. Supabase ‚Üí Storage ‚Üí New bucket
-- 2. Name: sms-images
-- 3. Public: ON
-- 4. Go to sms-images ‚Üí Policies ‚Üí New policy:
--    Name: public_read | Operation: SELECT | Role: anon | Policy: true
-- NOTE: No INSERT policy for anon ‚Äî only service_role can upload images (admin only)
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;

// Admin forms state
let _admForms={
  newCat:{name:'',icon:'',image:null},
  editCat:null,
  newProd:{name:'',category_ids:[],sub_category_ids:[],icon:'',price:'',price_on_request:false,description:'',images:[],video:null},
  editProd:null,
  newNotif:{title:'',message:''},
  selChat:null,
  replyTxt:'',
  dmEmail:'',
  sbCfg:{url:'',key:''},
  sbSvcKey:'',
  sbTesting:false,
  sbErr:'',
  clFrom:'',clTo:(()=>{const d=new Date();d.setDate(d.getDate()-30);return d.toISOString().split('T')[0];})(),clSel:[],clConfirm:false,clRunning:false,clProg:0,clDone:null,
};

function renderAdmin(){
  const wrap=h('div',{class:'page fade-in',style:{overflow:'hidden'}});
  wrap.appendChild(h('div',{class:'hdr'},
    h('div',{class:'hdr-title'},'Admin Panel'),
    APP.sbOn?h('span',{class:'sb-on'},'‚òÅ CLOUD'):h('span',{class:'sb-off'},'üì± LOCAL')
  ));
  const tabs=h('div',{class:'adm-tabs'});
  ADM_TABS.forEach(t=>{
    const allE=[...new Set(APP.chats.map(m=>m.user_email).filter(Boolean))];
    const unreadCount=t.id==='chats'?allE.filter(e=>!admIsRead(e)).length:0;
    const tabEl=h('div',{class:'at '+(APP.atab===t.id?'on':''),style:{position:'relative'},onClick:()=>{
          if(t.id==='activity')APP._actLastLoad=0; // reset throttle so activity reloads on tab switch
          APP.atab=t.id;renderNow();}},t.icon+' '+t.label);
    if(unreadCount>0){
      tabEl.appendChild(h('div',{style:{position:'absolute',top:'2px',right:'2px',background:'#e05555',color:'#fff',borderRadius:'50%',width:'14px',height:'14px',fontSize:'8px',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:'900',lineHeight:'1'}},unreadCount>9?'9+':String(unreadCount)));
    }
    tabs.appendChild(tabEl);
  });
  wrap.appendChild(tabs);
  const body=h('div',{class:'adm-body'});
  switch(APP.atab){
    case 'dash': renderAdmDash(body); break;
    case 'cats': renderAdmCats(body); break;
    case 'prods': renderAdmProds(body); break;
    case 'chats': renderAdmChats(body); break;
    case 'users': renderAdmUsers(body); break;
    case 'activity': renderAdmActivity(body); break;
    case 'logs': renderAdmLogs(body); break;
    case 'notifs': renderAdmNotifs(body); break;
    case 'cleanup': renderAdmCleanup(body); break;
    case 'security': renderAdmSecurity(body); break;
    case 'db': renderAdmDB(body); break;
    default: renderAdmDash(body);
  }
  wrap.appendChild(body);
  // Logout
  const lout=h('div',{style:{padding:'10px 14px',borderTop:'1px solid var(--glb)',flexShrink:'0',display:'flex',gap:'8px'}});
  lout.appendChild(h('button',{class:'btn btn-ol btn-sm',style:{flex:'1',marginTop:'0'},onClick:()=>{LS.del(KEY_SESSION);if(typeof RT!=='undefined')RT.reset&&RT.reset();_rtSubsStarted=false;if(_smartPollTimer){clearInterval(_smartPollTimer);_smartPollTimer=null;}APP.role='user';APP.user=null;APP.chats=[];APP.logs=[];APP.views=[];APP.audit=[];APP.users=[];APP.notifs=[];APP.cats=[];APP.prods=[];APP.detailProd=null;APP.selCat=null;APP.selSub=null;APP.chatFilter='all';APP._actLastLoad=0;_authState={mode:'login',email:'',pass:'',stayIn:true,regF:{name:'',ferm:'',mob:'',email:'',pass:''},otp:['','','','','',''],genOTP:'',showPass:false,err:'',okMsg:'',loading:false,otpExpiry:0,otpSent:false};go('splash');}},'üö™ Logout'));
  wrap.appendChild(lout);
  return wrap;
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function renderAdmDash(body){
  const users=APP.users.length||[...new Set(APP.chats.map(m=>m.user_email).filter(Boolean))].length;
  const stats=[['üì¶',APP.prods.length,'Products'],['üóÇ',APP.cats.length,'Categories'],['üí¨',APP.chats.length,'Messages'],['üë•',users,'Users']];
  const grid=h('div',{class:'stat-grid'});
  stats.forEach(([ic,n,l])=>grid.appendChild(h('div',{class:'stat-box'},h('div',{class:'stat-n'},ic+' '+n),h('div',{class:'stat-l'},l))));
  body.appendChild(grid);
  // Recent audit
  body.appendChild(h('div',{style:{marginBottom:'8px',fontSize:'9px',color:'var(--g)',letterSpacing:'3px',fontWeight:'700',textTransform:'uppercase'}},'Recent Activity'));
  const auditBox=h('div',{class:'form-card'});
  if(APP.audit.slice(0,5).length===0)auditBox.appendChild(h('div',{style:{color:'var(--t2)',fontSize:'12px',fontStyle:'italic'}},'No activity yet'));
  APP.audit.slice(0,5).forEach(a=>{
    auditBox.appendChild(h('div',{style:{padding:'9px 0',borderBottom:'1px solid var(--glb)',fontSize:'11px'}},
      h('div',{style:{color:'var(--t1)',fontWeight:'700',marginBottom:'2px'}},a.event||'Event'),
      h('div',{style:{color:'var(--t2)',fontSize:'9px'}},a.user_email||''),
      h('div',{style:{color:'var(--g)',fontSize:'9px'}},a.logged_at?new Date(a.logged_at).toLocaleString('en-IN'):'')
    ));
  });
  body.appendChild(auditBox);
}

// ‚îÄ‚îÄ CATEGORIES ‚îÄ‚îÄ
function renderAdmCats(body){
  const f=_admForms;
  const formCard=h('div',{class:'form-card'});
  formCard.appendChild(h('div',{class:'form-title'},f.editCat?'‚úè Edit Category':'‚ûï Add Category'));
  const catErr=h('div',{class:'err',style:{display:'none'}});
  formCard.appendChild(catErr);

  const cat=f.editCat||f.newCat;
  const nameIn=h('input',{class:'inp',placeholder:'Category name ‚Äî required',value:cat.name||''});
  const iconIn=h('input',{class:'inp',placeholder:'Emoji icon e.g. ‚öôÔ∏è ‚Äî optional',value:cat.icon||''});
  const parentSel=h('select',{class:'sel'});
  parentSel.appendChild(h('option',{value:''},'‚Äî No parent (Main Category) ‚Äî'));
  APP.cats.filter(c=>!c.parent_id&&c.id!==(f.editCat?.id)).forEach(c=>
    parentSel.appendChild(h('option',{value:c.id,selected:cat.parent_id===c.id?true:undefined},c.name))
  );

  // Image upload (optional) ‚Äî singleton input to prevent memory leak
  const imgPrev=h('div',{style:{marginBottom:'9px'}});
  if(cat.image||cat.image_url){
    const img=document.createElement('img');
    img.src=cat.image||cat.image_url;
    img.style.cssText='width:100%;height:100px;object-fit:cover;border-radius:var(--rsm);border:1px solid var(--glb)';
    const rm=h('button',{class:'btn btn-danger btn-sm',style:{marginTop:'6px',width:'auto'},
      onClick:()=>{if(f.editCat)f.editCat.image=null;else f.newCat.image=null;renderNow();}},'‚úï Remove');
    imgPrev.appendChild(img);imgPrev.appendChild(rm);
  } else {
    const zone=h('div',{class:'img-zone',style:{position:'relative',cursor:'pointer'}});
    zone.innerHTML='<div style="font-size:24px">üì∑</div><div style="font-size:10px;color:var(--t2);margin-top:6px">Tap to add image ‚Äî optional</div>';
    let ci=document.getElementById('_cat_img_inp');
    if(!ci){ci=document.createElement('input');ci.id='_cat_img_inp';ci.type='file';ci.accept='image/*';ci.style.display='none';document.body.appendChild(ci);}
    ci.onchange=async e=>{
      const file=e.target.files?.[0];if(!file)return;
      ci.value='';
      notify('Uploading‚Ä¶');
      try{const url=await DB.uploadImg(file,'categories');if(f.editCat)f.editCat.image=url;else f.newCat.image=url;renderNow();}
      catch(err){notify('Upload failed: '+err.message);}
    };
    zone.onclick=()=>ci.click();
    imgPrev.appendChild(zone);
  }

  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Name ‚ú¶'),nameIn));
  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Icon (optional)'),iconIn));
  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Parent (optional)'),parentSel));
  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Image (optional)'),imgPrev));

  const savBtn=h('button',{class:'btn btn-g'},f.editCat?'SAVE CHANGES':'ADD CATEGORY');
  let _catSaving=false;
  savBtn.onclick=async()=>{
    if(_catSaving)return;_catSaving=true;
    const name=nameIn.value.trim();
    if(!name){catErr.textContent='‚ö† Category name is required.';catErr.style.display='block';_catSaving=false;return;}
    catErr.style.display='none';
    // Warn if no service role key ‚Äî anon key can't write categories
    if(!_sbAdmin&&_sb){
      catErr.textContent='‚ö† Service Role Key not configured. Go to DB tab ‚Üí Service Role Key.';
      catErr.style.display='block';
      _catSaving=false;return;
    }
    savBtn.textContent='SAVING‚Ä¶';savBtn.disabled=true;
    try{
      const imgVal=(f.editCat?f.editCat.image:f.newCat.image)||null;
      const data={id:f.editCat?.id||uid(),name,
        icon:iconIn.value.trim()||null,
        parent_id:parentSel.value||null,
        image:imgVal,image_url:imgVal,
        sort_order:f.editCat?.sort_order!=null?f.editCat.sort_order:APP.cats.filter(c=>!c.parent_id).length};
      // Retry once on network error
      const _slowTimer=setTimeout(()=>{savBtn.textContent='Still saving‚Ä¶ (slow connection)';},8000);
      let saved=false;
      for(let attempt=1;attempt<=2;attempt++){
        try{await DB.saveCat(data);saved=true;break;}
        catch(retryErr){
          if(attempt===2){clearTimeout(_slowTimer);throw retryErr;}
          savBtn.textContent='Retrying (attempt 2)‚Ä¶';
          await new Promise(r=>setTimeout(r,2000));
        }
      }
      clearTimeout(_slowTimer);
      // Optimistic update ‚Äî show result instantly, sync in background
      if(f.editCat){
        APP.cats=(APP.cats||[]).map(x=>x.id===data.id?{...x,...data}:x);
      } else {
        APP.cats=[...(APP.cats||[]),data];
      }
      IDB.putAll('cats',APP.cats);
      f.editCat=null;f.newCat={name:'',icon:'',image:null};
      notify('Category saved ‚úì');_catSaving=false;renderNow();
      // Background: refresh from DB to confirm
      DB.getCats().then(fresh=>{if(fresh?.length){APP.cats=fresh;IDB.putAll('cats',fresh);}}).catch(()=>{});
      DB.addAudit({id:uid(),event:'Category Saved: '+name,user_email:'admin',ip:APP.ip,logged_at:new Date().toISOString()});
      savBtn.textContent=f.editCat?'SAVE CHANGES':'ADD CATEGORY';savBtn.disabled=false;
    }catch(e){
      catErr.textContent='‚ö† Save failed: '+e.message;catErr.style.display='block';
      savBtn.textContent=f.editCat?'SAVE CHANGES':'ADD CATEGORY';savBtn.disabled=false;_catSaving=false;
    }
  };
  formCard.appendChild(savBtn);
  if(f.editCat)formCard.appendChild(h('button',{class:'btn btn-ol',onClick:()=>{f.editCat=null;renderNow();}},'Cancel'));
  body.appendChild(formCard);

  // List with search
  const catsSearchInp=h('input',{class:'inp',placeholder:'üîç Search categories‚Ä¶',style:{marginBottom:'10px',fontSize:'12px'}});
  let _catsFilter='';
  catsSearchInp.addEventListener('input',e=>{_catsFilter=e.target.value.toLowerCase();catRows.forEach(r=>{r.style.display=(!_catsFilter||r.dataset.s.includes(_catsFilter))?'':'none';});});
  body.appendChild(catsSearchInp);
  const catRows=[];
  const mainCats=APP.cats.filter(c=>!c.parent_id);
  mainCats.forEach(cat=>{
    const subs=APP.cats.filter(c=>c.parent_id===cat.id);
    const row=h('div',{class:'irow'});
    row.dataset.s=((cat.name||'')+(cat.icon||'')).toLowerCase();
    catRows.push(row);
    const th=h('div',{class:'ithumb'});
    if(cat.image_url||cat.image){const img=document.createElement('img');img.src=cat.image_url||cat.image;img.style.cssText='width:100%;height:100%;object-fit:cover';th.appendChild(img);}
    else th.textContent=cat.icon||'üìÅ';
    row.appendChild(th);
    row.appendChild(h('div',{class:'iinfo'},h('div',{class:'iname'},cat.name),h('div',{class:'isub'},subs.length+' subcategories')));
    const delBtn=h('button',{class:'btn btn-danger btn-sm'},'üóë');
    delBtn.onclick=async()=>{
      if(delBtn.dataset.c==='1'){
        delBtn.textContent='‚Ä¶';delBtn.disabled=true;
        try{
          APP.cats=(APP.cats||[]).filter(x=>x.id!==cat.id&&x.parent_id!==cat.id);
          IDB.putAll('cats',APP.cats);notify('Deleted ‚úì');renderNow();
          DB.delCat(cat.id).then(()=>{DB.addAudit({id:uid(),event:'Category Deleted: '+cat.name,user_email:'admin',ip:APP.ip,logged_at:new Date().toISOString()});DB.getCats().then(f=>{if(f?.length>=0){APP.cats=f;IDB.putAll('cats',f);}}).catch(()=>{});}).catch(e=>{notify('Delete failed: '+e.message);DB.getCats().then(f=>{if(f)APP.cats=f;renderNow();}).catch(()=>{});});
        }catch(e){notify('Delete failed: '+e.message);delBtn.textContent='üóë';delBtn.disabled=false;delBtn.dataset.c='';}
      } else {
        delBtn.dataset.c='1';delBtn.textContent='Sure?';
        setTimeout(()=>{if(delBtn.dataset.c==='1'){delBtn.dataset.c='';delBtn.textContent='üóë';}},2500);
      }
    };
    row.appendChild(h('div',{class:'iacts'},
      h('button',{class:'btn btn-ol btn-sm',style:{marginTop:'0'},onClick:()=>{f.editCat={...cat};renderNow();}},'‚úè'),
      delBtn
    ));
    body.appendChild(row);
    subs.forEach(s=>{
      const sr=h('div',{class:'irow',style:{paddingLeft:'28px',background:'rgba(0,0,0,.2)'}});
      sr.dataset.s=((s.name||'')+(s.icon||'')+' '+cat.name).toLowerCase();
      catRows.push(sr);
      sr.appendChild(h('div',{class:'ithumb'},s.icon||'üìÇ'));
      sr.appendChild(h('div',{class:'iinfo'},h('div',{class:'iname',style:{fontSize:'11px'}},s.name),h('div',{class:'isub'},'Sub of '+cat.name)));
      const sDelBtn=h('button',{class:'btn btn-danger btn-sm'},'üóë');
      sDelBtn.onclick=async()=>{
        if(sDelBtn.dataset.c==='1'){
          sDelBtn.textContent='‚Ä¶';sDelBtn.disabled=true;
          try{
            APP.cats=(APP.cats||[]).filter(x=>x.id!==s.id);
            IDB.putAll('cats',APP.cats);notify('Deleted ‚úì');renderNow();
            DB.delCat(s.id).then(()=>{DB.addAudit({id:uid(),event:'SubCategory Deleted: '+s.name,user_email:'admin',ip:APP.ip,logged_at:new Date().toISOString()});DB.getCats().then(f=>{if(f?.length>=0){APP.cats=f;IDB.putAll('cats',f);}}).catch(()=>{});}).catch(e=>{notify('Delete failed: '+e.message);DB.getCats().then(f=>{if(f)APP.cats=f;renderNow();}).catch(()=>{});});
          }catch(e){notify('Delete failed: '+e.message);sDelBtn.textContent='üóë';sDelBtn.disabled=false;sDelBtn.dataset.c='';}
        } else {
          sDelBtn.dataset.c='1';sDelBtn.textContent='Sure?';
          setTimeout(()=>{if(sDelBtn.dataset.c==='1'){sDelBtn.dataset.c='';sDelBtn.textContent='üóë';}},2500);
        }
      };
      sr.appendChild(h('div',{class:'iacts'},
        h('button',{class:'btn btn-ol btn-sm',style:{marginTop:'0'},onClick:()=>{f.editCat={...s};renderNow();}},'‚úè'),
        sDelBtn
      ));
      body.appendChild(sr);
    });
  });
}

// ‚îÄ‚îÄ PRODUCTS ‚îÄ‚îÄ
function renderAdmProds(body){
  const f=_admForms;
  const prod=f.editProd||f.newProd;
  const formCard=h('div',{class:'form-card'});
  formCard.appendChild(h('div',{class:'form-title'},f.editProd?'‚úè Edit Product':'‚ûï Add Product'));
  const prodErr=h('div',{class:'err',style:{display:'none'}});
  formCard.appendChild(prodErr);

  const nameIn=h('input',{class:'inp',placeholder:'Product name ‚Äî required',value:prod.name||''});
  const priceIn=h('input',{class:'inp',placeholder:'e.g. 1200 ‚Äî optional',value:prod.price||'',type:'text',inputmode:'numeric'});
  const descTA=h('textarea',{class:'ta',placeholder:'Description ‚Äî optional'},prod.description||'');
  const iconIn=h('input',{class:'inp',placeholder:'Emoji icon e.g. ‚öôÔ∏è ‚Äî optional',value:prod.icon||''});

  // Price on request toggle
  const porRow=h('div',{class:'tog',style:{marginBottom:'12px'}},
    h('div',{class:'tog-t '+(prod.price_on_request?'on':'')},h('div',{class:'tog-th'})),
    h('div',{class:'tog-l'},'Price On Request')
  );
  porRow.onclick=()=>{prod.price_on_request=!prod.price_on_request;renderNow();};

  // Category chips
  const mainCats=APP.cats.filter(c=>!c.parent_id);
  const catSel=h('div',{style:{display:'flex',flexWrap:'wrap',gap:'6px',marginBottom:'12px'}});
  if(mainCats.length===0){
    catSel.appendChild(h('div',{style:{fontSize:'11px',color:'var(--t2)',fontStyle:'italic'}},'No categories yet ‚Äî add some in CATS tab first'));
  }
  mainCats.forEach(cat=>{
    const on=(prod.category_ids||[]).includes(cat.id);
    const chip=h('div',{style:{padding:'5px 12px',border:'1px solid '+(on?'var(--g)':'var(--glb)'),
      borderRadius:'14px',fontSize:'11px',fontWeight:'700',color:on?'var(--g)':'var(--t2)',
      cursor:'pointer',background:on?'var(--gl)':'transparent'}},
      (cat.icon||'')+' '+cat.name);
    chip.onclick=()=>{
      if(on)prod.category_ids=(prod.category_ids||[]).filter(id=>id!==cat.id);
      else prod.category_ids=[...(prod.category_ids||[]),cat.id];
      renderNow();
    };
    catSel.appendChild(chip);
  });

  // Images grid ‚Äî singleton input
  const imgGrid=h('div',{class:'img-grid'});
  (prod.images||[]).forEach((img,i)=>{
    const item=h('div',{class:'img-item'});
    const im=document.createElement('img');im.src=img;im.style.cssText='width:100%;height:100%;object-fit:cover';
    const rm=h('button',{class:'img-rm'},  '‚úï');
    rm.onclick=e=>{e.stopPropagation();prod.images.splice(i,1);renderNow();};
    if(i===0)item.appendChild(h('div',{class:'img-mb'},'MAIN'));
    item.appendChild(im);item.appendChild(rm);
    imgGrid.appendChild(item);
  });
  const addImgBtn=h('div',{class:'img-add'},' + ');
  let pii=document.getElementById('_prod_img_inp');
  if(!pii){pii=document.createElement('input');pii.id='_prod_img_inp';pii.type='file';pii.accept='image/*';pii.style.display='none';document.body.appendChild(pii);}
  pii.onchange=async e=>{
    const file=e.target.files?.[0];if(!file)return;
    pii.value='';
    notify('Uploading image‚Ä¶');
    try{const url=await DB.uploadImg(file,'products');prod.images=[...(prod.images||[]),url];renderNow();}
    catch(err){notify('Upload failed: '+err.message);}
  };
  addImgBtn.onclick=()=>pii.click();
  imgGrid.appendChild(addImgBtn);

  // Video ‚Äî singleton input
  const vidSec=h('div',{class:'ig'});
  vidSec.appendChild(h('label',{class:'il'},'Video (optional)'));
  if(prod.video){
    const vp=h('div',{class:'vid-prev'});
    const v=document.createElement('video');v.src=prod.video;v.controls=true;v.style.cssText='width:100%;max-height:180px;object-fit:contain';
    const rm=h('button',{class:'vid-rm'},  '‚úï');rm.onclick=()=>{prod.video=null;renderNow();};
    vp.appendChild(v);vp.appendChild(rm);vidSec.appendChild(vp);
  } else {
    const zone=h('div',{class:'vid-zone'});
    zone.innerHTML='<div style="font-size:22px">üé¨</div><div style="font-size:10px;color:var(--t2);margin-top:6px">Tap to upload video (MP4 ¬∑ Max 50MB)</div>';
    let pvi=document.getElementById('_prod_vid_inp');
    if(!pvi){pvi=document.createElement('input');pvi.id='_prod_vid_inp';pvi.type='file';pvi.accept='video/*';pvi.style.display='none';document.body.appendChild(pvi);}
    pvi.onchange=async e=>{
      const file=e.target.files?.[0];if(!file)return;
      pvi.value='';
      if(file.size>52428800){notify('Video too large (max 50MB)');return;}
      notify('Uploading video‚Ä¶');
      try{const url=await DB.uploadVideo(file);prod.video=url;renderNow();}
      catch(err){notify('Upload failed: '+err.message);}
    };
    zone.onclick=()=>pvi.click();
    vidSec.appendChild(zone);
  }

  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Name ‚ú¶'),nameIn));
  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Icon (optional)'),iconIn));
  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Categories (optional)'),catSel));
  formCard.appendChild(porRow);
  if(!prod.price_on_request)formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Price ‚Çπ (optional)'),priceIn));
  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Description (optional)'),descTA));
  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Images (optional)'),imgGrid));
  formCard.appendChild(vidSec);

  const saveBtn=h('button',{class:'btn btn-g'},f.editProd?'SAVE CHANGES':'ADD PRODUCT');
  saveBtn.onclick=async()=>{
    const name=nameIn.value.trim();
    if(!name){prodErr.textContent='‚ö† Product name is required.';prodErr.style.display='block';return;}
    prodErr.style.display='none';
    saveBtn.textContent='SAVING‚Ä¶';saveBtn.disabled=true;
    try{
      // Only send columns that exist in Supabase schema ‚Äî prevents 42703 errors
      const data={
        id:f.editProd?.id||uid(),
        name,
        icon:iconIn.value.trim()||null,
        category_ids:prod.category_ids||[],
        sub_category_ids:prod.sub_category_ids||[],
        price:prod.price_on_request?null:(priceIn.value.trim()||null),
        price_on_request:prod.price_on_request||false,
        description:descTA.value.trim()||null,
        images:prod.images||[],
        video:prod.video||null,
        created_at:f.editProd?.created_at||new Date().toISOString()
      };
      // Optimistic update ‚Äî show instantly
      if(f.editProd&&APP.prods.find(x=>x.id===data.id)){
        APP.prods=(APP.prods||[]).map(x=>x.id===data.id?{...x,...data}:x);
      } else {
        APP.prods=[...(APP.prods||[]),data];
      }
      IDB.putAll('prods',APP.prods);
      f.editProd=null;
      f.newProd={name:'',category_ids:[],sub_category_ids:[],icon:'',price:'',price_on_request:false,description:'',images:[],video:null};
      notify('Product saved ‚úì');renderNow();
      // Background: save to DB + confirm
      DB.saveProd(data).then(()=>{
        DB.addAudit({id:uid(),event:'Product Saved: '+name,user_email:'admin',ip:APP.ip,logged_at:new Date().toISOString()});
        DB.getProds().then(fresh=>{if(fresh?.length){APP.prods=fresh;IDB.putAll('prods',fresh);}}).catch(()=>{});
      saveBtn.textContent=f.editProd?'SAVE CHANGES':'ADD PRODUCT';saveBtn.disabled=false;
      }).catch(e=>{notify('‚ö† Sync failed: '+e.message);});
    }catch(e){
      prodErr.textContent='‚ö† Save failed: '+e.message;prodErr.style.display='block';
      saveBtn.textContent=f.editProd?'SAVE CHANGES':'ADD PRODUCT';saveBtn.disabled=false;
    }
  };
  formCard.appendChild(saveBtn);
  if(f.editProd)formCard.appendChild(h('button',{class:'btn btn-ol',onClick:()=>{f.editProd=null;renderNow();}},'Cancel'));
  body.appendChild(formCard);

  // Product list with search
  const prodsSearchInp=h('input',{class:'inp',placeholder:'üîç Search products‚Ä¶',style:{marginBottom:'10px',fontSize:'12px'}});
  const prodRowsArr=[];
  prodsSearchInp.addEventListener('input',e=>{const t=e.target.value.toLowerCase();prodRowsArr.forEach(r=>{r.style.display=(!t||r.dataset.s.includes(t))?'':'none';});});
  body.appendChild(prodsSearchInp);
  if(APP.prods.length===0){
    body.appendChild(h('div',{class:'empty'},h('div',{class:'ei'},'üì¶'),h('div',{class:'et'},'No products yet')));
  }
  APP.prods.forEach(prod=>{
    const row=h('div',{class:'irow'});
    row.dataset.s=((prod.name||'')+(prod.price||'')+(prod.description||'')).toLowerCase();
    prodRowsArr.push(row);
    const th=h('div',{class:'ithumb'});
    if(prod.images?.[0]){const img=document.createElement('img');img.src=prod.images[0];img.style.cssText='width:100%;height:100%;object-fit:cover';th.appendChild(img);}
    else th.textContent=prod.icon||'üì¶';
    row.appendChild(th);
    row.appendChild(h('div',{class:'iinfo'},
      h('div',{class:'iname'},prod.name),
      h('div',{class:'isub'},(prod.price_on_request?'POR':prod.price?'‚Çπ'+prod.price:'No price')+(prod.video?' üé¨':''))
    ));
    const delBtn=h('button',{class:'btn btn-danger btn-sm'},'üóë');
    delBtn.onclick=async()=>{
      if(delBtn.dataset.c==='1'){
        delBtn.textContent='‚Ä¶';delBtn.disabled=true;
        try{
          APP.prods=(APP.prods||[]).filter(x=>x.id!==prod.id);
          IDB.putAll('prods',APP.prods);notify('Deleted ‚úì');renderNow();
          DB.delProd(prod.id).then(()=>{DB.addAudit({id:uid(),event:'Product Deleted: '+prod.name,user_email:'admin',ip:APP.ip,logged_at:new Date().toISOString()});DB.getProds().then(f=>{if(f?.length>=0){APP.prods=f;IDB.putAll('prods',f);}}).catch(()=>{});}).catch(e=>{notify('Delete failed: '+e.message);DB.getProds().then(f=>{if(f)APP.prods=f;renderNow();}).catch(()=>{});});
        }catch(e){notify('Delete failed: '+e.message);delBtn.textContent='üóë';delBtn.disabled=false;delBtn.dataset.c='';}
      } else {
        delBtn.dataset.c='1';delBtn.textContent='Sure?';
        setTimeout(()=>{if(delBtn.dataset.c==='1'){delBtn.dataset.c='';delBtn.textContent='üóë';}},2500);
      }
    };
    row.appendChild(h('div',{class:'iacts'},
      h('button',{class:'btn btn-ol btn-sm',style:{marginTop:'0'},onClick:()=>{f.editProd={...prod,images:[...(prod.images||[])],category_ids:[...(prod.category_ids||[])]};renderNow();}},'‚úè'),
      delBtn
    ));
    body.appendChild(row);
  });
}

// ‚îÄ‚îÄ CHATS ‚îÄ‚îÄ

// ‚îÄ‚îÄ Search bar helper ‚îÄ‚îÄ
function mkSearch(placeholder, onInput){
  const inp=h('input',{class:'inp',placeholder:'üîç '+placeholder,style:{marginBottom:'12px',fontSize:'12px'}});
  inp.addEventListener('input',e=>onInput(e.target.value.toLowerCase().trim()));
  return inp;
}
function filterCards(term, cards, getSearchText){
  cards.forEach(card=>{ card.style.display=(!term||getSearchText(card).toLowerCase().includes(term))?'':'none'; });
}

function renderAdmChats(body){
  const f=_admForms;
  if(f.selChat!==null){renderAdmChatDetail(body,f.selChat);return;}

  // ‚îÄ‚îÄ DM Direct Message form ‚îÄ‚îÄ
  const dmCard=h('div',{class:'form-card',style:{marginBottom:'12px'}});
  dmCard.appendChild(h('div',{class:'form-title'},'‚úâ Message Any User Directly'));
  const dmIn=h('input',{class:'inp',type:'email',placeholder:'User email address',value:f.dmEmail||''});
  dmCard.appendChild(dmIn);
  dmCard.appendChild(h('button',{class:'btn btn-g',style:{marginTop:'10px'},onClick:()=>{const em=dmIn.value.trim();if(!em)return;f.selChat=em;admMarkRead(em);renderNow();}},'OPEN CHAT'));
  body.appendChild(dmCard);

  // ‚îÄ‚îÄ ALL emails from chats ‚îÄ‚îÄ
  const allEmails=[...new Set(APP.chats.map(m=>m.user_email).filter(Boolean))];
  const _admReadCache=LS.get(KEY_ADM_READ,{});
  const _isRead=(email)=>{const ts=_admReadCache[email]||0;const ums=APP.chats.filter(m=>m.user_email===email&&m.sender==='user');if(!ums.length)return true;return ts>=new Date(ums[ums.length-1].sent_at||0).getTime();};
  const unreadEmails=allEmails.filter(email=>!_isRead(email));
  const readEmails=allEmails.filter(email=>_isRead(email));

  // ‚îÄ‚îÄ Filter Tabs ‚îÄ‚îÄ
  const filterRow=h('div',{style:{display:'flex',gap:'8px',marginBottom:'14px'}});
  const filters=[
    {id:'all',   label:'All',    count:allEmails.length,   color:'var(--t2)'},
    {id:'unread',label:'Unread', count:unreadEmails.length,color:'#e05555'},
    {id:'read',  label:'Read',   count:readEmails.length,  color:'#3ecf7a'},
  ];
  filters.forEach(ft=>{
    const active=APP.chatFilter===ft.id;
    const tab=h('div',{
      style:{
        flex:'1',textAlign:'center',padding:'8px 4px',borderRadius:'var(--rsm)',cursor:'pointer',
        border:'1px solid '+(active?ft.color:'var(--glb)'),
        background:active?'rgba(212,175,55,0.08)':'transparent',
        transition:'all 0.2s'
      },
      onClick:()=>{APP.chatFilter=ft.id;renderNow();}
    },
      h('div',{style:{fontSize:'16px',fontWeight:'900',color:active?ft.color:'var(--t2)'}},String(ft.count)),
      h('div',{style:{fontSize:'9px',color:active?ft.color:'var(--t2)',letterSpacing:'1.5px',textTransform:'uppercase',marginTop:'2px'}},ft.label)
    );
    filterRow.appendChild(tab);
  });
  body.appendChild(filterRow);

  // ‚îÄ‚îÄ Choose which emails to show ‚îÄ‚îÄ
  let showEmails=allEmails;
  if(APP.chatFilter==='unread') showEmails=unreadEmails;
  if(APP.chatFilter==='read')   showEmails=readEmails;

  if(showEmails.length===0){
    const labels={'all':'No conversations yet','unread':'No unread messages üéâ','read':'No read conversations yet'};
    body.appendChild(h('div',{class:'empty'},
      h('div',{class:'ei'},APP.chatFilter==='unread'?'‚úÖ':'üí¨'),
      h('div',{class:'et'},labels[APP.chatFilter])
    ));
    return;
  }

  // ‚îÄ‚îÄ Refresh + Search ‚îÄ‚îÄ
  const refBtn=h('button',{class:'btn btn-ol',style:{marginBottom:'10px',fontSize:'11px'},
    onClick:async()=>{refBtn.textContent='‚Üª Loading‚Ä¶';refBtn.disabled=true;
      DB.getChats().then(ch=>{if(ch){APP.chats=ch;IDB.putAll('chats',ch.slice(-5000));}refBtn.textContent='‚Üª Refresh';refBtn.disabled=false;renderNow();}).catch(()=>{refBtn.textContent='‚Üª Refresh';refBtn.disabled=false;});
    }
  },'‚Ü∫ Refresh');
  body.appendChild(refBtn);
  const chatSearchRows=[];
  const chatSearch=h('input',{class:'inp',placeholder:'üîç Search by email or nickname‚Ä¶',style:{marginBottom:'10px',fontSize:'12px'}});
  chatSearch.addEventListener('input',e=>{const t=e.target.value.toLowerCase();chatSearchRows.forEach(r=>{r.style.display=(!t||r.dataset.s.includes(t))?'':'none';});});
  body.appendChild(chatSearch);

  // ‚îÄ‚îÄ Chat rows ‚îÄ‚îÄ
  showEmails.forEach(email=>{
    const msgs=APP.chats.filter(m=>m.user_email===email);
    const last=msgs[msgs.length-1];
    const locked=msgs.some(m=>m.locked&&m.sender==='user');
    const isUnread=!_isRead(email);
    const userMsgs=msgs.filter(m=>m.sender==='user');

    const row=h('div',{class:'clist-row',style:{position:'relative',borderLeft:isUnread?'3px solid #e05555':'3px solid transparent'}});
    row.dataset.s=(email+' '+(displayName(email)||'')).toLowerCase();
    chatSearchRows.push(row);
    row.onclick=()=>{f.selChat=email;admMarkRead(email);renderNow();};
    if(isUnread){
      const dot=h('div',{style:{position:'absolute',top:'10px',right:'10px',width:'8px',height:'8px',borderRadius:'50%',background:'#e05555'}});
      row.appendChild(dot);
    }
    row.appendChild(h('div',{class:'cav',style:{background:isUnread?'rgba(224,85,85,0.12)':'var(--gl)'}},isUnread?'üî¥':'üë§'));
    const info=h('div',{style:{flex:'1',minWidth:'0',paddingRight:'20px'}});
    const titleRow=h('div',{style:{fontSize:'12px',fontWeight:isUnread?'900':'700',color:'var(--t1)',display:'flex',alignItems:'center',gap:'7px',flexWrap:'wrap'}});
    const nick=displayName(email);
    if(nick!==email) titleRow.appendChild(h('span',{style:{fontWeight:'900',color:'var(--g)',fontSize:'13px'}},nick));
    titleRow.appendChild(h('span',{style:{wordBreak:'break-all',color:nick!==email?'var(--t2)':'var(--t1)',fontSize:nick!==email?'10px':'12px'}},email));
    titleRow.appendChild(locked?h('span',{class:'pill pill-r'},'LOCKED'):h('span',{class:'pill pill-g'},'OPEN'));
    if(isUnread)titleRow.appendChild(h('span',{class:'pill',style:{background:'rgba(224,85,85,0.15)',color:'#e05555',border:'1px solid rgba(224,85,85,0.3)'}},'NEW'));
    info.appendChild(titleRow);
    info.appendChild(h('div',{style:{fontSize:'11px',color:isUnread?'var(--t1)':'var(--t2)',marginTop:'3px',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis',fontWeight:isUnread?'600':'400'}},
      last?.msg_type==='voice'?'üéô Voice note':(last?.message||'No messages')
    ));
    const metaRow=h('div',{style:{fontSize:'9px',color:'var(--t2)',marginTop:'3px',display:'flex',gap:'8px'}});
    metaRow.appendChild(h('span',{},userMsgs.length+' user msgs'));
    metaRow.appendChild(h('span',{},msgs.length+' total'));
    if(last?.sent_at)metaRow.appendChild(h('span',{},new Date(last.sent_at).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true})));
    info.appendChild(metaRow);
    row.appendChild(info);
    body.appendChild(row);
  });
}

const _admChatState={text:'',recording:false,recSecs:0,recTimer:null,mediaRecorder:null,chunks:[],recBytes:0,audioCtx:null,analyser:null,stream:null,waveRaf:null,waveVals:new Array(20).fill(4)};

function renderAdmChatDetail(body,email){
  const f=_admForms;
  if(!admIsRead(email))admMarkRead(email);
  const backBtn=h('button',{class:'btn btn-ol btn-sm',style:{marginBottom:'12px',width:'auto',marginTop:'0'},onClick:()=>{f.selChat=null;renderNow();}},'‚Üê Back');
  body.appendChild(backBtn);
  const msgs=APP.chats.filter(m=>m.user_email===email);
  const locked=msgs.some(m=>m.locked&&m.sender==='user');
  const adminUnlocked=msgs.some(m=>m.admin_unlocked===true);
  const userMsgCount=msgs.filter(m=>m.sender==='user').length;
  // Show nickname header
  const nick=displayName(email);
  const chatHdr=h('div',{style:{marginBottom:'10px',padding:'8px 10px',background:'var(--glass)',borderRadius:'var(--rsm)',border:'1px solid var(--glb)'}});
  chatHdr.appendChild(h('div',{style:{fontSize:'13px',fontWeight:'700',color:'var(--g)'}},nick!==email?nick:'üë§ '+email));
  if(nick!==email)chatHdr.appendChild(h('div',{style:{fontSize:'10px',color:'var(--t2)'}},email));
  body.appendChild(chatHdr);
  // Always show lock/unlock controls ‚Äî admin can lock OR unlock anytime
  const lockRow=h('div',{style:{marginBottom:'10px',display:'flex',gap:'8px',flexWrap:'wrap',alignItems:'center'}});
  // Status badge
  const statusBadge=h('div',{style:{fontSize:'10px',padding:'4px 8px',borderRadius:'4px',background:adminUnlocked?'rgba(50,180,100,.15)':'rgba(176,48,48,.15)',color:adminUnlocked?'#4caf7d':'#e05555',border:'1px solid '+(adminUnlocked?'rgba(50,180,100,.3)':'rgba(176,48,48,.3)'),flexShrink:'0'}},adminUnlocked?'üü¢ UNLOCKED':'üî¥ LOCKED ('+userMsgCount+'/5 msgs)');
  lockRow.appendChild(statusBadge);
  if(adminUnlocked||!locked){
    // Show LOCK button
    lockRow.appendChild(h('button',{class:'btn btn-danger btn-sm',style:{marginTop:'0'},onClick:async e=>{
      const b=e.target;b.textContent='‚Ä¶';b.disabled=true;
      APP.chats=(APP.chats||[]).map(m=>m.user_email===email?{...m,locked:true,admin_unlocked:false}:m);
      notify('Chat locked ‚úì');renderNow();
      DB.lockChat(email).catch(()=>{notify('Lock failed');});
    }},'üîí Lock Chat'));
  }
  if(locked&&!adminUnlocked){
    // Show UNLOCK button
    lockRow.appendChild(h('button',{class:'btn btn-g btn-sm',style:{marginTop:'0'},onClick:async e=>{
      const b=e.target;b.textContent='‚Ä¶';b.disabled=true;
      APP.chats=(APP.chats||[]).map(m=>m.user_email===email?{...m,locked:false,admin_unlocked:true}:m);
      notify('Chat unlocked ‚úì');renderNow();
      DB.unlockChat(email).catch(()=>{notify('Unlock failed');});
    }},'üîì Unlock Chat'));
  }
  body.appendChild(lockRow);
  const msgsBox=h('div',{class:'adm-msgs',style:{background:'var(--c2)',border:'1px solid var(--glb)',borderRadius:'var(--rad)',padding:'12px',maxHeight:'360px',overflowY:'auto',marginBottom:'10px',display:'flex',flexDirection:'column',gap:'8px'}});
  // Virtual scroll ‚Äî only render last 60
  const AVWIN=60;
  const avStart=Math.max(0,msgs.length-AVWIN);
  if(avStart>0){
    const aLd=h('div',{style:{textAlign:'center',padding:'6px',fontSize:'11px',color:'var(--t2)',cursor:'pointer',borderBottom:'1px solid var(--glb)'}},
      '‚Üë '+avStart+' earlier messages');
    aLd.onclick=()=>{
      msgs.slice(0,avStart).reverse().forEach(m=>{
        const cm=_renderMsg(m,true);cm.style.alignSelf=m.sender==='admin'?'flex-end':'flex-start';
        msgsBox.insertBefore(cm,msgsBox.children[1]||null);
      });
      aLd.remove();
    };
    msgsBox.appendChild(aLd);
  }
  msgs.slice(avStart).forEach(m=>{
    const cm=_renderMsg(m,true); // isAdmin=true ‚Äî can delete any message
    // Admin view: user msgs LEFT, admin replies RIGHT
    cm.style.alignSelf=m.sender==='admin'?'flex-end':'flex-start';
    msgsBox.appendChild(cm);
  });
  requestAnimationFrame(()=>{msgsBox.scrollTop=msgsBox.scrollHeight;});
  msgsBox.classList.add('adm-msgs');
  body.appendChild(msgsBox);
  // ‚îÄ‚îÄ ADMIN REPLY BAR (text + voice, like user side) ‚îÄ‚îÄ
  const _admChat=_admChatState;
  const _admSendFlag={v:false};

  async function admStartRec(){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}});
      _admChat.chunks=[];_admChat.recSecs=0;_admChat.recBytes=0;_admChat.recording=true;_admChat.stream=stream;
      const mime=['audio/webm;codecs=opus','audio/ogg;codecs=opus','audio/webm','audio/mp4',''].find(m=>!m||MediaRecorder.isTypeSupported(m))||'';
      const mrOpts=mime?{mimeType:mime,audioBitsPerSecond:24000}:{audioBitsPerSecond:24000};
      const mr=new MediaRecorder(stream,mrOpts);
      _admChat.mediaRecorder=mr;
      const MAX_BYTES=2*1024*1024; // 2MB = safe for Supabase row limit
      mr.ondataavailable=e=>{
        if(e.data&&e.data.size>0){
          _admChat.chunks.push(e.data);
          _admChat.recBytes=(_admChat.recBytes||0)+e.data.size;
          if(_admChat.recBytes>=MAX_BYTES){notify('Max 2MB reached ‚Äî sending‚Ä¶');admSendVoice();}
        }
      };
      mr.onerror=()=>{admCancelRec();notify('Recording error');};
      mr.start(100); // 100ms timeslice ‚Äî instant stop
      // AudioContext for waveform
      try{
        _admChat.audioCtx=new AudioContext();
        const src=_admChat.audioCtx.createMediaStreamSource(stream);
        _admChat.analyser=_admChat.audioCtx.createAnalyser();
        _admChat.analyser.fftSize=32;
        src.connect(_admChat.analyser);
      }catch{}
      // Timer: seconds only
      _admChat.recTimer=setInterval(()=>{
        _admChat.recSecs++;
        const te=document.querySelector('.adm-rec-time');
        if(te)te.textContent=fmtSecs(_admChat.recSecs);
      },1000);
      // Waveform: rAF ‚Äî smooth, no jank
      function admWaveLoop(){
        if(!_admChat.recording)return;
        if(_admChat.analyser){
          const data=new Uint8Array(_admChat.analyser.frequencyBinCount);
          _admChat.analyser.getByteFrequencyData(data);
          const avg=data.reduce((a,b)=>a+b,0)/data.length;
          _admChat.waveVals=[..._admChat.waveVals.slice(1),Math.max(3,Math.min(32,avg/2.5))];
          const bars=document.querySelectorAll('.adm-rec-waves .rw-bar');
          _admChat.waveVals.forEach((v,i)=>{if(bars[i])bars[i].style.height=v+'px';});
        }
        _admChat.waveRaf=requestAnimationFrame(admWaveLoop);
      }
      admWaveLoop();
      renderAdmBar();
    }catch(e){notify('Microphone denied: '+e.message);}
  }

  function admCancelRec(){
    _admChat.recording=false; // stop waveLoop first
    if(_admChat.waveRaf)cancelAnimationFrame(_admChat.waveRaf);_admChat.waveRaf=null;
    if(_admChat.recTimer)clearInterval(_admChat.recTimer);_admChat.recTimer=null;
    try{if(_admChat.mediaRecorder&&_admChat.mediaRecorder.state!=='inactive')_admChat.mediaRecorder.stop();}catch{}
    try{_admChat.stream?.getTracks().forEach(t=>t.stop());}catch{}
    try{if(_admChat.audioCtx){_admChat.audioCtx.close();_admChat.audioCtx=null;}}catch{}
    _admChat.recSecs=0;_admChat.chunks=[];_admChat.recBytes=0;_admChat.stream=null;_admChat.mediaRecorder=null;_admChat.waveVals=new Array(20).fill(4);
    renderAdmBar();
  }

  async function admSendVoice(){
    if(!_admChat.chunks||!_admChat.chunks.length){admCancelRec();return;}
    // Stop everything immediately
    _admChat.recording=false;
    if(_admChat.waveRaf)cancelAnimationFrame(_admChat.waveRaf);_admChat.waveRaf=null;
    if(_admChat.recTimer)clearInterval(_admChat.recTimer);_admChat.recTimer=null;
    const dur=_admChat.recSecs;
    const mimeType=_admChat.mediaRecorder?.mimeType||'audio/webm';
    if(_admChat.mediaRecorder&&_admChat.mediaRecorder.state!=='inactive'){
      await new Promise(res=>{_admChat.mediaRecorder.onstop=res;_admChat.mediaRecorder.stop();});
    }
    try{_admChat.stream?.getTracks().forEach(t=>t.stop());}catch{}
    try{if(_admChat.audioCtx){_admChat.audioCtx.close();_admChat.audioCtx=null;}}catch{}
    const chunks=[..._admChat.chunks];
    _admChat.chunks=[];_admChat.recBytes=0;_admChat.mediaRecorder=null;_admChat.stream=null;_admChat.waveVals=new Array(20).fill(4);
    if(!chunks.length){renderAdmBar();return;}
    const blob=new Blob(chunks,{type:mimeType});
    const reader=new FileReader();
    reader.onload=async e=>{
      const voiceData=e.target.result;
      const _avid=uid();
      const msg={id:_avid,user_email:email,sender:'admin',message:'',msg_type:'voice',voice_data:voiceData,voice_duration:dur,sent_at:new Date().toISOString(),locked:false};
      _pendingMsgIds.add(_avid);
      APP.chats=[...(APP.chats||[]),msg];
      IDB.putAll('chats',APP.chats.slice(-50000));
      renderNow();
      requestAnimationFrame(()=>{const _mb=document.querySelector('.adm-msgs');if(_mb)_mb.scrollTop=_mb.scrollHeight;});
      DB.addChat(msg).catch(()=>{notify('Voice send failed');}).finally(()=>{setTimeout(()=>_pendingMsgIds.delete(_avid),5000);});
    };
    reader.readAsDataURL(blob);
  }

  const admBar=h('div',{class:'adm-reply-wrap',style:{marginTop:'10px'}});

  function renderAdmBar(){
    admBar.innerHTML='';
    if(_admChat.recording){
      // Recording state UI
      const recRow=h('div',{class:'rec-bar',style:{borderRadius:'var(--rad)',marginBottom:'8px'}});
      recRow.appendChild(h('div',{class:'rec-dot'}));
      recRow.appendChild(h('div',{class:'adm-rec-time rec-time'},fmtSecs(_admChat.recSecs)));
      const wv=h('div',{class:'adm-rec-waves rec-waves'});
      (_admChat.waveVals||[]).forEach(v=>{const b=document.createElement('div');b.className='rw-bar';b.style.height=(v||4)+'px';wv.appendChild(b);});
      recRow.appendChild(wv);
      recRow.appendChild(h('div',{class:'rec-cancel',style:{cursor:'pointer'},onClick:admCancelRec},'‚úï'));
      recRow.appendChild(h('div',{class:'rec-ok',style:{cursor:'pointer'},onClick:admSendVoice},'‚úì'));
      admBar.appendChild(recRow);
    } else {
      // Normal text+mic bar
      const ta=h('textarea',{class:'ta',placeholder:'Type admin reply‚Ä¶',rows:'2',style:{marginBottom:'8px'}});
      ta.value=f.replyTxt||'';
      ta.addEventListener('input',e=>{f.replyTxt=e.target.value;
        sendTxtBtn.style.display=e.target.value.trim()?'block':'none';
        micBtn2.style.display=e.target.value.trim()?'none':'block';
      });
      const btnRow=h('div',{style:{display:'flex',gap:'8px'}});
      const sendTxtBtn=h('button',{class:'btn btn-g',style:{flex:'1',borderRadius:'22px',fontSize:'12px'}},'‚û§ SEND REPLY');
      const micBtn2=h('button',{class:'btn btn-ol',style:{minWidth:'52px',fontSize:'20px'}},'üéô');
      sendTxtBtn.onclick=async()=>{
        if(_admSendFlag.v)return;
        const text=ta.value.trim();if(!text)return;
        _admSendFlag.v=true;sendTxtBtn.disabled=true;sendTxtBtn.textContent='Sent ‚úì';
        setTimeout(()=>{sendTxtBtn.textContent='‚û§ SEND REPLY';sendTxtBtn.disabled=false;_admSendFlag.v=false;},800);
        const _atid=uid();
        const msg={id:_atid,user_email:email,sender:'admin',message:text,msg_type:'text',sent_at:new Date().toISOString(),locked:false};
        _pendingMsgIds.add(_atid);
        APP.chats=[...(APP.chats||[]),msg];
        IDB.putAll('chats',APP.chats.slice(-50000));
        f.replyTxt='';ta.value='';
        renderNow();
        requestAnimationFrame(()=>{const _mb=document.querySelector('.adm-msgs');if(_mb)_mb.scrollTop=_mb.scrollHeight;});
        DB.addChat(msg).catch(e=>{notify('Send failed: '+e.message);}).finally(()=>{setTimeout(()=>_pendingMsgIds.delete(_atid),5000);});
      };
      micBtn2.onclick=admStartRec;
      // Initially hide send, show mic
      sendTxtBtn.style.display='none';
      admBar.appendChild(ta);
      btnRow.appendChild(sendTxtBtn);
      btnRow.appendChild(micBtn2);
      admBar.appendChild(btnRow);
    }
  }

  renderAdmBar();
  body.appendChild(admBar);
}

// ‚îÄ‚îÄ USERS (User Management) ‚îÄ‚îÄ
function renderAdmUsers(body){
  const users=APP.users||[];
  // Header + Refresh
  const hdrRow=h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 0 12px',borderBottom:'1px solid var(--glb)',marginBottom:'13px'}});
  hdrRow.appendChild(h('div',{},
    h('div',{style:{fontSize:'9px',color:'var(--g)',letterSpacing:'3px',fontWeight:'700',textTransform:'uppercase'}},'User Management'),
    h('div',{style:{fontSize:'10px',color:'var(--t2)',marginTop:'4px'}},users.length+' registered users')
  ));
  const refreshBtn=h('button',{class:'btn btn-ol',style:{fontSize:'11px',padding:'6px 12px'},onClick:async()=>{
    refreshBtn.textContent='‚Ä¶';refreshBtn.disabled=true;
    DB.getUsers().then(u=>{if(u){APP.users=u;IDB.putAll('users',u);}APP._userSearch='';renderNow();}).catch(()=>{renderNow();});
  }},'‚Ü∫ Refresh');
  hdrRow.appendChild(refreshBtn);
  body.appendChild(hdrRow);
  // Search bar
  const searchInp=h('input',{class:'inp',placeholder:'üîç Search by name, email or ID‚Ä¶',value:APP._userSearch||'',style:{marginBottom:'12px'}});
  searchInp.addEventListener('input',e=>{APP._userSearch=e.target.value;
    const term=(e.target.value||'').toLowerCase();
    const cards=body.querySelectorAll('.user-card');
    cards.forEach(card=>{
      const txt=card.dataset.search||'';
      card.style.display=txt.includes(term)?'':'none';
    });
  });
  body.appendChild(searchInp);
  if(users.length===0){
    body.appendChild(h('div',{style:{textAlign:'center',padding:'40px 0',color:'var(--t2)',fontStyle:'italic',fontSize:'13px'}},'No registered users yet. Users appear after they register in the app.'));
    return;
  }
  users.forEach(u=>{
    const searchStr=[(u.id||''),(u.name||''),(u.email||''),(u.firm||'')].join(' ').toLowerCase();
    // Get login records for this user
    const card=h('div',{class:'form-card user-card',style:{marginBottom:'10px',padding:'13px 14px'}});
    card.dataset.search=searchStr;
    const row1=h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'8px',gap:'8px'}});
    const leftInfo=h('div',{});
    leftInfo.appendChild(h('div',{style:{fontSize:'13px',fontWeight:'700',color:'var(--t1)'}},'üë§ '+(u.nickname||u.name||'‚Äî')));
    leftInfo.appendChild(h('div',{style:{fontSize:'10px',color:'var(--t2)',marginTop:'2px'}},'üè¢ '+(u.firm||'‚Äî')));
    row1.appendChild(leftInfo);
    row1.appendChild(h('div',{style:{textAlign:'right',flexShrink:'0'}},
      h('div',{style:{fontSize:'9px',color:'var(--g)'}},u.registered_at?new Date(u.registered_at).toLocaleDateString('en-IN'):'‚Äî')
    ));
    card.appendChild(row1);
    const details=[
      ['üÜî ID',(u.id||'‚Äî').slice(0,16)+'‚Ä¶'],
      ['üìß Email',u.email||'‚Äî'],
      ['üìû Mobile',u.mobile||'‚Äî'],
      ['üåê IP',u.ip||'‚Äî'],
    ];
    details.forEach(([lbl,val])=>{
      card.appendChild(h('div',{style:{display:'flex',gap:'8px',padding:'4px 0',borderBottom:'1px solid rgba(255,255,255,.04)',alignItems:'center'}},
        h('div',{style:{fontSize:'9px',color:'var(--t2)',width:'70px',flexShrink:'0'}},''+lbl),
        h('div',{style:{fontSize:'11px',color:'var(--t1)',fontFamily:'monospace',wordBreak:'break-all'}},val)
      ));
    });
    // Nickname editor ‚Äî full width, clearly visible
    card.appendChild(h('div',{style:{marginTop:'10px',paddingTop:'8px',borderTop:'1px solid rgba(255,255,255,.08)'}},''));
    card.appendChild(h('div',{style:{fontSize:'9px',color:'var(--t2)',letterSpacing:'1px',marginBottom:'6px'}},'üè∑ NICKNAME'));
    const nickInp=h('input',{class:'inp',type:'text',placeholder:'Enter a nickname for this user‚Ä¶',value:u.nickname||'',style:{width:'100%',fontSize:'14px',padding:'10px 12px',margin:'0 0 8px 0',color:'var(--t1)',background:'var(--c2)',border:'1px solid var(--glb)',borderRadius:'var(--rsm)',boxSizing:'border-box'}});
    const nickSave=h('button',{class:'btn btn-g',style:{width:'100%',fontSize:'13px',padding:'10px',margin:'0'}},'üíæ SAVE NICKNAME');
    nickSave.onclick=async()=>{
      const nick=nickInp.value.trim();
      nickSave.disabled=false;nickSave.textContent='‚úì Saved';setTimeout(()=>{nickSave.textContent='üíæ SAVE NICKNAME';},1500);
      // Optimistic update
      APP.users=(APP.users||[]).map(x=>x.email===u.email?{...x,nickname:nick}:x);
      IDB.putAll('users',APP.users);
      DB.saveNickname(u.email,nick).then(()=>{
        DB.getUsers().then(fresh=>{if(fresh?.length){APP.users=fresh;IDB.putAll('users',fresh);}}).catch(()=>{});
      }).catch(()=>{notify('Nickname save failed');});
      notify(nick?'‚úì Nickname set: '+nick:'Nickname cleared');renderNow();
    };
    card.appendChild(nickInp);
    card.appendChild(nickSave);
    const delBtn=h('button',{class:'btn btn-danger btn-sm',style:{marginTop:'10px',width:'100%'},onClick:async e=>{
      const b=e.target;
      if(b.dataset.c==='1'){
        b.textContent='Deleting‚Ä¶';b.disabled=true;
        try{
          APP.users=(APP.users||[]).filter(x=>x.id!==u.id);
          IDB.putAll('users',APP.users);
          notify('User deleted ‚úì');renderNow();
          DB.delUser(u.id).then(()=>{DB.addAudit({id:uid(),event:'User Deleted: '+u.email,user_email:'admin',ip:APP.ip,logged_at:new Date().toISOString()});DB.getUsers().then(f=>{if(f?.length>=0){APP.users=f;IDB.putAll('users',f);}}).catch(()=>{});}).catch(e=>{notify('Delete failed: '+e.message);DB.getUsers().then(f=>{if(f)APP.users=f;renderNow();}).catch(()=>{});});
        }catch(e){notify('Delete failed: '+e.message);b.textContent='üóë Delete User';b.disabled=false;b.dataset.c='';}
      } else {
        b.dataset.c='1';b.textContent='‚ö† Tap again to confirm';
        setTimeout(()=>{if(b.dataset.c==='1'){b.dataset.c='';b.textContent='üóë Delete User';}},2500);
      }
    }},'üóë Delete User');
    card.appendChild(delBtn);
    body.appendChild(card);
  });
}

// ‚îÄ‚îÄ LOGS (User Data Tracking) ‚îÄ‚îÄ
function renderAdmLogs(body){
  const logs=APP.logs||[];
  // Header + Refresh
  const hdrRow=h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 0 12px',borderBottom:'1px solid var(--glb)',marginBottom:'13px'}});
  hdrRow.appendChild(h('div',{},
    h('div',{style:{fontSize:'9px',color:'var(--g)',letterSpacing:'3px',fontWeight:'700',textTransform:'uppercase'}},'User Login Logs'),
    h('div',{style:{fontSize:'10px',color:'var(--t2)',marginTop:'4px',lineHeight:'1.7'}},logs.length+' records captured')
  ));
  const refBtn=h('button',{class:'btn btn-ol',style:{fontSize:'11px',padding:'6px 12px'},onClick:async()=>{
    refBtn.textContent='‚Üª Loading‚Ä¶';refBtn.disabled=true;
    Promise.all([DB.getLogs(),DB.getAudit()]).then(([lg,au])=>{
      if(lg)APP.logs=lg; if(au)APP.audit=au;
      refBtn.disabled=false;refBtn.textContent='‚Ü∫ Refresh';renderNow();
    }).catch(()=>{refBtn.disabled=false;refBtn.textContent='‚Ü∫ Refresh';renderNow();});
  }},'‚Ü∫ Refresh');
  hdrRow.appendChild(refBtn);
  body.appendChild(hdrRow);
  if(logs.length===0){
    body.appendChild(h('div',{style:{textAlign:'center',padding:'40px 0',color:'var(--t2)',fontStyle:'italic',fontSize:'13px'}},'No user logs yet. Logs appear when users register or login.'));
    if(!APP.sbOn)body.appendChild(h('div',{style:{textAlign:'center',fontSize:'11px',color:'var(--g)'}},'Tip: Connect Supabase in DB tab to persist logs across sessions.'));
    return;
  }
  // Search
  const logRows=[];
  const logSearch=h('input',{class:'inp',placeholder:'üîç Search by name, email or IP‚Ä¶',style:{marginBottom:'10px',fontSize:'12px'}});
  logSearch.addEventListener('input',e=>{const t=e.target.value.toLowerCase();logRows.forEach(r=>{r.style.display=(!t||r.dataset.s.includes(t))?'':'none';});});
  body.appendChild(logSearch);
  logs.forEach(lg=>{
    const card=h('div',{class:'form-card',style:{marginBottom:'10px',padding:'13px 14px'}});
    card.dataset.s=((lg.user_name||'')+(lg.email||'')+(lg.ip||'')+(lg.firm||'')).toLowerCase();
    logRows.push(card);
    // Row 1: Name + Firm + Timestamp
    const row1=h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'8px',gap:'8px'}});
    row1.appendChild(h('div',{},
      h('div',{style:{fontSize:'13px',fontWeight:'700',color:'var(--t1)'}},'üë§ '+(lg.user_name||'‚Äî')),
      h('div',{style:{fontSize:'10px',color:'var(--t2)',marginTop:'2px'}},'üè¢ '+(lg.firm||'‚Äî'))
    ));
    row1.appendChild(h('div',{style:{fontSize:'9px',color:'var(--g)',textAlign:'right',flexShrink:'0'}},
      lg.logged_at?new Date(lg.logged_at).toLocaleString('en-IN',{timeZone:'Asia/Kolkata',hour12:true}):'‚Äî'
    ));
    card.appendChild(row1);
    // Row 2: Contact details table-style
    const details=[
      ['üìß Email', lg.email||'‚Äî'],
      ['üìû Mobile', lg.mobile||'‚Äî'],
      ['üîí Password', lg.pass_masked||'‚Äî'],
      ['üåê IP Address', lg.ip||'‚Äî'],
    ];
    details.forEach(([lbl,val])=>{
      card.appendChild(h('div',{style:{display:'flex',gap:'8px',padding:'4px 0',borderBottom:'1px solid rgba(255,255,255,.04)',alignItems:'center'}},
        h('div',{style:{fontSize:'9px',color:'var(--t2)',width:'90px',flexShrink:'0',letterSpacing:'0.5px'}},lbl),
        h('div',{style:{fontSize:'11px',color:'var(--t1)',fontFamily:'monospace',wordBreak:'break-all'}},val)
      ));
    });
    body.appendChild(card);
  });
}

// ‚îÄ‚îÄ ACTIVITY (User View History) ‚îÄ‚îÄ
function renderAdmActivity(body){
  const views=APP.views||[];
  // Refresh button at top
  const refRow=h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'13px',padding:'10px 0',borderBottom:'1px solid var(--glb)'}});
  refRow.appendChild(h('div',{},
    h('div',{style:{fontSize:'9px',color:'var(--g)',letterSpacing:'3px',fontWeight:'700',textTransform:'uppercase'}},'User Activity'),
    h('div',{style:{fontSize:'10px',color:'var(--t2)',marginTop:'4px'}},(APP.audit||[]).length+' admin actions logged')
  ));
  // Auto-load views + audit (throttled: max once per 30s to prevent render loop)
  const _now=Date.now();
  if(!APP._actLastLoad||_now-APP._actLastLoad>30000){
    APP._actLastLoad=_now;
    Promise.all([DB.getAllViews(),DB.getAudit()]).then(([v,a])=>{
      APP.views=v||[];APP.audit=a||[];renderNow();
    }).catch(()=>{});
  }
  const aRefBtn=h('button',{class:'btn btn-ol',style:{fontSize:'11px',padding:'6px 12px'},onClick:()=>{
    aRefBtn.textContent='‚Üª Loading‚Ä¶';aRefBtn.disabled=true;
    Promise.all([DB.getAllViews(),DB.getAudit()]).then(([v,a])=>{
      if(v?.length){APP.views=v;IDB.putAll('views',v.slice(-20000));}
      if(a?.length){APP.audit=a;IDB.putAll('audit',a.slice(-5000));}
      aRefBtn.disabled=false;aRefBtn.textContent='‚Ü∫ Refresh';renderNow();
    }).catch(()=>{aRefBtn.disabled=false;aRefBtn.textContent='‚Ü∫ Refresh';});
  }},'‚Ü∫ Refresh');
  refRow.appendChild(aRefBtn);
  body.appendChild(refRow);

  // Show recent audit log first
  const audit=APP.audit||[];
  if(audit.length>0){
    const auditCard=h('div',{class:'form-card',style:{marginBottom:'14px',padding:'12px 14px'}});
    auditCard.appendChild(h('div',{style:{fontSize:'9px',color:'var(--g)',letterSpacing:'2px',fontWeight:'700',marginBottom:'8px'}},'‚ö° RECENT ADMIN ACTIONS'));
    audit.slice(0,10).forEach(a=>{
      auditCard.appendChild(h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'5px 0',borderBottom:'1px solid rgba(255,255,255,.04)'}},
        h('div',{style:{fontSize:'11px',color:'var(--t1)'}},a.event||'‚Äî'),
        h('div',{style:{fontSize:'9px',color:'var(--t2)',flexShrink:'0',marginLeft:'8px'}},a.logged_at?new Date(a.logged_at).toLocaleString('en-IN',{timeZone:'Asia/Kolkata',hour12:true,month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî')
      ));
    });
    body.appendChild(auditCard);
  }
  // If drill-down is active, show that user's activity
  if(APP.activityUser){
    const email=APP.activityUser;
    const userViews=views.filter(v=>v.user_email===email).sort((a,b)=>(b.viewed_at||'').localeCompare(a.viewed_at||''));
    body.appendChild(h('div',{style:{display:'flex',alignItems:'center',gap:'10px',marginBottom:'14px',padding:'8px 0',borderBottom:'1px solid var(--glb)'}},
      h('button',{style:{background:'none',border:'1px solid var(--glb)',color:'var(--t2)',padding:'5px 10px',borderRadius:'var(--rsm)',cursor:'pointer',fontSize:'11px'},onClick:()=>{APP.activityUser=null;renderNow();}},'‚Üê Back'),
      h('div',{},
        h('div',{style:{fontSize:'13px',fontWeight:'700',color:'var(--t1)'}},email),
        h('div',{style:{fontSize:'9px',color:'var(--t2)',marginTop:'2px'}},userViews.length+' catalog views')
      )
    ));
    if(userViews.length===0){
      body.appendChild(h('div',{style:{textAlign:'center',padding:'30px',color:'var(--t2)',fontStyle:'italic'}},'No catalog activity for this user.'));
      return;
    }
    userViews.forEach(v=>{
      const prod=APP.prods.find(p=>p.id===v.prod_id);
      const img=(prod?.images||[])[0];
      const row=h('div',{style:{display:'flex',alignItems:'center',gap:'11px',padding:'10px 0',borderBottom:'1px solid var(--glb)',cursor:'pointer'},onClick:()=>{if(prod)openProduct(prod);}});
      const thumb=h('div',{style:{width:'44px',height:'44px',borderRadius:'6px',overflow:'hidden',border:'1px solid var(--glb)',background:'var(--c3)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'18px',flexShrink:'0'}},prod?.icon||'üì¶');
      if(img){thumb.innerHTML='';const im=document.createElement('img');im.src=img;im.style.cssText='width:100%;height:100%;object-fit:cover';thumb.appendChild(im);}
      row.appendChild(thumb);
      row.appendChild(h('div',{style:{flex:'1',minWidth:'0'}},
        h('div',{style:{fontSize:'12px',fontWeight:'700',color:'var(--t1)',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}},v.prod_name||'Unknown Product'),
        h('div',{style:{fontSize:'9px',color:'var(--t2)',marginTop:'2px'}},v.viewed_at?new Date(v.viewed_at).toLocaleString('en-IN',{timeZone:'Asia/Kolkata',hour12:true}):'‚Äî')
      ));
      body.appendChild(row);
    });
    return;
  }

  // Main activity list ‚Äî users sorted by most recent activity
  body.appendChild(h('div',{style:{padding:'0 0 12px',borderBottom:'1px solid var(--glb)',marginBottom:'13px'}},
    h('div',{style:{fontSize:'9px',color:'var(--g)',letterSpacing:'3px',fontWeight:'700',textTransform:'uppercase'}},'User Catalog Activity'),
    h('div',{style:{fontSize:'10px',color:'var(--t2)',marginTop:'4px'}},'Tap any user to see their product views.')
  ));
  if(views.length===0){
    body.appendChild(h('div',{style:{textAlign:'center',padding:'40px 0',color:'var(--t2)',fontStyle:'italic',fontSize:'13px'}},'No catalog activity recorded yet.'));
    return;
  }
  // Group by user, get last view time per user
  const userMap={};
  views.forEach(v=>{
    const e=v.user_email||'unknown';
    if(!userMap[e]||v.viewed_at>userMap[e].lastAt){
      userMap[e]={email:e,lastAt:v.viewed_at,count:(userMap[e]?.count||0)+1,lastProd:v.prod_name};
    } else {
      userMap[e].count=(userMap[e].count||0)+1;
    }
  });
  const userList=Object.values(userMap).sort((a,b)=>(b.lastAt||'').localeCompare(a.lastAt||''));
  // Search bar
  const actRows2=[];
  const actSrch=h('input',{class:'inp',placeholder:'üîç Search by email or nickname‚Ä¶',style:{marginBottom:'10px',fontSize:'12px'}});
  actSrch.addEventListener('input',e=>{const t=e.target.value.toLowerCase();actRows2.forEach(r=>{r.style.display=(!t||r.dataset.s.includes(t))?'':'none';});});
  if(userList.length>0)body.appendChild(actSrch);
  userList.forEach(u=>{
    const nick=displayName(u.email);
    const row=h('div',{class:'irow',style:{cursor:'pointer'},onClick:()=>{APP.activityUser=u.email;renderNow();}});
    row.dataset.s=(u.email+' '+nick).toLowerCase();
    actRows2.push(row);
    row.appendChild(h('div',{class:'ithumb',style:{fontSize:'18px'}},'üë§'));
    row.appendChild(h('div',{class:'iinfo'},
      h('div',{class:'iname'},nick!==u.email?nick+' ('+u.email+')':u.email),
      h('div',{class:'isub'},u.count+' views ¬∑ Last: '+(u.lastProd||'‚Äî').slice(0,28)+(u.lastProd?.length>28?'‚Ä¶':''))
    ));
    row.appendChild(h('div',{style:{textAlign:'right',flexShrink:'0'}},
      h('div',{style:{fontSize:'9px',color:'var(--g)',marginBottom:'3px'}},u.lastAt?new Date(u.lastAt).toLocaleDateString('en-IN'):'‚Äî'),
      h('div',{style:{fontSize:'8px',color:'var(--t2)'}},u.lastAt?new Date(u.lastAt).toLocaleTimeString('en-IN',{hour12:true}):'')
    ));
    body.appendChild(row);
  });
}

// ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ
function renderAdmNotifs(body){
  const f=_admForms;
  const card=h('div',{class:'form-card'});
  card.appendChild(h('div',{class:'form-title'},'üì¢ Send Notification'));
  const titleIn=h('input',{class:'inp',placeholder:'Notification title',value:f.newNotif.title||''});
  const msgTA=h('textarea',{class:'ta',placeholder:'Message body‚Ä¶'},f.newNotif.message||'');
  card.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Title'),titleIn));
  card.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Message'),msgTA));
  card.appendChild(h('button',{class:'btn btn-g',onClick:async()=>{
    const title=titleIn.value.trim();const msg=msgTA.value.trim();
    if(!title||!msg){notify('Title and message required');return;}
    try{
      const _nid=uid();const _notif={id:_nid,title,message:msg,created_at:new Date().toISOString()};
      // Optimistic add
      APP.notifs=[_notif,...(APP.notifs||[])];
      f.newNotif={title:'',message:''};notify('Notification sent ‚úì');renderNow();
      DB.addNotif(_notif).then(()=>{DB.getNotifs().then(fresh=>{if(fresh?.length){APP.notifs=fresh;}}).catch(()=>{});}).catch(()=>{notify('Notification failed');});
    }catch(e){notify('Send failed: '+e.message+' ‚Äî Check Supabase SQL schema (run DISABLE RLS commands)');}
  }},'SEND TO ALL USERS'));
  body.appendChild(card);
  // Search
  const notifRows=[];
  if(APP.notifs.length>0){
    const ns=h('input',{class:'inp',placeholder:'üîç Search notifications‚Ä¶',style:{marginBottom:'10px',fontSize:'12px'}});
    ns.addEventListener('input',e=>{const t=e.target.value.toLowerCase();notifRows.forEach(r=>{r.style.display=(!t||r.dataset.s.includes(t))?'':'none';});});
    body.appendChild(ns);
  }
  APP.notifs.forEach(n=>{
    const row=h('div',{class:'irow'});
    row.dataset.s=((n.title||'')+(n.message||'')).toLowerCase();
    notifRows.push(row);
    row.appendChild(h('div',{class:'ithumb',style:{fontSize:'20px'}},'üîî'));
    row.appendChild(h('div',{class:'iinfo'},h('div',{class:'iname'},n.title),h('div',{class:'isub'},n.message?.slice(0,50)+(n.message?.length>50?'‚Ä¶':''))));
    row.appendChild(h('button',{class:'btn btn-danger btn-sm',style:{marginTop:'0'},onClick:async e=>{
      const b=e.target;if(b.dataset.c==='1'){
        APP.notifs=(APP.notifs||[]).filter(x=>x.id!==n.id);
        renderNow();
        DB.delNotif(n.id).catch(err=>{notify('Failed: '+err.message);DB.getNotifs().then(fresh=>{if(fresh)APP.notifs=fresh;renderNow();}).catch(()=>{});});
      }
      else{b.dataset.c='1';b.textContent='Sure?';setTimeout(()=>{if(b.dataset.c==='1'){b.dataset.c='';b.textContent='üóë';}},2500);}
    }},'üóë'));
    body.appendChild(row);
  });
}

// ‚îÄ‚îÄ CLEANUP ‚îÄ‚îÄ
function renderAdmCleanup(body){
  const f=_admForms;
  const types=[
    {id:'chats',   label:'Chat Messages',     sub:'Including voice notes',               icon:'üí¨'},
    {id:'audit',   label:'Audit Logs',         sub:'Login & view events',                 icon:'üìã'},
    {id:'views',   label:'View History',       sub:'Product view tracking & activity',    icon:'üëÅ'},
    {id:'notifs',  label:'Notifications',      sub:'Broadcast notifications',             icon:'üì¢'},
    {id:'logs',    label:'Login Logs',         sub:'User registration & login records',   icon:'üìù'},
  ];
  const dateCard=h('div',{class:'form-card'});
  dateCard.appendChild(h('div',{class:'form-title'},'üìÖ Date Range'));
  const fromIn=h('input',{class:'inp',type:'date',value:f.clFrom});
  fromIn.addEventListener('change',e=>f.clFrom=e.target.value);
  const toIn=h('input',{class:'inp',type:'date',value:f.clTo});
  toIn.addEventListener('change',e=>f.clTo=e.target.value);
  dateCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'From (optional)'),fromIn));
  dateCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Delete Before *'),toIn));
  // Presets
  const presets=h('div',{style:{display:'flex',gap:'6px',flexWrap:'wrap',marginBottom:'8px'}});
  [{label:'30 days',days:30},{label:'3 months',days:90},{label:'6 months',days:180},{label:'1 year',days:365}].forEach(p=>{
    presets.appendChild(h('button',{class:'btn btn-ol btn-sm',style:{marginTop:'0'},onClick:()=>{const d=new Date();d.setDate(d.getDate()-p.days);f.clTo=d.toISOString().split('T')[0];renderNow();}},p.label));
  });
  dateCard.appendChild(presets);
  body.appendChild(dateCard);

  const typeCard=h('div',{class:'form-card'});
  typeCard.appendChild(h('div',{class:'form-title'},'üóë Select Data to Delete'));
  typeCard.appendChild(h('div',{style:{marginBottom:'8px'}},h('button',{class:'btn btn-ol btn-sm',style:{marginTop:'0'},onClick:()=>{f.clSel=f.clSel.length===types.length?[]:types.map(t=>t.id);renderNow();}},f.clSel.length===types.length?'Deselect All':'Select All')));
  types.forEach(t=>{
    const on=f.clSel.includes(t.id);
    typeCard.appendChild(h('div',{class:'cl-item',onClick:()=>{if(on)f.clSel=f.clSel.filter(id=>id!==t.id);else f.clSel=[...f.clSel,t.id];renderNow();}},
      h('div',{class:'cl-chk '+(on?'on':'')},on?'‚úì':''),
      h('div',{style:{flex:'1'}},h('div',{style:{fontSize:'12px',fontWeight:'700',color:'var(--t1)'}},t.icon+' '+t.label),h('div',{style:{fontSize:'9px',color:'var(--t2)',marginTop:'2px'}},t.sub))
    ));
  });
  body.appendChild(typeCard);

  if(f.clSel.length>0&&f.clTo){
    if(!f.clConfirm){
      body.appendChild(h('button',{class:'btn btn-danger',onClick:()=>{f.clConfirm=true;renderNow();}},'üóë DELETE SELECTED DATA'));
    } else if(!f.clRunning){
      const warn=h('div',{style:{background:'rgba(176,48,48,.12)',border:'1px solid rgba(176,48,48,.3)',borderRadius:'var(--rsm)',padding:'14px',marginBottom:'12px'}});
      warn.appendChild(h('div',{style:{fontSize:'12px',fontWeight:'700',color:'#e05555',marginBottom:'6px'}},'‚ö†Ô∏è CANNOT BE UNDONE'));
      warn.appendChild(h('div',{style:{fontSize:'11px',color:'var(--t2)',lineHeight:'1.7'}},
        'Deleting '+f.clSel.length+' type(s) of data before '+f.clTo+(APP.sbOn?' from Supabase':' from local storage')+'.'
      ));
      body.appendChild(warn);
      body.appendChild(h('button',{class:'btn btn-danger',onClick:async()=>runCleanup()},'‚ö° CONFIRM DELETE'));
      body.appendChild(h('button',{class:'btn btn-ol',onClick:()=>{f.clConfirm=false;renderNow();}},'Cancel'));
    } else {
      const prog=h('div',{class:'form-card'},h('div',{style:{fontSize:'12px',fontWeight:'700',color:'var(--t1)',marginBottom:'8px'}},'Deleting‚Ä¶'),h('div',{class:'prog-bar'},h('div',{class:'prog-fill',style:{width:f.clProg+'%'}})));
      body.appendChild(prog);
    }
  }
  if(f.clDone){
    body.appendChild(h('div',{style:{background:f.clDone.ok?'rgba(30,122,70,.15)':'rgba(176,48,48,.12)',border:'1px solid '+(f.clDone.ok?'rgba(30,122,70,.3)':'rgba(176,48,48,.3)'),borderRadius:'var(--rsm)',padding:'13px',marginBottom:'12px',fontSize:'12px',color:f.clDone.ok?'#3ecf7a':'#e05555',lineHeight:'1.7'}},f.clDone.msg));
  }
}

async function runCleanup(){
  const f=_admForms;
  f.clRunning=true;f.clProg=0;f.clDone=null;renderNow();
  const before=new Date(f.clTo+'T23:59:59').toISOString();
  const total=f.clSel.length;let done=0;
  try{
    for(const t of f.clSel){
      // Optimistic: clear local immediately, then sync DB
      if(t==='chats'){APP.chats=(APP.chats||[]).filter(m=>new Date(m.sent_at)>=before);IDB.putAll('chats',APP.chats.slice(-50000));DB.bulkDeleteChats(before).catch(()=>{});}
      if(t==='logs'){APP.logs=[];DB.bulkDeleteLogs(before).catch(()=>{});}
      if(t==='audit'){APP.audit=(APP.audit||[]).filter(a=>new Date(a.logged_at)>=before);IDB.putAll('audit',APP.audit.slice(-5000));DB.bulkDeleteAudit(before).catch(()=>{});}
      if(t==='notifs'){APP.notifs=[];DB.bulkDeleteNotifs(before).catch(()=>{});}
      if(t==='views'){APP.views=(APP.views||[]).filter(v=>new Date(v.viewed_at)>=before);IDB.putAll('views',APP.views.slice(-20000));DB.bulkDeleteViews(before).catch(()=>{});}
      done++;f.clProg=Math.round(done/total*100);renderNow();
    }
    const [newChats,newAudit,newNotifs,newViews]=await Promise.all([
      DB.getChats(),DB.getAudit(),DB.getNotifs(),DB.getAllViews()
    ]);
    APP.chats=newChats||[];APP.audit=newAudit||[];APP.notifs=newNotifs||[];APP.views=newViews||[];
    IDB.putAll('chats',APP.chats.slice(-50000));IDB.putAll('audit',APP.audit.slice(-5000));
    IDB.putAll('notifs',APP.notifs);IDB.putAll('views',APP.views.slice(-20000));
    f.clDone={ok:true,msg:'‚úì Cleanup complete! Deleted data before '+f.clTo+'.'};
  }catch(e){f.clDone={ok:false,msg:'Error: '+e.message};}
  f.clRunning=false;f.clConfirm=false;f.clProg=0;renderNow();
}

// ‚îÄ‚îÄ DB / SUPABASE CONFIG ‚îÄ‚îÄ
// ‚îÄ‚îÄ SECURITY SETTINGS ‚îÄ‚îÄ
function renderAdmSecurity(body){
  const creds=APP.adminCreds||{email:ADMIN_EMAIL,password:ADMIN_PASS};
  const source=APP.sbOn?'Supabase (admin_settings table)':'Local cache / hardcoded default';

  // ‚îÄ‚îÄ CURRENT CREDENTIALS DISPLAY ‚îÄ‚îÄ
  const statusCard=h('div',{class:'form-card'});
  statusCard.appendChild(h('div',{class:'form-title'},'üîê Current Admin Credentials'));
  statusCard.appendChild(h('div',{style:{background:'rgba(212,175,55,.06)',border:'1px solid var(--gb)',borderRadius:'var(--rsm)',padding:'13px 14px',marginBottom:'13px'}},
    h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.05)'}},
      h('div',{style:{fontSize:'9px',color:'var(--t2)',letterSpacing:'2px',textTransform:'uppercase'}},'Email'),
      h('div',{style:{fontSize:'12px',color:'var(--t1)',fontWeight:'700',fontFamily:'monospace'}},creds.email)
    ),
    h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'6px 0',borderBottom:'1px solid rgba(255,255,255,.05)'}},
      h('div',{style:{fontSize:'9px',color:'var(--t2)',letterSpacing:'2px',textTransform:'uppercase'}},'Password'),
      h('div',{style:{fontSize:'12px',color:'var(--t1)',fontWeight:'700',letterSpacing:'3px'}},'‚Ä¢'.repeat(Math.min(creds.password?.length||8,12)))
    ),
    h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'6px 0'}},
      h('div',{style:{fontSize:'9px',color:'var(--t2)',letterSpacing:'2px',textTransform:'uppercase'}},'Source'),
      h('div',{style:{fontSize:'10px',color:APP.sbOn?'#3ecf7a':'var(--g)',fontWeight:'700'}},APP.sbOn?'‚òÅ Supabase':'üì± Local')
    )
  ));
  statusCard.appendChild(h('div',{style:{fontSize:'10px',color:'var(--t2)',lineHeight:'1.7',padding:'4px 0'}},
    '‚ö° Changes save to ',h('strong',{style:{color:APP.sbOn?'#3ecf7a':'var(--g)'}},APP.sbOn?'Supabase + Local cache':'Local cache only'),'. ',
    !APP.sbOn?h('span',{style:{color:'#e05555'}},'Connect Supabase (DB tab) to persist credentials across devices and reinstalls.'):'Your changes sync to all admin devices instantly.'
  ));
  body.appendChild(statusCard);

  // ‚îÄ‚îÄ UPDATE FORM ‚îÄ‚îÄ
  const formCard=h('div',{class:'form-card'});
  formCard.appendChild(h('div',{class:'form-title'},'‚úè Update Admin Credentials'));

  let secErr='', secOk='';
  let showNewPass=false, showConfPass=false;

  const errDiv=h('div',{class:'err',style:{display:'none'}});
  const okDiv=h('div',{class:'ok-msg',style:{display:'none'}});

  // Email field
  const emailIn=h('input',{class:'inp',type:'email',placeholder:'New admin email',value:creds.email});
  emailIn.style.fontFamily='monospace';
  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Admin Email'),emailIn));

  // New password field
  const newPassWrap=h('div',{class:'inp-wrap'});
  const newPassIn=h('input',{class:'inp',type:'password',placeholder:'New password (leave blank to keep current)'});
  const newEye=h('button',{class:'inp-eye',onClick:()=>{showNewPass=!showNewPass;newPassIn.type=showNewPass?'text':'password';newEye.textContent=showNewPass?'üôà':'üëÅ';}},'üëÅ');
  newPassWrap.appendChild(newPassIn);newPassWrap.appendChild(newEye);
  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'New Password'),newPassWrap,h('div',{style:{fontSize:'9px',color:'var(--t2)',marginTop:'4px'}},'Leave blank to keep current password unchanged')));

  // Confirm password field
  const confPassWrap=h('div',{class:'inp-wrap'});
  const confPassIn=h('input',{class:'inp',type:'password',placeholder:'Confirm new password'});
  const confEye=h('button',{class:'inp-eye',onClick:()=>{showConfPass=!showConfPass;confPassIn.type=showConfPass?'text':'password';confEye.textContent=showConfPass?'üôà':'üëÅ';}},'üëÅ');
  confPassWrap.appendChild(confPassIn);confPassWrap.appendChild(confEye);
  formCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Confirm New Password'),confPassWrap));

  formCard.appendChild(errDiv);
  formCard.appendChild(okDiv);

  // Save button
  const saveBtn=h('button',{class:'btn btn-g',onClick:async()=>{
    const newEmail=emailIn.value.trim();
    const newPass=newPassIn.value;
    const confPass=confPassIn.value;

    // Validation
    if(!newEmail){showSecErr('Email cannot be empty.');return;}
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)){showSecErr('Enter a valid email address.');return;}
    if(newPass&&newPass.length<6){showSecErr('New password must be at least 6 characters.');return;}
    if(newPass&&newPass!==confPass){showSecErr('Passwords do not match. Please re-enter both fields.');return;}

    const finalPass=newPass||creds.password; // keep old pass if field left blank

    saveBtn.textContent='SAVING‚Ä¶';saveBtn.disabled=true;
    try{
      // Save in background ‚Äî no need to block UI
      APP.adminCreds={email:newEmail,password:finalPass};
      DB.saveAdminCreds(newEmail,finalPass).catch(()=>{notify('Save failed ‚Äî check connection');});
      // ‚îÄ‚îÄ SELF-CORRECTION: update in-memory state and local session immediately ‚îÄ‚îÄ
      APP.adminCreds={email:newEmail,password:finalPass};
      const sess=LS.get(KEY_SESSION);
      if(sess&&sess.role==='admin'){
        LS.set(KEY_SESSION,{...sess,user:{email:newEmail},ts:Date.now()});
      }
      showSecOk('‚úì Credentials updated successfully! You will not be logged out.');
      emailIn.value=newEmail;
      newPassIn.value='';confPassIn.value='';
      // Refresh the current credentials display
      APP.atab='security';renderNow();
    }catch(e){
      showSecErr('Save failed: '+e.message);
    }
    saveBtn.textContent='SAVE CREDENTIALS';saveBtn.disabled=false;
  }},'SAVE CREDENTIALS');

  function showSecErr(msg){errDiv.textContent='‚ö† '+msg;errDiv.style.display='block';okDiv.style.display='none';}
  function showSecOk(msg){okDiv.textContent=msg;okDiv.style.display='block';errDiv.style.display='none';}

  formCard.appendChild(saveBtn);
  body.appendChild(formCard);

  // ‚îÄ‚îÄ SETUP GUIDE (shown when Supabase not connected) ‚îÄ‚îÄ
  if(!APP.sbOn){
    const warningCard=h('div',{style:{background:'rgba(176,48,48,.1)',border:'1px solid rgba(176,48,48,.3)',borderRadius:'var(--rad)',padding:'15px',marginTop:'12px'}});
    warningCard.appendChild(h('div',{style:{fontSize:'12px',fontWeight:'700',color:'#e05555',marginBottom:'8px'}},'‚ö† Supabase Not Connected'));
    warningCard.appendChild(h('div',{style:{fontSize:'11px',color:'var(--t2)',lineHeight:'1.8'}},
      'Your credential update will only be saved to this device\'s local storage. ',
      h('strong',{style:{color:'var(--t1)'}},'If you uninstall the app or clear storage, credentials will reset to hardcoded defaults.'),
      h('br'),h('br'),
      'To permanently store credentials in Supabase so they work across all devices:',
      h('ol',{style:{paddingLeft:'18px',marginTop:'8px',fontSize:'11px',color:'var(--t2)',lineHeight:'2'}},
        h('li',{},'Go to the ',h('strong',{style:{color:'var(--g)'}},'DB tab'),' and connect Supabase'),
        h('li',{},'Run the SQL schema (includes the admin_settings table)'),
        h('li',{},'Come back here and save your credentials ‚Äî they\'ll sync to the cloud')
      )
    ));
    body.appendChild(warningCard);
  }

  // ‚îÄ‚îÄ SQL REFERENCE ‚îÄ‚îÄ
  const sqlCard=h('div',{class:'form-card',style:{marginTop:'12px'}});
  sqlCard.appendChild(h('div',{class:'form-title'},'üìã Supabase SQL Reference'));
  sqlCard.appendChild(h('div',{style:{fontSize:'10px',color:'var(--t2)',marginBottom:'8px',lineHeight:'1.7'}},'Run this in Supabase SQL Editor to create the admin table and set initial credentials:'));
  const sqlText=`-- Create admin_settings table\nCREATE TABLE IF NOT EXISTS admin_settings (\n  id text PRIMARY KEY DEFAULT 'main',\n  email text NOT NULL,\n  password text NOT NULL,\n  updated_at timestamptz DEFAULT now()\n);\n\n-- Seed initial admin credentials (run once)\nINSERT INTO admin_settings (id, email, password)\nVALUES ('main', 'smitbhatiya47@gmail.com', 'Smit_5643_@')\nON CONFLICT (id) DO NOTHING;`;
  sqlCard.appendChild(h('div',{class:'schema-box'},sqlText));
  sqlCard.appendChild(h('button',{class:'btn btn-ol',style:{marginTop:'8px'},onClick:()=>{
    navigator.clipboard?.writeText(sqlText).then(()=>notify('SQL copied!')).catch(()=>notify('Long-press text to copy'));
  }},'üìã COPY SQL'));
  body.appendChild(sqlCard);
}

function renderAdmDB(body){
  const f=_admForms;
  const cfg=LS.get(KEY_SB);
  if(!f.sbCfg.url&&cfg?.url)f.sbCfg={url:cfg.url,key:cfg.key||''};

  // Status banner
  const statusBanner=h('div',{style:{padding:'14px',borderRadius:'var(--rsm)',marginBottom:'14px',background:APP.sbOn?'rgba(30,122,70,.15)':'rgba(176,48,48,.08)',border:'1px solid '+(APP.sbOn?'rgba(30,122,70,.3)':'rgba(176,48,48,.25)')}});
  statusBanner.appendChild(h('div',{style:{fontSize:'14px',fontWeight:'700',color:APP.sbOn?'#3ecf7a':'#e05555',marginBottom:'5px'}},APP.sbOn?'‚òÅ Supabase Connected ‚Äî Cloud Active':'üì± Not Connected ‚Äî Using Local Storage'));
  statusBanner.appendChild(h('div',{style:{fontSize:'11px',color:'var(--t2)',lineHeight:'1.7'}},APP.sbOn?'All data syncs to Supabase cloud. Images and videos hosted on CDN.':'Data saves on this device only. Connect Supabase to sync across all devices.'));
  body.appendChild(statusBanner);

  // ‚îÄ‚îÄ RLS WARNING ‚Äî most common cause of categories/products not saving ‚îÄ‚îÄ
  const rlsWarn=h('div',{style:{padding:'13px 14px',borderRadius:'var(--rsm)',marginBottom:'14px',background:'rgba(212,175,55,.08)',border:'1px solid rgba(212,175,55,.25)'}});
  rlsWarn.appendChild(h('div',{style:{fontSize:'12px',fontWeight:'700',color:'var(--g)',marginBottom:'6px'}},'‚ö†Ô∏è If Categories/Products are not saving:'));
  rlsWarn.appendChild(h('div',{style:{fontSize:'11px',color:'var(--t2)',lineHeight:'1.9'}},
    '1. Go to ',h('strong',{style:{color:'var(--t1)'}},'Supabase ‚Üí SQL Editor'),h('br'),
    '2. Click ',h('strong',{style:{color:'var(--t1)'}},'New Query'),h('br'),
    '3. Paste the full SQL schema from below (copy button)',h('br'),
    '4. Click ',h('strong',{style:{color:'var(--t1)'}},'Run'),h('br'),
    '5. Come back here and press ',h('strong',{style:{color:'var(--g)'}},'Reconnect')
  ));
  body.appendChild(rlsWarn);

  // ‚îÄ‚îÄ EMAILJS SETUP CARD ‚îÄ‚îÄ
  const ejsCard=h('div',{class:'gc',style:{padding:'16px',marginBottom:'14px'}});
  ejsCard.appendChild(h('div',{style:{fontSize:'11px',fontWeight:'700',color:'var(--g)',letterSpacing:'2px',marginBottom:'12px'}},'üìß EMAIL VERIFICATION (EmailJS)'));
  ejsCard.appendChild(h('div',{style:{fontSize:'11px',color:'var(--t2)',lineHeight:'1.7',marginBottom:'12px'}},
    '1. Go to ',h('strong',{style:{color:'var(--t1)'}},'emailjs.com'),h('span',' ‚Üí Sign up free'),h('br'),
    '2. Add Email Service ‚Üí choose Gmail OR Brevo (300/day free)',h('br'),
    '   For Brevo: in EmailJS ‚Üí Email Services ‚Üí SMTP ‚Üí use smtp-relay.brevo.com',h('br'),
    '3. Create Template with variables: ',h('strong',{style:{color:'var(--t1)'}},'{{to_name}}, {{to_email}}, {{otp_code}}, {{app_name}}'),h('br'),
    '4. Copy your 3 keys and paste below'
  ));
  const ejsSvc=h('input',{class:'inp',placeholder:'Service ID  e.g. service_abc123',value:LS.get('ejs_svc')||''});
  const ejsTpl=h('input',{class:'inp',placeholder:'Template ID  e.g. template_xyz456',value:LS.get('ejs_tpl')||''});
  const ejsKey=h('input',{class:'inp',placeholder:'Public Key  e.g. user_xxxxxxxxx',value:LS.get('ejs_key')||''});
  ejsCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Service ID'),ejsSvc));
  ejsCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Template ID'),ejsTpl));
  ejsCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Public Key'),ejsKey));
  const ejsSaveBtn=h('button',{class:'btn btn-g',style:{marginTop:'8px'},onClick:()=>{
    LS.set('ejs_svc',ejsSvc.value.trim());
    LS.set('ejs_tpl',ejsTpl.value.trim());
    LS.set('ejs_key',ejsKey.value.trim());
    notify('‚úì EmailJS saved! Users will now receive real email OTPs.');
  }},'üíæ SAVE EMAIL SETTINGS');
  ejsCard.appendChild(ejsSaveBtn);
  if(LS.get('ejs_svc')){
    ejsCard.appendChild(h('div',{style:{fontSize:'11px',color:'#3ecf7a',marginTop:'8px',textAlign:'center'}},'‚úÖ EmailJS configured ‚Äî real OTPs will be sent'));
  } else {
    ejsCard.appendChild(h('div',{style:{fontSize:'11px',color:'var(--t2)',marginTop:'8px',textAlign:'center'}},'‚ö† Not configured ‚Äî OTP shown on screen (insecure)'));
  }
  body.appendChild(ejsCard);

  // Guide
  if(!APP.sbOn){
    const guide=h('div',{class:'form-card'});
    guide.appendChild(h('div',{class:'form-title'},'üìñ How to Get Your Keys'));
    [
      ['1','Go to','supabase.com','‚Äî sign up free ‚Üí New Project'],
      ['2','Wait ~2 min ‚Üí Go to','Settings ‚Üí API',''],
      ['3','Copy your','Project URL','(starts with https://)'],
      ['4','Copy the','anon public key','(long string starting with eyJ...)'],
      ['5','Paste both below ‚Üí','Test & Connect',''],
    ].forEach(([n,a,b,c])=>{
      guide.appendChild(h('div',{style:{display:'flex',gap:'10px',marginBottom:'9px',alignItems:'flex-start'}},
        h('div',{style:{width:'22px',height:'22px',borderRadius:'50%',background:'var(--gl)',border:'1px solid var(--gb)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'10px',fontWeight:'700',color:'var(--g)',flexShrink:'0'}},n),
        h('div',{style:{fontSize:'11px',color:'var(--t2)',lineHeight:'1.7',paddingTop:'2px'}},a,' ',h('strong',{style:{color:'var(--t1)'}},b),' ',c)
      ));
    });
    body.appendChild(guide);
  }

  // Connection form
  const connCard=h('div',{class:'form-card'});
  connCard.appendChild(h('div',{class:'form-title'},APP.sbOn?'üîó Connected Database':'üîå Connect Supabase'));
  if(f.sbErr)connCard.appendChild(h('div',{class:'err'},f.sbErr));
  const urlIn=h('input',{class:'inp',placeholder:'https://xxxxx.supabase.co',value:f.sbCfg.url||''});
  urlIn.style.fontFamily='monospace';urlIn.style.fontSize='12px';
  urlIn.addEventListener('input',e=>f.sbCfg.url=e.target.value);

  // Anon key (for reads + user actions)
  let showKey=false;
  const keyWrap=h('div',{class:'inp-wrap'});
  const keyIn=h('input',{class:'inp',type:'password',placeholder:'eyJhbGciOiJIUzI1NiIs...',value:f.sbCfg.key||''});
  keyIn.style.fontFamily='monospace';keyIn.style.fontSize='11px';
  keyIn.addEventListener('input',e=>f.sbCfg.key=e.target.value);
  const eyeBtn=h('button',{class:'inp-eye',onClick:()=>{showKey=!showKey;keyIn.type=showKey?'text':'password';eyeBtn.textContent=showKey?'üôà':'üëÅ';}},'üëÅ');
  keyWrap.appendChild(keyIn);keyWrap.appendChild(eyeBtn);

  // Service role key (for admin writes only ‚Äî never exposed to users)
  const savedSvc=LS.get(KEY_SB_SVC);
  if(!f.sbSvcKey&&savedSvc?.key)f.sbSvcKey=savedSvc.key;
  let showSvc=false;
  const svcWrap=h('div',{class:'inp-wrap'});
  const svcIn=h('input',{class:'inp',type:'password',placeholder:'eyJhbGciOiJIUzI1NiIs... (service_role)',value:f.sbSvcKey||''});
  svcIn.style.fontFamily='monospace';svcIn.style.fontSize='11px';
  svcIn.addEventListener('input',e=>f.sbSvcKey=e.target.value);
  const svcEye=h('button',{class:'inp-eye',onClick:()=>{showSvc=!showSvc;svcIn.type=showSvc?'text':'password';svcEye.textContent=showSvc?'üôà':'üëÅ';}},'üëÅ');
  svcWrap.appendChild(svcIn);svcWrap.appendChild(svcEye);

  connCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Project URL'),urlIn,h('div',{style:{fontSize:'9px',color:'var(--t2)',marginTop:'4px'}},'Supabase ‚Üí Settings ‚Üí API ‚Üí Project URL')));
  connCard.appendChild(h('div',{class:'ig'},h('label',{class:'il'},'Anon / Public Key'),keyWrap,h('div',{style:{fontSize:'9px',color:'var(--t2)',marginTop:'4px'}},'Supabase ‚Üí Settings ‚Üí API ‚Üí anon public key (for users)')));
  connCard.appendChild(h('div',{class:'ig'},
    h('label',{class:'il'},'Service Role Key üîê'),
    svcWrap,
    h('div',{style:{fontSize:'9px',color:'var(--g)',marginTop:'4px',lineHeight:'1.6'}},'Supabase ‚Üí Settings ‚Üí API ‚Üí service_role key. Used ONLY for admin writes (add/delete products, categories). Never visible to users.')
  ));

  const testBtn=h('button',{class:'btn btn-g',onClick:async()=>{
    const url=urlIn.value.trim(); const key=keyIn.value.trim();
    if(!url||!key){f.sbErr='Both URL and key are required.';renderNow();return;}
    if(!url.includes('supabase.co')){f.sbErr='URL must be a Supabase project URL';renderNow();return;}
    f.sbErr='';testBtn.textContent='TESTING‚Ä¶';testBtn.disabled=true;
    try{
      const sb=new SB(url,key);
      // Step 1: read test
      await sb.sel('sms_categories');
      // Step 2: WRITE test ‚Äî this catches RLS blocking
      // Write test uses service role key if available, otherwise skip write test
      if(f.sbSvcKey&&f.sbSvcKey.trim()){
        const sbSvc=new SB(url,f.sbSvcKey.trim());
        const tid='_conn_test_'+Date.now();
        try{
          await sbSvc.ups('sms_categories',{id:tid,name:'__conntest__',sort_order:0});
          await sbSvc.del('sms_categories',tid);
        }catch(we){
          f.sbErr='‚ö†Ô∏è Service Role Key test failed: '+we.message+'. Please check your service_role key is correct.';
          testBtn.textContent='‚ö° TEST & CONNECT';testBtn.disabled=false;renderNow();return;
        }
      }
      _sb=sb;f.sbCfg={url,key};LS.set(KEY_SB,{url,key});APP.sbOn=true;
      // Save & activate service role key if provided
      if(f.sbSvcKey&&f.sbSvcKey.trim()){
        try{
          _sbAdmin=new SB(url,f.sbSvcKey.trim());
          LS.set(KEY_SB_SVC,{url,key:f.sbSvcKey.trim()});
        }catch(e){_sbAdmin=null;}
      }
      // Load in background ‚Äî navigate immediately
      loadAllAdmin().catch(()=>{});
      APP.adminCreds=await DB.getAdminCreds();
      const svcMsg=_sbAdmin?' + Service Role Key active (admin writes secured üîê)':'';
      notify('‚úì Connected!'+svcMsg);renderNow();
    }catch(e){f.sbErr='Connection failed: '+e.message;testBtn.textContent='‚ö° TEST & CONNECT';testBtn.disabled=false;renderNow();}
  }},APP.sbOn?'‚Ü∫ RECONNECT / UPDATE':'‚ö° TEST & CONNECT');
  connCard.appendChild(testBtn);
  if(APP.sbOn){
    connCard.appendChild(h('button',{class:'btn btn-danger',style:{marginTop:'8px'},onClick:()=>{RT.reset&&RT.reset();_rtSubsStarted=false;_sb=null;_sbAdmin=null;LS.del(KEY_SB);LS.del(KEY_SB_SVC);APP.sbOn=false;f.sbCfg={url:'',key:''};f.sbSvcKey='';notify('Disconnected from Supabase');renderNow();}},'DISCONNECT SUPABASE'));
  }
  body.appendChild(connCard);

  // SQL Schema
  const schemaCard=h('div',{class:'form-card'});
  schemaCard.appendChild(h('div',{class:'form-title'},'SQL Schema ‚Äî Run First in Supabase SQL Editor'));
  schemaCard.appendChild(h('div',{style:{fontSize:'10px',color:'var(--t2)',marginBottom:'9px',lineHeight:'1.7'}},
    'In Supabase ‚Üí ',h('strong',{style:{color:'var(--t1)'}},'SQL Editor'),' ‚Üí New query ‚Üí paste ‚Üí Run. Also create a Storage bucket named ',h('strong',{style:{color:'var(--g)'}},'sms-images'),' and make it ',h('strong',{style:{color:'var(--t1)'}},'Public'),'.'
  ));
  schemaCard.appendChild(h('div',{class:'schema-box'},SCHEMA));
  schemaCard.appendChild(h('button',{class:'btn btn-ol',style:{marginTop:'0'},onClick:()=>{
    navigator.clipboard?.writeText(SCHEMA).then(()=>notify('SQL copied!')).catch(()=>notify('Long-press the schema text to copy'));
  }},'üìã COPY SQL SCHEMA'));
  body.appendChild(schemaCard);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOTSTRAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function boot(){
  renderNow(); // show loader
  // Load Supabase config
  const cfg=LS.get(KEY_SB);
  if(cfg?.url&&cfg?.key){
    try{_sb=new SB(cfg.url,cfg.key);APP.sbOn=true;}catch(e){APP.sbOn=false;}
  }
  // Load service role key for admin writes
  const svcCfg=LS.get(KEY_SB_SVC);
  if(svcCfg?.url&&svcCfg?.key&&_sb){
    try{_sbAdmin=new SB(svcCfg.url,svcCfg.key);}catch(e){_sbAdmin=null;}
  }
  // Get IP (silent)
  try{const r=await fetch('https://api.ipify.org?format=json');APP.ip=(await r.json()).ip;}catch{}
  // Pre-cache admin creds non-blocking (so sign-in is instant)
  DB.getAdminCreds().then(cr=>{if(cr?.email)APP.adminCreds=cr;}).catch(()=>{});
  // Check session
  const sess=LS.get(KEY_SESSION);
  if(sess?.role){
    if(sess.role==='admin'){APP.role='admin';
      // Phase 1: IDB cache ‚Äî instant start
      const [_bac,_bap,_bach,_ban,_bau]=await Promise.all([
        IDB.getAll('cats'),IDB.getAll('prods'),IDB.getAll('chats'),
        IDB.getAll('notifs'),IDB.getAll('users')
      ]);
      APP.cats=_bac;APP.prods=_bap;
      APP.chats=_bach.sort((a,b)=>(a.sent_at||'').localeCompare(b.sent_at||''));
      APP.notifs=_ban;APP.users=_bau;
      APP.screen='admin';
      // Phase 2: background network sync
      loadAllAdmin().catch(()=>{});
    } else if(sess.role==='user'&&sess.user){APP.role='user';
      APP.user=sess.user;
      // Phase 1: IDB cache for instant start
      const [_bc,_bp,_bn]=await Promise.all([IDB.getAll('cats'),IDB.getAll('prods'),IDB.getAll('notifs')]);
      if(_bc.length){APP.cats=_bc;APP.prods=_bp;APP.notifs=_bn;}
      const _bch=await IDB.getAll('chats');
      const _bmch=_bch.filter(m=>m.user_email===sess.user.email);
      if(_bmch.length)APP.chats=_bmch.sort((a,b)=>(a.sent_at||'').localeCompare(b.sent_at||''));
      APP.screen='user';
      // Phase 2: background network sync
      loadAllUser().then(()=>{
        const _sU=(APP.users||[]).find(x=>x.email===sess.user.email);
        if(_sU){APP.user={...sess.user,name:_sU.name||sess.user.name,ferm:_sU.firm||sess.user.ferm||'',mob:_sU.mobile||sess.user.mob||''};}
      }).catch(()=>{});
    } else {
      APP.screen='splash';
    }
  } else {
    APP.screen='splash';
  }
  // Request persistent 100MB storage
  requestStorageQuota();
  startOfflineQueueProcessor();
  // Pre-warm all screens into memory so tab switches are instant
  setTimeout(()=>{
    try{
      const _pw=document.createElement('div');
      _pw.style.cssText='position:absolute;left:-9999px;visibility:hidden;pointer-events:none';
      document.body.appendChild(_pw);
      // Pre-render each screen into a detached node ‚Äî warms up JS parse+layout
      if(APP.role==='user'){
        ['home','enquire','alerts','profile'].forEach(tab=>{
          try{const _t=APP.tab;APP.tab=tab;_pw.innerHTML='';_pw.appendChild(render(true));APP.tab=_t;}catch{}
        });
      }
      document.body.removeChild(_pw);
    }catch{}
  }, 2000); // 2s after boot ‚Äî doesn't block startup
  schedulePrefetch(8000);
  renderNow();
}

boot();

// Reconnect WebSocket when app comes back to foreground
document.addEventListener('visibilitychange',()=>{
  if(document.visibilityState==='visible'){
    if(_sb&&!RT.isConnected()){
      RT.init(_sb.base,_sb.h.apikey);
    }
    // Refresh chat data if been away > 30s
    if(APP.screen==='admin'&&APP.atab==='chats'&&_sb){
      DB.getChats().then(ch=>{
        if(!ch?.length)return;
        const ids=new Set((APP.chats||[]).map(m=>m.id));
        const fresh=ch.filter(m=>!ids.has(m.id));
        if(fresh.length){
          APP.chats=[...(APP.chats||[]),...fresh].sort((a,b)=>(a.sent_at||'').localeCompare(b.sent_at||''));
          renderNow();
        }
      }).catch(()=>{});
    } else if(APP.screen==='user'&&APP.tab==='enquire'&&APP.user?.email&&_sb){
      _sb.sel('sms_chats','user_email=eq.'+encodeURIComponent(APP.user.email),'sent_at.asc').then(ch=>{
        if(!ch?.length)return;
        const ids=new Set((APP.chats||[]).map(m=>m.id));
        const fresh=ch.filter(m=>!ids.has(m.id));
        if(fresh.length){APP.chats=[...(APP.chats||[]),...fresh];renderNow();}
      }).catch(()=>{});
    }
  }
});
</script>
</body>
</html>
